<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®è¡¨æ ¼å¯¹æ¯”åˆ†æå·¥å…·</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- SheetJS - Excelæ–‡ä»¶å¤„ç†åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- å¤‡ç”¨CDN -->
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- ç»Ÿä¸€çš„ Tailwind é…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',      // æ·±è“ä¸»è‰²
                        secondary: '#7c3aed',    // ç§‘æŠ€æ„Ÿç´«è‰²
                        accent: '#06b6d4',       // äº®é’è‰²
                        neutral: '#f1f5f9',      // æµ…ç°èƒŒæ™¯
                        'diff-increase': '#ef4444', // å¢åŠ å·®å¼‚è‰²
                        'diff-decrease': '#22c55e', // å‡å°‘å·®å¼‚è‰²
                        'diff-change': '#eab308',  // å˜åŒ–å·®å¼‚è‰²
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'neon': '0 0 5px theme("colors.accent"), 0 0 20px theme("colors.accent")',
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.37)',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .glass-effect {
                @apply bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg;
            }
            .tech-button {
                @apply relative overflow-hidden rounded-lg bg-gradient-to-r from-primary to-secondary text-white font-medium py-2 px-4 transition-all duration-300 transform hover:scale-105 hover:shadow-neon focus:outline-none focus:ring-2 focus:ring-accent;
            }
            .tech-button::before {
                content: '';
                @apply absolute top-0 left-0 w-full h-full bg-gradient-to-r from-accent to-secondary opacity-0 transition-opacity duration-300;
            }
            .tech-button:hover::before {
                @apply opacity-20;
            }
            .table-header {
                @apply sticky top-0 z-10 bg-primary text-white font-semibold;
            }
            .diff-cell {
                @apply relative overflow-hidden;
            }
            .diff-cell::after {
                content: '';
                @apply absolute bottom-0 left-0 h-1 bg-accent transition-all duration-300 transform scale-x-0;
            }
            .diff-cell:hover::after {
                @apply scale-x-100;
            }
            .scrollbar-thin {
                scrollbar-width: thin;
                scrollbar-color: theme('colors.secondary') theme('colors.neutral');
            }
            .scrollbar-thin::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            .scrollbar-thin::-webkit-scrollbar-track {
                @apply bg-neutral;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                @apply bg-secondary rounded-full;
            }
            .data-card {
                @apply glass-effect border border-white border-opacity-20 rounded-xl shadow-glass transition-all duration-300 hover:shadow-lg;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-primary to-secondary min-h-screen text-gray-800 font-sans">
    <div class="container mx-auto px-4 py-8">
        <!-- é¡¶éƒ¨æ ‡é¢˜å’Œæ§åˆ¶åŒº -->
        <header class="mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-4 md:mb-0 flex items-center">
                    <i class="fa fa-table mr-3 text-accent"></i>
                    æ•°æ®è¡¨æ ¼å¯¹æ¯”åˆ†æå·¥å…·
                </h1>
                <div class="flex flex-wrap gap-3">
                    <button id="compareTables" class="tech-button bg-accent text-primary">
                        <i class="fa fa-exchange mr-2"></i>å¯¹æ¯”æ•°æ®
                    </button>
                    <button id="exportResults" class="tech-button">
                        <i class="fa fa-download mr-2"></i>å¯¼å‡ºç»“æœ
                    </button>
                </div>
            </div>
            
            <!-- å¯¹æ¯”è®¾ç½®é¢æ¿ -->
            <div class="data-card p-4 mb-6">
                <h2 class="text-xl font-semibold text-white mb-4">å¯¹æ¯”è®¾ç½®</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-white text-sm mb-2">ä¸»é”®åˆ—</label>
                        <select id="primaryKey" class="w-full rounded-lg border border-gray-300 bg-white bg-opacity-80 p-2 focus:outline-none focus:ring-2 focus:ring-accent">
                            <option value="">è‡ªåŠ¨æ£€æµ‹</option>
                            <option value="id">ID</option>
                            <option value="name">åç§°</option>
                            <option value="code">ä»£ç </option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-white text-sm mb-2">å¯¹æ¯”æ¨¡å¼</label>
                        <select id="compareMode" class="w-full rounded-lg border border-gray-300 bg-white bg-opacity-80 p-2 focus:outline-none focus:ring-2 focus:ring-accent">
                            <option value="all">æ‰€æœ‰åˆ—</option>
                            <option value="selected">é€‰å®šåˆ—</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-white text-sm mb-2">å·®å¼‚é«˜äº®æ–¹å¼</label>
                        <select id="highlightMode" class="w-full rounded-lg border border-gray-300 bg-white bg-opacity-80 p-2 focus:outline-none focus:ring-2 focus:ring-accent">
                            <option value="background">èƒŒæ™¯è‰²</option>
                            <option value="text">æ–‡å­—é¢œè‰²</option>
                            <option value="border">è¾¹æ¡†</option>
                        </select>
                    </div>
                </div>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºï¼šè¡¨æ ¼å¯¹æ¯”å’Œå·®å¼‚åˆ†æ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦ä¾§è¡¨æ ¼ -->
            <div class="lg:col-span-1 data-card p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">è¡¨æ ¼ A</h2>
                    <div class="flex gap-2">
                        <input type="file" id="fileInputA" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleFileUpload(event, 'A')">
                        <button id="importTableA" class="tech-button py-1 px-3 text-sm" onclick="document.getElementById('fileInputA').click()">
                            <i class="fa fa-upload mr-1"></i>å¯¼å…¥æ–‡ä»¶
                        </button>
                        <button id="loadSampleA" class="tech-button py-1 px-3 text-sm bg-gray-700 hover:bg-gray-600" onclick="loadSampleData('A')">
                            <i class="fa fa-database mr-1"></i>ç¤ºä¾‹æ•°æ®
                        </button>
                    </div>
                </div>
                <div class="relative overflow-x-auto scrollbar-thin max-h-[500px]">
                    <table id="tableA" class="w-full text-sm text-left text-gray-200">
                        <thead class="table-header">
                            <tr>
                                <th class="px-4 py-3">ID</th>
                                <th class="px-4 py-3">åç§°</th>
                                <th class="px-4 py-3">ç±»åˆ«</th>
                                <th class="px-4 py-3">ä»·æ ¼</th>
                                <th class="px-4 py-3">åº“å­˜</th>
                                <th class="px-4 py-3">é”€é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="px-4 py-8 text-center text-gray-400 italic">ç‚¹å‡»"åŠ è½½æ•°æ®"æŒ‰é’®åŠ è½½ç¤ºä¾‹æ•°æ®</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- å³ä¾§è¡¨æ ¼ -->
            <div class="lg:col-span-1 data-card p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">è¡¨æ ¼ B</h2>
                    <div class="flex gap-2">
                        <input type="file" id="fileInputB" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleFileUpload(event, 'B')">
                        <button id="importTableB" class="tech-button py-1 px-3 text-sm" onclick="document.getElementById('fileInputB').click()">
                            <i class="fa fa-upload mr-1"></i>å¯¼å…¥æ–‡ä»¶
                        </button>
                        <button id="loadSampleB" class="tech-button py-1 px-3 text-sm bg-gray-700 hover:bg-gray-600" onclick="loadSampleData('B')">
                            <i class="fa fa-database mr-1"></i>ç¤ºä¾‹æ•°æ®
                        </button>
                    </div>
                </div>
                <div class="relative overflow-x-auto scrollbar-thin max-h-[500px]">
                    <table id="tableB" class="w-full text-sm text-left text-gray-200">
                        <thead class="table-header">
                            <tr>
                                <th class="px-4 py-3">ID</th>
                                <th class="px-4 py-3">åç§°</th>
                                <th class="px-4 py-3">ç±»åˆ«</th>
                                <th class="px-4 py-3">ä»·æ ¼</th>
                                <th class="px-4 py-3">åº“å­˜</th>
                                <th class="px-4 py-3">é”€é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="px-4 py-8 text-center text-gray-400 italic">ç‚¹å‡»"åŠ è½½æ•°æ®"æŒ‰é’®åŠ è½½ç¤ºä¾‹æ•°æ®</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- å·®å¼‚åˆ†æé¢æ¿ -->
            <div class="lg:col-span-1 data-card p-4">
                <h2 class="text-xl font-semibold text-white mb-4">å·®å¼‚åˆ†æ</h2>
                
                <!-- å·®å¼‚ç»Ÿè®¡å¡ç‰‡ -->
                <div class="bg-white bg-opacity-10 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-white mb-3">å·®å¼‚ç»Ÿè®¡</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-primary bg-opacity-50 rounded-lg p-3 text-center">
                            <p class="text-sm text-gray-300">æ€»å·®å¼‚æ•°</p>
                            <p id="totalDiffs" class="text-2xl font-bold text-accent">0</p>
                        </div>
                        <div class="bg-primary bg-opacity-50 rounded-lg p-3 text-center">
                            <p class="text-sm text-gray-300">å·®å¼‚è¡Œæ¯”ä¾‹</p>
                            <p id="diffRowPercentage" class="text-2xl font-bold text-accent">0%</p>
                        </div>
                        <div class="bg-primary bg-opacity-50 rounded-lg p-3 text-center">
                            <p class="text-sm text-gray-300">å¢åŠ é¡¹</p>
                            <p id="increaseCount" class="text-2xl font-bold text-diff-increase">0</p>
                        </div>
                        <div class="bg-primary bg-opacity-50 rounded-lg p-3 text-center">
                            <p class="text-sm text-gray-300">å‡å°‘é¡¹</p>
                            <p id="decreaseCount" class="text-2xl font-bold text-diff-decrease">0</p>
                        </div>
                    </div>
                </div>

                <!-- å·®å¼‚ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="bg-white bg-opacity-10 rounded-lg p-4">
                    <h3 class="text-lg font-medium text-white mb-3">å¯¹æ¯”çŠ¶æ€</h3>
                    <div id="diffSummary" class="text-sm text-gray-200">
                        <p class="italic text-gray-400">è¯·å…ˆåŠ è½½ä¸¤ä¸ªè¡¨æ ¼çš„æ•°æ®ï¼Œç„¶åç‚¹å‡»"å¯¹æ¯”æ•°æ®"æŒ‰é’®ç”Ÿæˆå·®å¼‚åˆ†æ</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å·®å¼‚è¯¦æƒ…é¢æ¿ -->
        <div class="mt-8 data-card p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-white">å·®å¼‚è¯¦æƒ…</h2>
                <div class="flex gap-2">
                    <select id="diffFilter" class="rounded-lg border border-gray-300 bg-white bg-opacity-80 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                        <option value="all">æ‰€æœ‰å·®å¼‚</option>
                        <option value="increase">ä»…å¢åŠ </option>
                        <option value="decrease">ä»…å‡å°‘</option>
                        <option value="change">ä»…å˜åŒ–</option>
                    </select>
                    <select id="sortBy" class="rounded-lg border border-gray-300 bg-white bg-opacity-80 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                        <option value="id">æŒ‰IDæ’åº</option>
                        <option value="name">æŒ‰åç§°æ’åº</option>
                        <option value="diffValue">æŒ‰å·®å¼‚å€¼æ’åº</option>
                        <option value="diffPercentage">æŒ‰å·®å¼‚ç™¾åˆ†æ¯”æ’åº</option>
                    </select>
                </div>
            </div>
            <div class="relative overflow-x-auto scrollbar-thin">
                <table id="diffTable" class="w-full text-sm text-left text-gray-200">
                    <thead class="table-header">
                        <tr>
                            <th class="px-4 py-3">ID</th>
                            <th class="px-4 py-3">åç§°</th>
                            <th class="px-4 py-3">å­—æ®µ</th>
                            <th class="px-4 py-3">è¡¨æ ¼Aå€¼</th>
                            <th class="px-4 py-3">è¡¨æ ¼Bå€¼</th>
                            <th class="px-4 py-3">å·®å¼‚å€¼</th>
                            <th class="px-4 py-3">å·®å¼‚ç™¾åˆ†æ¯”</th>
                            <th class="px-4 py-3">å·®å¼‚ç±»å‹</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="8" class="px-4 py-8 text-center text-gray-400 italic">æš‚æ— å·®å¼‚æ•°æ®</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let tableAData = [];
        let tableBData = [];
        let diffData = [];

        // DOM å…ƒç´ 
        const tableA = document.getElementById('tableA');
        const tableB = document.getElementById('tableB');
        const diffTable = document.getElementById('diffTable');
        const diffSummary = document.getElementById('diffSummary');
        const totalDiffsEl = document.getElementById('totalDiffs');
        const diffRowPercentageEl = document.getElementById('diffRowPercentage');
        const increaseCountEl = document.getElementById('increaseCount');
        const decreaseCountEl = document.getElementById('decreaseCount');
        const compareTablesBtn = document.getElementById('compareTables');
        const exportResultsBtn = document.getElementById('exportResults');
        const diffFilter = document.getElementById('diffFilter');
        const sortBy = document.getElementById('sortBy');
        const highlightMode = document.getElementById('highlightMode');
        const primaryKey = document.getElementById('primaryKey');

        // ç¤ºä¾‹æ•°æ® - äº§å“ä¿¡æ¯
        const sampleProducts = [
            { id: 1, name: 'è¶…çº§æ™ºèƒ½æ‰‹æœº', category: 'ç”µå­äº§å“', price: 4999, stock: 150, sales: 2500 },
            { id: 2, name: 'ä¸“ä¸šç¬”è®°æœ¬ç”µè„‘', category: 'ç”µå­äº§å“', price: 8999, stock: 80, sales: 1200 },
            { id: 3, name: 'æ™ºèƒ½æ‰‹è¡¨', category: 'ç©¿æˆ´è®¾å¤‡', price: 1999, stock: 200, sales: 3500 },
            { id: 4, name: 'æ— çº¿è€³æœº', category: 'éŸ³é¢‘è®¾å¤‡', price: 999, stock: 300, sales: 5000 },
            { id: 5, name: '4Kæ™ºèƒ½ç”µè§†', category: 'å®¶ç”µ', price: 5999, stock: 60, sales: 800 },
            { id: 6, name: 'æ¸¸æˆä¸»æœº', category: 'æ¸¸æˆè®¾å¤‡', price: 3999, stock: 100, sales: 1800 },
            { id: 7, name: 'æ™ºèƒ½éŸ³ç®±', category: 'æ™ºèƒ½å®¶å±…', price: 799, stock: 250, sales: 4200 },
            { id: 8, name: 'æœºæ¢°é”®ç›˜', category: 'ç”µè„‘é…ä»¶', price: 599, stock: 180, sales: 2800 },
            { id: 9, name: 'ä¸“ä¸šç›¸æœº', category: 'æ‘„å½±è®¾å¤‡', price: 12999, stock: 40, sales: 600 },
            { id: 10, name: 'å¹³æ¿ç”µè„‘', category: 'ç”µå­äº§å“', price: 3699, stock: 120, sales: 2200 }
        ];

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            console.log('æ•°æ®è¡¨æ ¼å¯¹æ¯”åˆ†æå·¥å…·åˆå§‹åŒ–ä¸­...');
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            bindEventListeners();
            
            console.log('åˆå§‹åŒ–å®Œæˆï¼');
        }

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        function bindEventListeners() {
            // å¯¹æ¯”æ•°æ®æŒ‰é’®
            if (compareTablesBtn) {
                compareTablesBtn.addEventListener('click', compareTables);
                console.log('å¯¹æ¯”æ•°æ®æŒ‰é’®äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }

            // å¯¼å‡ºç»“æœæŒ‰é’®
            if (exportResultsBtn) {
                exportResultsBtn.addEventListener('click', exportResults);
                console.log('å¯¼å‡ºç»“æœæŒ‰é’®äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }

            // å·®å¼‚è¿‡æ»¤å’Œæ’åº
            if (diffFilter) {
                diffFilter.addEventListener('change', updateDiffTable);
                console.log('å·®å¼‚è¿‡æ»¤äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }
            
            if (sortBy) {
                sortBy.addEventListener('change', updateDiffTable);
                console.log('æ’åºæ–¹å¼äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }

            // é«˜äº®æ–¹å¼
            if (highlightMode) {
                highlightMode.addEventListener('change', updateHighlightMode);
                console.log('é«˜äº®æ–¹å¼äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }

            // è¡¨æ ¼åŒæ­¥æ»šåŠ¨
            const tableAContainer = tableA.parentElement;
            const tableBContainer = tableB.parentElement;
            
            if (tableAContainer && tableBContainer) {
                tableAContainer.addEventListener('scroll', () => {
                    tableBContainer.scrollLeft = tableAContainer.scrollLeft;
                });
                
                tableBContainer.addEventListener('scroll', () => {
                    tableAContainer.scrollLeft = tableBContainer.scrollLeft;
                });
                console.log('è¡¨æ ¼åŒæ­¥æ»šåŠ¨äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }
        }

        // åŠ è½½ç¤ºä¾‹æ•°æ®
        function loadSampleData(tableType) {
            console.log(`å¼€å§‹åŠ è½½${tableType === 'A' ? 'è¡¨æ ¼A' : 'è¡¨æ ¼B'}ç¤ºä¾‹æ•°æ®...`);
            
            const tableElement = tableType === 'A' ? tableA : tableB;
            const tbody = tableElement.querySelector('tbody');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-300">æ­£åœ¨ç”Ÿæˆç¤ºä¾‹æ•°æ®ï¼Œè¯·ç¨å€™...</td></tr>';
            
            // æ¨¡æ‹ŸåŠ è½½å»¶è¿Ÿ
            setTimeout(() => {
                try {
                    let data;
                    
                    if (tableType === 'A') {
                        // è¡¨æ ¼Aï¼šåŸå§‹æ•°æ®
                        data = sampleProducts.map(product => ({ ...product }));
                        tableAData = data;
                    } else {
                        // è¡¨æ ¼Bï¼šå¸¦å·®å¼‚çš„æ•°æ®
                        data = sampleProducts.map(product => {
                            const newProduct = { ...product };
                            
                            // æ·»åŠ éšæœºå·®å¼‚
                            newProduct.price = Math.floor(newProduct.price * (1 + (Math.random() - 0.5) * 0.3));
                            newProduct.stock = Math.floor(newProduct.stock * (1 + (Math.random() - 0.5) * 0.5));
                            newProduct.sales = Math.floor(newProduct.sales * (1 + (Math.random() - 0.5) * 0.4));
                            
                            // æ·»åŠ ç‰¹æ®Šå·®å¼‚
                            if (product.id % 3 === 0) {
                                newProduct.stock = 0; // åº“å­˜ä¸º0
                            }
                            if (product.id % 4 === 0) {
                                newProduct.discount = Math.floor(Math.random() * 30 + 10); // æ–°å¢æŠ˜æ‰£å­—æ®µ
                            }
                            
                            return newProduct;
                        });
                        tableBData = data;
                    }
                    
                    // æ¸²æŸ“è¡¨æ ¼
                    renderTable(tableElement, data);
                    
                    console.log(`${tableType === 'A' ? 'è¡¨æ ¼A' : 'è¡¨æ ¼B'}ç¤ºä¾‹æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±${data.length}æ¡è®°å½•`);
                    
                    // æ›´æ–°çŠ¶æ€æç¤º
                    updateStatusMessage();
                    
                    // è‡ªåŠ¨å¯¹æ¯”ï¼ˆå¦‚æœä¸¤ä¸ªè¡¨æ ¼éƒ½æœ‰æ•°æ®ï¼‰
                    if (tableAData.length > 0 && tableBData.length > 0) {
                        console.log('ä¸¤ä¸ªè¡¨æ ¼éƒ½æœ‰æ•°æ®ï¼Œè‡ªåŠ¨è¿›è¡Œå¯¹æ¯”åˆ†æ...');
                        setTimeout(() => {
                            compareTables();
                        }, 500);
                    }
                    
                } catch (error) {
                    console.error('ç¤ºä¾‹æ•°æ®åŠ è½½å¤±è´¥:', error);
                    tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-red-300">æ•°æ®åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
                }
            }, 800);
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event, tableType) {
            console.log(`å¼€å§‹å¤„ç†${tableType === 'A' ? 'è¡¨æ ¼A' : 'è¡¨æ ¼B'}æ–‡ä»¶ä¸Šä¼ ...`);
            
            const file = event.target.files[0];
            if (!file) {
                console.log('æœªé€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            const tableElement = tableType === 'A' ? tableA : tableB;
            const tbody = tableElement.querySelector('tbody');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-300">æ­£åœ¨è§£ææ–‡ä»¶ "${file.name}"ï¼Œè¯·ç¨å€™...</td></tr>`;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let jsonData;
                    
                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    
                    if (fileExtension === 'csv') {
                        // CSVæ–‡ä»¶ä½¿ç”¨åŸç”Ÿè§£æ
                        jsonData = parseCSV(e.target.result);
                    } else if (['xlsx', 'xls'].includes(fileExtension)) {
                        // Excelæ–‡ä»¶ä½¿ç”¨XLSXåº“
                        if (typeof XLSX !== 'undefined') {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            jsonData = XLSX.utils.sheet_to_json(worksheet);
                        } else {
                            throw new Error('Excelæ–‡ä»¶éœ€è¦XLSXåº“ï¼Œè¯·ä½¿ç”¨CSVæ–‡ä»¶æˆ–åˆ·æ–°é¡µé¢é‡è¯•');
                        }
                    } else {
                        throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·é€‰æ‹©Excelæˆ–CSVæ–‡ä»¶');
                    }
                    
                    if (!jsonData || jsonData.length === 0) {
                        throw new Error('æ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®');
                    }
                    
                    console.log(`æˆåŠŸè§£ææ–‡ä»¶ï¼Œå…±${jsonData.length}æ¡è®°å½•`);
                    
                    // æ ‡å‡†åŒ–æ•°æ®æ ¼å¼
                    const normalizedData = normalizeData(jsonData);
                    
                    // ä¿å­˜æ•°æ®
                    if (tableType === 'A') {
                        tableAData = normalizedData;
                    } else {
                        tableBData = normalizedData;
                    }
                    
                    // æ¸²æŸ“è¡¨æ ¼
                    renderTable(tableElement, normalizedData);
                    
                    // æ›´æ–°çŠ¶æ€æç¤º
                    updateStatusMessage();
                    
                    // è‡ªåŠ¨å¯¹æ¯”ï¼ˆå¦‚æœä¸¤ä¸ªè¡¨æ ¼éƒ½æœ‰æ•°æ®ï¼‰
                    if (tableAData.length > 0 && tableBData.length > 0) {
                        console.log('ä¸¤ä¸ªè¡¨æ ¼éƒ½æœ‰æ•°æ®ï¼Œè‡ªåŠ¨è¿›è¡Œå¯¹æ¯”åˆ†æ...');
                        setTimeout(() => {
                            compareTables();
                        }, 500);
                    }
                    
                } catch (error) {
                    console.error('æ–‡ä»¶è§£æå¤±è´¥:', error);
                    let errorMessage = 'æ–‡ä»¶è§£æå¤±è´¥';
                    
                    if (error.message.includes('Unsupported file format')) {
                        errorMessage = 'ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·é€‰æ‹©Excelæˆ–CSVæ–‡ä»¶';
                    } else if (error.message.includes('Corrupt file')) {
                        errorMessage = 'æ–‡ä»¶å·²æŸåï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§';
                    } else if (error.message.includes('XLSXåº“')) {
                        errorMessage = 'Excelè§£æåº“æœªåŠ è½½ï¼Œè¯·ä½¿ç”¨CSVæ–‡ä»¶æ ¼å¼';
                    } else {
                        errorMessage = `æ–‡ä»¶è§£æå¤±è´¥: ${error.message}`;
                    }
                    
                    tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-red-300">${errorMessage}</td></tr>`;
                }
            };
            
            reader.onerror = function(error) {
                console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-red-300">æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>';
            };
            
            // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©è¯»å–æ–¹å¼
            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsArrayBuffer(file);
            }
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡æ–°é€‰æ‹©åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }

        // åŸç”ŸCSVè§£æå‡½æ•°
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) {
                throw new Error('CSVæ–‡ä»¶è‡³å°‘éœ€è¦åŒ…å«è¡¨å¤´å’Œä¸€è¡Œæ•°æ®');
            }
            
            // è§£æè¡¨å¤´
            const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
            
            // è§£ææ•°æ®è¡Œ
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === 0) continue;
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] !== undefined ? values[index] : '';
                });
                data.push(row);
            }
            
            return data;
        }

        // è§£æCSVè¡Œï¼ˆå¤„ç†å¼•å·å’Œé€—å·ï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        // å¤„ç†è½¬ä¹‰å¼•å·
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // æ ‡å‡†åŒ–æ•°æ®æ ¼å¼
        function normalizeData(data) {
            return data.map((row, index) => {
                const normalizedRow = {};
                
                // æ ‡å‡†åŒ–å¸¸è§å­—æ®µå
                Object.keys(row).forEach(key => {
                    const normalizedKey = key.toLowerCase().trim();
                    let value = row[key];
                    
                    // å°è¯•è½¬æ¢æ•°å€¼
                    if (typeof value === 'string' && !isNaN(value) && value.trim() !== '') {
                        value = parseFloat(value);
                    }
                    
                    // æ˜ å°„å¸¸è§å­—æ®µå
                    if (normalizedKey.includes('id') || normalizedKey.includes('ç¼–å·')) {
                        normalizedRow.id = value || index + 1;
                    } else if (normalizedKey.includes('name') || normalizedKey.includes('åç§°') || normalizedKey.includes('äº§å“')) {
                        normalizedRow.name = value || `é¡¹ç›®${index + 1}`;
                    } else if (normalizedKey.includes('price') || normalizedKey.includes('ä»·æ ¼') || normalizedKey.includes('å•ä»·')) {
                        normalizedRow.price = value || 0;
                    } else if (normalizedKey.includes('stock') || normalizedKey.includes('åº“å­˜') || normalizedKey.includes('æ•°é‡')) {
                        normalizedRow.stock = value || 0;
                    } else if (normalizedKey.includes('sales') || normalizedKey.includes('é”€é‡') || normalizedKey.includes('é”€å”®')) {
                        normalizedRow.sales = value || 0;
                    } else if (normalizedKey.includes('category') || normalizedKey.includes('ç±»åˆ«') || normalizedKey.includes('åˆ†ç±»')) {
                        normalizedRow.category = value || 'æœªåˆ†ç±»';
                    } else {
                        // ä¿ç•™åŸå§‹å­—æ®µ
                        normalizedRow[key] = value;
                    }
                });
                
                // ç¡®ä¿æœ‰IDå’Œåç§°
                if (!normalizedRow.id) normalizedRow.id = index + 1;
                if (!normalizedRow.name) normalizedRow.name = `é¡¹ç›®${index + 1}`;
                
                return normalizedRow;
            });
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable(tableElement, data) {
            const thead = tableElement.querySelector('thead');
            const tbody = tableElement.querySelector('tbody');
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                thead.innerHTML = '<tr><th class="px-4 py-3">æš‚æ— æ•°æ®</th></tr>';
                tbody.innerHTML = '<tr><td colspan="1" class="px-4 py-8 text-center text-gray-400 italic">æš‚æ— æ•°æ®</td></tr>';
                return;
            }
            
            // è·å–æ‰€æœ‰å­—æ®µå
            const allFields = [...new Set(data.flatMap(row => Object.keys(row)))];
            
            // æ›´æ–°è¡¨å¤´
            thead.innerHTML = '';
            const headerRow = document.createElement('tr');
            allFields.forEach(field => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3';
                th.textContent = formatFieldName(field);
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            // æ›´æ–°ä¸»é”®åˆ—é€‰é¡¹å’Œæ’åºé€‰é¡¹
            updatePrimaryKeyOptions(allFields);
            updateSortOptions(allFields);
            
            // æ¸²æŸ“æ•°æ®è¡Œ
            data.forEach(rowData => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-white hover:bg-opacity-10 transition-colors';
                
                let rowHtml = '';
                allFields.forEach(field => {
                    const value = rowData[field] !== undefined ? rowData[field] : '';
                    const displayValue = formatCellValue(value, field);
                    rowHtml += `<td class="px-4 py-3" data-field="${field}">${displayValue}</td>`;
                });
                
                row.innerHTML = rowHtml;
                tbody.appendChild(row);
            });
        }

        // æ›´æ–°ä¸»é”®åˆ—é€‰é¡¹
        function updatePrimaryKeyOptions(fields) {
            const primaryKeySelect = document.getElementById('primaryKey');
            if (!primaryKeySelect) return;
            
            // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
            const currentValue = primaryKeySelect.value;
            
            // æ¸…é™¤ç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"è‡ªåŠ¨æ£€æµ‹"ï¼‰
            primaryKeySelect.innerHTML = '<option value="">è‡ªåŠ¨æ£€æµ‹</option>';
            
            // æ·»åŠ æ–°çš„å­—æ®µé€‰é¡¹
            fields.forEach(field => {
                // è·³è¿‡ä¸€äº›ä¸é€‚åˆä½œä¸ºä¸»é”®çš„å­—æ®µ
                if (field.toLowerCase().includes('å¤‡æ³¨') || 
                    field.toLowerCase().includes('è¯´æ˜') ||
                    field.toLowerCase().includes('æè¿°') ||
                    field.length > 20) {
                    return;
                }
                
                const option = document.createElement('option');
                option.value = field;
                option.textContent = formatFieldName(field);
                primaryKeySelect.appendChild(option);
            });
            
            // æ¢å¤ä¹‹å‰çš„é€‰æ‹©ï¼ˆå¦‚æœä»ç„¶å¯ç”¨ï¼‰
            if (currentValue && Array.from(primaryKeySelect.options).some(opt => opt.value === currentValue)) {
                primaryKeySelect.value = currentValue;
            }
        }

        // æ›´æ–°æ’åºé€‰é¡¹
        function updateSortOptions(fields) {
            const sortBySelect = document.getElementById('sortBy');
            if (!sortBySelect) return;
            
            // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
            const currentValue = sortBySelect.value;
            
            // ä¿ç•™åŸºç¡€æ’åºé€‰é¡¹
            sortBySelect.innerHTML = `
                <option value="id">æŒ‰IDæ’åº</option>
                <option value="name">æŒ‰åç§°æ’åº</option>
                <option value="diffValue">æŒ‰å·®å¼‚å€¼æ’åº</option>
                <option value="diffPercentage">æŒ‰å·®å¼‚ç™¾åˆ†æ¯”æ’åº</option>
            `;
            
            // æ·»åŠ å­—æ®µæ’åºé€‰é¡¹
            fields.forEach(field => {
                // è·³è¿‡ä¸é€‚åˆæ’åºçš„å­—æ®µ
                if (typeof tableAData[0]?.[field] === 'string' && 
                    tableAData[0]?.[field].length > 50) {
                    return;
                }
                
                const option = document.createElement('option');
                option.value = field;
                option.textContent = `æŒ‰${formatFieldName(field)}æ’åº`;
                sortBySelect.appendChild(option);
            });
            
            // æ¢å¤ä¹‹å‰çš„é€‰æ‹©ï¼ˆå¦‚æœä»ç„¶å¯ç”¨ï¼‰
            if (currentValue && Array.from(sortBySelect.options).some(opt => opt.value === currentValue)) {
                sortBySelect.value = currentValue;
            }
        }

        // æ ¼å¼åŒ–å•å…ƒæ ¼å€¼
        function formatCellValue(value, field) {
            if (value === null || value === undefined) return '';
            
            // æ•°å€¼æ ¼å¼åŒ–
            if (typeof value === 'number') {
                if (field.toLowerCase().includes('price') || field.toLowerCase().includes('ä»·æ ¼')) {
                    return `Â¥${value.toLocaleString()}`;
                } else if (field.toLowerCase().includes('percent') || field.toLowerCase().includes('ç™¾åˆ†æ¯”')) {
                    return `${value.toFixed(1)}%`;
                } else {
                    return value.toLocaleString();
                }
            }
            
            // æ—¥æœŸæ ¼å¼åŒ–
            if (value instanceof Date || (typeof value === 'string' && !isNaN(Date.parse(value)))) {
                const date = new Date(value);
                return date.toLocaleDateString('zh-CN');
            }
            
            // å­—ç¬¦ä¸²æˆªæ–­
            if (typeof value === 'string' && value.length > 50) {
                return value.substring(0, 50) + '...';
            }
            
            return value;
        }

        // æ›´æ–°çŠ¶æ€æ¶ˆæ¯
        function updateStatusMessage() {
            const statusText = tableAData.length > 0 && tableBData.length > 0 
                ? 'ä¸¤ä¸ªè¡¨æ ¼æ•°æ®å·²å°±ç»ªï¼Œç‚¹å‡»"å¯¹æ¯”æ•°æ®"æŒ‰é’®å¼€å§‹åˆ†æ'
                : tableAData.length > 0 
                    ? 'è¡¨æ ¼Aæ•°æ®å·²åŠ è½½ï¼Œè¯·åŠ è½½è¡¨æ ¼Bæ•°æ®'
                    : 'è¡¨æ ¼Bæ•°æ®å·²åŠ è½½ï¼Œè¯·åŠ è½½è¡¨æ ¼Aæ•°æ®';
            
            diffSummary.innerHTML = `<p class="text-blue-300">${statusText}</p>`;
        }

        // å¯¹æ¯”è¡¨æ ¼æ•°æ®
        function compareTables() {
            console.log('å¼€å§‹å¯¹æ¯”è¡¨æ ¼æ•°æ®...');
            
            if (tableAData.length === 0 || tableBData.length === 0) {
                diffSummary.innerHTML = '<p class="text-red-300">è¯·å…ˆåŠ è½½ä¸¤ä¸ªè¡¨æ ¼çš„æ•°æ®</p>';
                return;
            }
            
            // æ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
            diffSummary.innerHTML = '<p class="text-accent font-medium">ğŸ¤– æ­£åœ¨è¿›è¡Œæ•°æ®å¯¹æ¯”åˆ†æï¼Œè¯·ç¨å€™...</p>';
            
            // æ¨¡æ‹Ÿå¤„ç†å»¶è¿Ÿ
            setTimeout(() => {
                try {
                    // æ¸…ç©ºä¹‹å‰çš„å·®å¼‚æ•°æ®
                    diffData = [];
                    
                    // æŒ‰IDå¯¹æ¯”æ•°æ®
                    const idMapA = new Map(tableAData.map(item => [item.id, item]));
                    const idMapB = new Map(tableBData.map(item => [item.id, item]));
                    
                    // æ‰¾å‡ºæ‰€æœ‰å”¯ä¸€çš„ID
                    const allIds = [...new Set([...idMapA.keys(), ...idMapB.keys()])];
                    
                    // å¯¹æ¯”æ¯ä¸€è¡Œæ•°æ®
                    allIds.forEach(id => {
                        const itemA = idMapA.get(id);
                        const itemB = idMapB.get(id);
                        
                        if (!itemA) {
                            // ä»…åœ¨è¡¨æ ¼Bä¸­å­˜åœ¨ - æ–°å¢é¡¹
                            diffData.push({
                                id: id,
                                name: itemB.name,
                                field: 'æ•´è¡Œ',
                                valueA: 'ä¸å­˜åœ¨',
                                valueB: 'æ–°å¢',
                                diffValue: 'æ–°å¢',
                                diffPercentage: 'N/A',
                                diffType: 'increase'
                            });
                        } else if (!itemB) {
                            // ä»…åœ¨è¡¨æ ¼Aä¸­å­˜åœ¨ - åˆ é™¤é¡¹
                            diffData.push({
                                id: id,
                                name: itemA.name,
                                field: 'æ•´è¡Œ',
                                valueA: 'å­˜åœ¨',
                                valueB: 'åˆ é™¤',
                                diffValue: 'åˆ é™¤',
                                diffPercentage: 'N/A',
                                diffType: 'decrease'
                            });
                        } else {
                            // ä¸¤è¡Œéƒ½å­˜åœ¨ï¼Œå¯¹æ¯”å„ä¸ªå­—æ®µ
                            const allFields = [...new Set([...Object.keys(itemA), ...Object.keys(itemB)])];
                            
                            allFields.forEach(field => {
                                if (field === 'id' || field === 'name') return; // è·³è¿‡IDå’Œåç§°å­—æ®µ
                                
                                const valueA = itemA[field] !== undefined ? itemA[field] : 'N/A';
                                const valueB = itemB[field] !== undefined ? itemB[field] : 'N/A';
                                
                                if (valueA !== valueB) {
                                    let diffValue = 'å˜åŒ–';
                                    let diffPercentage = 'N/A';
                                    let diffType = 'change';
                                    
                                    // è®¡ç®—æ•°å€¼å·®å¼‚
                                    if (typeof valueA === 'number' && typeof valueB === 'number') {
                                        diffValue = valueB - valueA;
                                        diffPercentage = valueA !== 0 ? ((diffValue / valueA) * 100).toFixed(1) + '%' : 'âˆ';
                                        diffType = diffValue > 0 ? 'increase' : diffValue < 0 ? 'decrease' : 'change';
                                    }
                                    
                                    diffData.push({
                                        id: id,
                                        name: itemA.name,
                                        field: formatFieldName(field),
                                        valueA: valueA,
                                        valueB: valueB,
                                        diffValue: diffValue,
                                        diffPercentage: diffPercentage,
                                        diffType: diffType
                                    });
                                }
                            });
                        }
                    });
                    
                    // æ›´æ–°å·®å¼‚ç»Ÿè®¡
                    updateDiffStats();
                    
                    // æ›´æ–°å·®å¼‚è¡¨æ ¼
                    updateDiffTable();
                    
                    // æ›´æ–°å·®å¼‚æ‘˜è¦
                    updateDiffSummary();
                    
                    console.log(`å¯¹æ¯”å®Œæˆï¼Œå‘ç°${diffData.length}ä¸ªå·®å¼‚`);
                    
                } catch (error) {
                    console.error('å¯¹æ¯”åˆ†æå¤±è´¥:', error);
                    diffSummary.innerHTML = `<p class="text-red-300">å¯¹æ¯”åˆ†æå¤±è´¥: ${error.message}</p>`;
                }
            }, 1000);
        }

        // æ›´æ–°å·®å¼‚ç»Ÿè®¡
        function updateDiffStats() {
            const totalDiffs = diffData.length;
            const totalRows = Math.max(tableAData.length, tableBData.length);
            const diffRowPercentage = totalRows > 0 ? Math.round((new Set(diffData.map(d => d.id)).size / totalRows) * 100) : 0;
            const increaseCount = diffData.filter(d => d.diffType === 'increase').length;
            const decreaseCount = diffData.filter(d => d.diffType === 'decrease').length;
            
            totalDiffsEl.textContent = totalDiffs;
            diffRowPercentageEl.textContent = `${diffRowPercentage}%`;
            increaseCountEl.textContent = increaseCount;
            decreaseCountEl.textContent = decreaseCount;
        }

        // æ›´æ–°å·®å¼‚è¡¨æ ¼
        function updateDiffTable() {
            const tbody = diffTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            if (diffData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-400 italic">æš‚æ— å·®å¼‚æ•°æ®</td></tr>';
                return;
            }
            
            // åº”ç”¨è¿‡æ»¤å’Œæ’åº
            let filteredData = [...diffData];
            
            // è¿‡æ»¤
            const filterValue = diffFilter.value;
            if (filterValue !== 'all') {
                filteredData = filteredData.filter(diff => diff.diffType === filterValue);
            }
            
            // æ’åº
            const sortValue = sortBy.value;
            filteredData.sort((a, b) => {
                switch (sortValue) {
                    case 'id':
                        return a.id - b.id;
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'diffValue':
                        return typeof a.diffValue === 'number' && typeof b.diffValue === 'number' 
                            ? b.diffValue - a.diffValue 
                            : 0;
                    case 'diffPercentage':
                        return typeof a.diffPercentage === 'string' && typeof b.diffPercentage === 'string'
                            ? parseFloat(b.diffPercentage) - parseFloat(a.diffPercentage)
                            : 0;
                    default:
                        // æ£€æŸ¥æ˜¯å¦ä¸ºå­—æ®µæ’åº
                        if (tableAData.length > 0 && tableBData.length > 0) {
                            const itemA1 = tableAData.find(item => item.id === a.id);
                            const itemB1 = tableBData.find(item => item.id === a.id);
                            const itemA2 = tableAData.find(item => item.id === b.id);
                            const itemB2 = tableBData.find(item => item.id === b.id);
                            
                            const value1 = itemA1?.[sortValue] ?? itemB1?.[sortValue];
                            const value2 = itemA2?.[sortValue] ?? itemB2?.[sortValue];
                            
                            if (typeof value1 === 'number' && typeof value2 === 'number') {
                                return value1 - value2;
                            } else if (typeof value1 === 'string' && typeof value2 === 'string') {
                                return value1.localeCompare(value2);
                            }
                        }
                        return 0;
                }
            });
            
            // æ¸²æŸ“å·®å¼‚è¡Œ
            filteredData.forEach(diff => {
                const row = document.createElement('tr');
                row.className = `border-b border-gray-700 hover:bg-white hover:bg-opacity-10 transition-colors`;
                
                // æ ¹æ®å·®å¼‚ç±»å‹è®¾ç½®æ ·å¼
                const diffClass = diff.diffType === 'increase' ? 'text-diff-increase' : 
                                 diff.diffType === 'decrease' ? 'text-diff-decrease' : 'text-diff-change';
                
                row.innerHTML = `
                    <td class="px-4 py-3">${diff.id}</td>
                    <td class="px-4 py-3">${diff.name}</td>
                    <td class="px-4 py-3">${diff.field}</td>
                    <td class="px-4 py-3">${formatValue(diff.valueA)}</td>
                    <td class="px-4 py-3 ${diffClass} font-medium">${formatValue(diff.valueB)}</td>
                    <td class="px-4 py-3 ${diffClass} font-medium">${formatValue(diff.diffValue)}</td>
                    <td class="px-4 py-3">${diff.diffPercentage}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${getDiffTypeClass(diff.diffType)}">
                            ${getDiffTypeText(diff.diffType)}
                        </span>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // æ›´æ–°å·®å¼‚å›¾è¡¨


        // æ›´æ–°å·®å¼‚æ‘˜è¦
        function updateDiffSummary() {
            if (diffData.length === 0) {
                diffSummary.innerHTML = '<p class="text-green-300">ğŸ‰ ä¸¤ä¸ªè¡¨æ ¼æ•°æ®å®Œå…¨ä¸€è‡´ï¼Œæœªå‘ç°å·®å¼‚</p>';
                return;
            }
            
            const increaseCount = diffData.filter(d => d.diffType === 'increase').length;
            const decreaseCount = diffData.filter(d => d.diffType === 'decrease').length;
            const changeCount = diffData.filter(d => d.diffType === 'change').length;
            
            const summary = `
                <div class="space-y-2">
                    <p class="font-medium text-white">ğŸ“Š å·®å¼‚åˆ†æå®Œæˆ</p>
                    <p>å…±å‘ç° <span class="text-accent font-bold">${diffData.length}</span> ä¸ªå·®å¼‚</p>
                    <p>å…¶ä¸­ï¼š
                        <span class="text-diff-increase">å¢åŠ  ${increaseCount} é¡¹</span> | 
                        <span class="text-diff-decrease">å‡å°‘ ${decreaseCount} é¡¹</span> | 
                        <span class="text-diff-change">å˜åŒ– ${changeCount} é¡¹</span>
                    </p>
                    <p class="text-sm text-gray-300 mt-2">ğŸ’¡ æç¤ºï¼šç‚¹å‡»å·®å¼‚è¯¦æƒ…è¡¨æ ¼ä¸­çš„è¡Œå¯ä»¥æŸ¥çœ‹æ›´å¤šä¿¡æ¯</p>
                </div>
            `;
            
            diffSummary.innerHTML = summary;
        }

        // æ›´æ–°é«˜äº®æ–¹å¼
        function updateHighlightMode() {
            if (diffData.length > 0) {
                updateDiffTable();
            }
        }

        // å¯¼å‡ºç»“æœ
        function exportResults() {
            console.log('å¯¼å‡ºå¯¹æ¯”ç»“æœ...');
            
            if (diffData.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å·®å¼‚æ•°æ®ï¼Œè¯·å…ˆè¿›è¡Œå¯¹æ¯”åˆ†æ');
                return;
            }
            
            // åˆ›å»ºCSVå†…å®¹
            let csvContent = "ID,åç§°,å­—æ®µ,è¡¨æ ¼Aå€¼,è¡¨æ ¼Bå€¼,å·®å¼‚å€¼,å·®å¼‚ç™¾åˆ†æ¯”,å·®å¼‚ç±»å‹\n";
            
            diffData.forEach(diff => {
                const row = [
                    diff.id,
                    `"${diff.name}"`,
                    `"${diff.field}"`,
                    `"${diff.valueA}"`,
                    `"${diff.valueB}"`,
                    `"${diff.diffValue}"`,
                    diff.diffPercentage,
                    getDiffTypeText(diff.diffType)
                ].join(',');
                
                csvContent += row + '\n';
            });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `æ•°æ®å¯¹æ¯”ç»“æœ_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('å¯¼å‡ºæˆåŠŸ');
        }

        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–å­—æ®µå
        function formatFieldName(field) {
            const fieldNames = {
                'price': 'ä»·æ ¼',
                'stock': 'åº“å­˜',
                'sales': 'é”€é‡',
                'category': 'ç±»åˆ«',
                'discount': 'æŠ˜æ‰£'
            };
            return fieldNames[field] || field;
        }

        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–å€¼
        function formatValue(value) {
            if (typeof value === 'number') {
                return value.toLocaleString();
            }
            return value;
        }

        // å·¥å…·å‡½æ•°ï¼šè·å–å·®å¼‚ç±»å‹æ ·å¼
        function getDiffTypeClass(diffType) {
            switch (diffType) {
                case 'increase':
                    return 'bg-diff-increase bg-opacity-20 text-diff-increase';
                case 'decrease':
                    return 'bg-diff-decrease bg-opacity-20 text-diff-decrease';
                case 'change':
                    return 'bg-diff-change bg-opacity-20 text-diff-change';
                default:
                    return 'bg-gray-500 bg-opacity-20 text-gray-300';
            }
        }

        // å·¥å…·å‡½æ•°ï¼šè·å–å·®å¼‚ç±»å‹æ–‡æœ¬
        function getDiffTypeText(diffType) {
            switch (diffType) {
                case 'increase':
                    return 'å¢åŠ ';
                case 'decrease':
                    return 'å‡å°‘';
                case 'change':
                    return 'å˜åŒ–';
                default:
                    return 'æœªçŸ¥';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>