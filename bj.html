<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ…å¤´æ–°åæ•°æ®å¯¹æ¯”å¹³å°</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- SheetJS - Excelæ–‡ä»¶å¤„ç†åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- å¤‡ç”¨CDN -->
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- ç»Ÿä¸€çš„ Tailwind é…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',      // æ·±è“ä¸»è‰²
                        secondary: '#7c3aed',    // ç§‘æŠ€æ„Ÿç´«è‰²
                        accent: '#06b6d4',       // äº®é’è‰²
                        neutral: '#f1f5f9',      // æµ…ç°èƒŒæ™¯
                        'diff-increase': '#ef4444', // å¢åŠ å·®å¼‚è‰²
                        'diff-decrease': '#22c55e', // å‡å°‘å·®å¼‚è‰²
                        'diff-change': '#eab308',  // å˜åŒ–å·®å¼‚è‰²
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'neon': '0 0 5px theme("colors.accent"), 0 0 20px theme("colors.accent")',
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.37)',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .glass-effect {
                @apply bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg;
            }
            .tech-button {
                @apply relative overflow-hidden rounded-lg bg-gradient-to-r from-primary to-secondary text-white font-medium py-2 px-4 transition-all duration-300 transform hover:scale-105 hover:shadow-neon focus:outline-none focus:ring-2 focus:ring-accent;
            }
            .tech-button::before {
                content: '';
                @apply absolute top-0 left-0 w-full h-full bg-gradient-to-r from-accent to-secondary opacity-0 transition-opacity duration-300;
            }
            .tech-button:hover::before {
                @apply opacity-20;
            }
            .table-header {
                @apply sticky top-0 z-10 bg-primary text-white font-semibold;
            }
            .diff-cell {
                @apply relative overflow-hidden;
            }
            .diff-cell::after {
                content: '';
                @apply absolute bottom-0 left-0 h-1 bg-accent transition-all duration-300 transform scale-x-0;
            }
            .diff-cell:hover::after {
                @apply scale-x-100;
            }
            .scrollbar-thin {
                scrollbar-width: thin;
                scrollbar-color: theme('colors.secondary') theme('colors.neutral');
            }
            .scrollbar-thin::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            .scrollbar-thin::-webkit-scrollbar-track {
                @apply bg-neutral;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                @apply bg-secondary rounded-full;
            }
            .data-card {
                @apply glass-effect border border-white border-opacity-20 rounded-xl shadow-glass transition-all duration-300 hover:shadow-lg;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-primary to-secondary min-h-screen text-gray-800 font-sans">
    <div class="container mx-auto px-4 py-8">
        <!-- é¡¶éƒ¨æ ‡é¢˜å’Œæ§åˆ¶åŒº -->
        <header class="mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <div class="text-center md:text-left">
                    <h1 class="text-3xl md:text-4xl font-bold text-white mb-2 flex items-center justify-center md:justify-start">
                        <i class="fa fa-table mr-3 text-accent"></i>
                        åŒ…å¤´æ–°åæ•°æ®å¯¹æ¯”å¹³å°
                    </h1>
                    <p class="text-white/80 text-sm md:text-base">
                     ***ç»¼åˆåŠç‰ˆæƒæ‰€æœ‰***
                    </p>
                </div>
                <div class="flex flex-wrap gap-3">
                    <button id="compareTables" class="tech-button bg-accent text-primary" title="å¯¹æ¯”ä¸¤ä¸ªè¡¨æ ¼ä¸­çš„æ•°æ®å·®å¼‚">
                        <i class="fa fa-exchange mr-2"></i>å¼€å§‹å¯¹æ¯”
                    </button>
                    <button id="exportResults" class="tech-button" title="å°†å¯¹æ¯”ç»“æœå¯¼å‡ºä¸ºExcelæ–‡ä»¶">
                        <i class="fa fa-download mr-2"></i>å¯¼å‡ºæŠ¥å‘Š
                    </button>
                </div>
            </div>
            
            <!-- å¯¹æ¯”è®¾ç½®é¢æ¿ -->
            <div class="data-card p-4 mb-6">
                <h2 class="text-xl font-semibold text-white mb-4">å¯¹æ¯”è®¾ç½®</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-white text-sm mb-2">
                            <i class="fa fa-key mr-1"></i>ä¸»é”®åˆ—
                            <span class="text-accent text-xs ml-1" title="ç”¨äºåŒ¹é…ä¸¤è¡Œæ•°æ®çš„å”¯ä¸€æ ‡è¯†åˆ—">?</span>
                        </label>
                        <select id="primaryKey" class="w-full rounded-lg border border-gray-300 bg-white bg-opacity-80 p-2 focus:outline-none focus:ring-2 focus:ring-accent" title="é€‰æ‹©ç”¨äºåŒ¹é…æ•°æ®è¡Œçš„å”¯ä¸€æ ‡è¯†åˆ—ï¼Œç•™ç©ºåˆ™è‡ªåŠ¨æ£€æµ‹">
                            <option value="">ğŸ¤– è‡ªåŠ¨æ£€æµ‹</option>
                            <option value="id">ID</option>
                            <option value="name">åç§°</option>
                            <option value="code">ä»£ç </option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-white text-sm mb-2">
                            <i class="fa fa-columns mr-1"></i>å¯¹æ¯”æ¨¡å¼
                            <span class="text-accent text-xs ml-1" title="é€‰æ‹©è¦å¯¹æ¯”çš„åˆ—èŒƒå›´">?</span>
                        </label>
                        <select id="compareMode" class="w-full rounded-lg border border-gray-300 bg-white bg-opacity-80 p-2 focus:outline-none focus:ring-2 focus:ring-accent" title="é€‰æ‹©è¦å¯¹æ¯”çš„åˆ—èŒƒå›´">
                            <option value="all">ğŸ“Š æ‰€æœ‰åˆ—</option>
                            <option value="selected">ğŸ¯ é€‰å®šåˆ—</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-white text-sm mb-2">
                            <i class="fa fa-paint-brush mr-1"></i>å·®å¼‚é«˜äº®æ–¹å¼
                            <span class="text-accent text-xs ml-1" title="è®¾ç½®å·®å¼‚æ•°æ®çš„æ˜¾ç¤ºæ ·å¼">?</span>
                        </label>
                        <select id="highlightMode" class="w-full rounded-lg border border-gray-300 bg-white bg-opacity-80 p-2 focus:outline-none focus:ring-2 focus:ring-accent" title="è®¾ç½®å·®å¼‚æ•°æ®çš„æ˜¾ç¤ºæ ·å¼">
                            <option value="background">ğŸ¨ èƒŒæ™¯è‰²</option>
                            <option value="text">âœï¸ æ–‡å­—é¢œè‰²</option>
                            <option value="border">ğŸ”² è¾¹æ¡†</option>
                        </select>
                    </div>
                </div>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºï¼šè¡¨æ ¼å¯¹æ¯”å’Œå·®å¼‚åˆ†æ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦ä¾§è¡¨æ ¼ -->
            <div class="lg:col-span-1 data-card p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white flex items-center">
                        <i class="fa fa-file-excel-o mr-2 text-green-300"></i>
                        è¡¨æ ¼ A <span class="text-xs text-white/60 ml-2">(åŸºå‡†æ•°æ®)</span>
                    </h2>
                    <div class="flex gap-2">
                        <input type="file" id="fileInputA" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleFileUpload(event, 'A')">
                        <button id="importTableA" class="tech-button py-1 px-3 text-sm" onclick="document.getElementById('fileInputA').click()" title="å¯¼å…¥Excelæˆ–CSVæ–‡ä»¶">
                            <i class="fa fa-upload mr-1"></i>å¯¼å…¥æ–‡ä»¶
                        </button>
                    </div>
                </div>
                <div class="relative overflow-x-auto scrollbar-thin max-h-[500px]">
                    <table id="tableA" class="w-full text-sm text-left text-gray-200">
                        <thead class="table-header">
                            <tr>
                                <th class="px-4 py-3">ID</th>
                                <th class="px-4 py-3">åç§°</th>
                                <th class="px-4 py-3">ç±»åˆ«</th>
                                <th class="px-4 py-3">ä»·æ ¼</th>
                                <th class="px-4 py-3">åº“å­˜</th>
                                <th class="px-4 py-3">é”€é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="px-4 py-8 text-center">
                                    <div class="text-gray-400 space-y-2">
                                        <i class="fa fa-info-circle text-2xl"></i>
                                        <p class="font-medium">å‡†å¤‡å°±ç»ª</p>
                                        <p class="text-sm">ğŸ¯ ç‚¹å‡»"å¯¼å…¥æ–‡ä»¶"ä¸Šä¼ æ‚¨çš„æ•°æ®</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- å³ä¾§è¡¨æ ¼ -->
            <div class="lg:col-span-1 data-card p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white flex items-center">
                        <i class="fa fa-file-excel-o mr-2 text-blue-300"></i>
                        è¡¨æ ¼ B <span class="text-xs text-white/60 ml-2">(å¯¹æ¯”æ•°æ®)</span>
                    </h2>
                    <div class="flex gap-2">
                        <input type="file" id="fileInputB" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleFileUpload(event, 'B')">
                        <button id="importTableB" class="tech-button py-1 px-3 text-sm" onclick="document.getElementById('fileInputB').click()" title="å¯¼å…¥Excelæˆ–CSVæ–‡ä»¶">
                            <i class="fa fa-upload mr-1"></i>å¯¼å…¥æ–‡ä»¶
                        </button>
                    </div>
                </div>
                <div class="relative overflow-x-auto scrollbar-thin max-h-[500px]">
                    <table id="tableB" class="w-full text-sm text-left text-gray-200">
                        <thead class="table-header">
                            <tr>
                                <th class="px-4 py-3">ID</th>
                                <th class="px-4 py-3">åç§°</th>
                                <th class="px-4 py-3">ç±»åˆ«</th>
                                <th class="px-4 py-3">ä»·æ ¼</th>
                                <th class="px-4 py-3">åº“å­˜</th>
                                <th class="px-4 py-3">é”€é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="px-4 py-8 text-center">
                                    <div class="text-gray-400 space-y-2">
                                        <i class="fa fa-info-circle text-2xl"></i>
                                        <p class="font-medium">å‡†å¤‡å°±ç»ª</p>
                                        <p class="text-sm">ğŸ¯ ç‚¹å‡»"å¯¼å…¥æ–‡ä»¶"ä¸Šä¼ æ‚¨çš„æ•°æ®</p>
                                     </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- å·®å¼‚åˆ†æé¢æ¿ -->
            <div class="lg:col-span-1 data-card p-4">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i class="fa fa-chart-bar mr-2 text-yellow-300"></i>
                    å·®å¼‚åˆ†æ <span class="text-xs text-white/60 ml-2">(æ™ºèƒ½å¯¹æ¯”ç»“æœ)</span>
                </h2>
                
                <!-- å·®å¼‚ç»Ÿè®¡å¡ç‰‡ -->
                <div class="bg-white bg-opacity-10 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-white mb-3">å·®å¼‚ç»Ÿè®¡</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-primary bg-opacity-50 rounded-lg p-3 text-center hover:bg-opacity-60 transition-all cursor-help" title="æ£€æµ‹åˆ°çš„æ€»å·®å¼‚æ•°é‡">
                            <p class="text-sm text-gray-300">ğŸ” æ€»å·®å¼‚æ•°</p>
                            <p id="totalDiffs" class="text-2xl font-bold text-accent">0</p>
                        </div>
                        <div class="bg-primary bg-opacity-50 rounded-lg p-3 text-center hover:bg-opacity-60 transition-all cursor-help" title="å­˜åœ¨å·®å¼‚çš„è¡Œæ•°å æ€»è¡Œæ•°çš„ç™¾åˆ†æ¯”">
                            <p class="text-sm text-gray-300">ğŸ“Š å·®å¼‚è¡Œæ¯”ä¾‹</p>
                            <p id="diffRowPercentage" class="text-2xl font-bold text-accent">0%</p>
                        </div>
                        <div class="bg-primary bg-opacity-50 rounded-lg p-3 text-center hover:bg-opacity-60 transition-all cursor-help" title="è¡¨æ ¼Bä¸­æ–°å¢çš„è®°å½•æ•°é‡">
                            <p class="text-sm text-gray-300">ğŸ“ˆ å¢åŠ é¡¹</p>
                            <p id="increaseCount" class="text-2xl font-bold text-diff-increase">0</p>
                        </div>
                        <div class="bg-primary bg-opacity-50 rounded-lg p-3 text-center hover:bg-opacity-60 transition-all cursor-help" title="è¡¨æ ¼Aä¸­æœ‰ä½†è¡¨æ ¼Bä¸­æ²¡æœ‰çš„è®°å½•æ•°é‡">
                            <p class="text-sm text-gray-300">ğŸ“‰ å‡å°‘é¡¹</p>
                            <p id="decreaseCount" class="text-2xl font-bold text-diff-decrease">0</p>
                        </div>
                    </div>
                </div>

                <!-- å·®å¼‚ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="bg-white bg-opacity-10 rounded-lg p-4">
                    <h3 class="text-lg font-medium text-white mb-3">å¯¹æ¯”çŠ¶æ€</h3>
                    <div id="diffSummary" class="text-sm text-gray-200">
                        <div class="text-center py-4">
                            <i class="fa fa-info-circle text-xl text-accent mb-2"></i>
                            <p class="font-medium text-white/90 mb-1">å‡†å¤‡å°±ç»ª</p>
                            <p class="text-white/70">ğŸ“Š è¯·å…ˆåŠ è½½ä¸¤ä¸ªè¡¨æ ¼çš„æ•°æ®</p>
                            <p class="text-white/70">âš¡ ç„¶åç‚¹å‡»"å¼€å§‹å¯¹æ¯”"æŒ‰é’®ç”Ÿæˆåˆ†ææŠ¥å‘Š</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å·®å¼‚è¯¦æƒ…é¢æ¿ -->
        <div class="mt-8 data-card p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-white flex items-center">
                    <i class="fa fa-list-alt mr-2 text-yellow-300"></i>
                    å·®å¼‚è¯¦æƒ… <span class="text-xs text-white/60 ml-2">(è¯¦ç»†å¯¹æ¯”ç»“æœ)</span>
                </h2>
                <div class="flex gap-2">
                    <select id="diffFilter" class="rounded-lg border border-gray-300 bg-white bg-opacity-80 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent" title="ç­›é€‰ä¸åŒç±»å‹çš„å·®å¼‚">
                        <option value="all">ğŸ” æ‰€æœ‰å·®å¼‚</option>
                        <option value="increase">ğŸ“ˆ ä»…å¢åŠ </option>
                        <option value="decrease">ğŸ“‰ ä»…å‡å°‘</option>
                        <option value="change">ğŸ”„ ä»…å˜åŒ–</option>
                    </select>
                    <select id="sortBy" class="rounded-lg border border-gray-300 bg-white bg-opacity-80 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent" title="é€‰æ‹©æ’åºæ–¹å¼">
                        <option value="id">ğŸ†” æŒ‰IDæ’åº</option>
                        <option value="name">ğŸ“ æŒ‰åç§°æ’åº</option>
                        <option value="diffValue">ğŸ“Š æŒ‰å·®å¼‚å€¼æ’åº</option>
                        <option value="diffPercentage">ğŸ“ˆ æŒ‰å·®å¼‚ç™¾åˆ†æ¯”æ’åº</option>
                    </select>
                </div>
            </div>
            <div class="relative overflow-x-auto scrollbar-thin mb-4">
                <table id="diffTable" class="w-full text-sm text-left text-gray-200">
                    <thead class="table-header">
                        <tr>
                            <th class="px-4 py-3">ID</th>
                            <th class="px-4 py-3">åç§°</th>
                            <th class="px-4 py-3">å­—æ®µ</th>
                            <th class="px-4 py-3">è¡¨æ ¼Aå€¼</th>
                            <th class="px-4 py-3">è¡¨æ ¼Bå€¼</th>
                            <th class="px-4 py-3">å·®å¼‚å€¼</th>
                            <th class="px-4 py-3">å·®å¼‚ç™¾åˆ†æ¯”</th>
                            <th class="px-4 py-3">å·®å¼‚ç±»å‹</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="8" class="px-4 py-8 text-center">
                                <div class="text-gray-400 space-y-3">
                                    <i class="fa fa-search text-3xl"></i>
                                    <p class="font-medium text-white/80">ç­‰å¾…åˆ†æç»“æœ</p>
                                    <p class="text-sm text-white/60">ğŸ“Š å®Œæˆæ•°æ®å¯¹æ¯”åå°†æ˜¾ç¤ºè¯¦ç»†å·®å¼‚</p>
                                    <p class="text-sm text-white/60">âš¡ æ”¯æŒç­›é€‰å’Œæ’åºåŠŸèƒ½</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†é¡µæ§ä»¶ -->
            <div id="paginationControls" class="flex items-center justify-between bg-white/10 rounded-lg p-3 hidden">
                <div class="text-sm text-white/80">
                    æ˜¾ç¤º <span id="startRange">1</span> - <span id="endRange">20</span> æ¡ï¼Œå…± <span id="totalItems">0</span> æ¡å·®å¼‚
                </div>
                <div class="flex items-center gap-3">
                    <button id="firstPage" class="tech-button py-1 px-3 text-sm bg-white/10 hover:bg-white/20" disabled title="ç¬¬ä¸€é¡µ">
                        <i class="fa fa-step-backward"></i>
                    </button>
                    <button id="prevPage" class="tech-button py-1 px-3 text-sm bg-white/10 hover:bg-white/20" disabled title="ä¸Šä¸€é¡µ">
                        <i class="fa fa-chevron-left"></i>
                    </button>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-white/80">ç¬¬</span>
                        <span id="currentPageDisplay" class="text-sm font-medium text-white">1</span>
                        <span class="text-sm text-white/80">é¡µï¼Œå…±</span>
                        <span id="totalPagesDisplay" class="text-sm font-medium text-white">1</span>
                        <span class="text-sm text-white/80">é¡µ</span>
                    </div>
                    <button id="nextPage" class="tech-button py-1 px-3 text-sm bg-white/10 hover:bg-white/20" disabled title="ä¸‹ä¸€é¡µ">
                        <i class="fa fa-chevron-right"></i>
                    </button>
                    <button id="lastPage" class="tech-button py-1 px-3 text-sm bg-white/10 hover:bg-white/20" disabled title="æœ€åä¸€é¡µ">
                        <i class="fa fa-step-forward"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-white/80">æ¯é¡µæ˜¾ç¤º:</span>
                    <select id="pageSize" class="rounded-lg border border-gray-300 bg-white bg-opacity-80 p-1 text-sm focus:outline-none focus:ring-2 focus:ring-accent" title="æ¯é¡µæ˜¾ç¤ºæ¡æ•°">
                        <option value="10">10æ¡</option>
                        <option value="20" selected>20æ¡</option>
                        <option value="50">50æ¡</option>
                        <option value="100">100æ¡</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let tableAData = [];
        let tableBData = [];
        let diffData = [];
        let currentPage = 1;
        let itemsPerPage = 20; // é»˜è®¤æ¯é¡µæ˜¾ç¤º20æ¡

        // DOM å…ƒç´ 
        const tableA = document.getElementById('tableA');
        const tableB = document.getElementById('tableB');
        const diffTable = document.getElementById('diffTable');
        const diffSummary = document.getElementById('diffSummary');
        const totalDiffsEl = document.getElementById('totalDiffs');
        const diffRowPercentageEl = document.getElementById('diffRowPercentage');
        const increaseCountEl = document.getElementById('increaseCount');
        const decreaseCountEl = document.getElementById('decreaseCount');
        const compareTablesBtn = document.getElementById('compareTables');
        const exportResultsBtn = document.getElementById('exportResults');
        const diffFilter = document.getElementById('diffFilter');
        const sortBy = document.getElementById('sortBy');
        const highlightMode = document.getElementById('highlightMode');
        const primaryKey = document.getElementById('primaryKey');
        const paginationControls = document.getElementById('paginationControls');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const firstPageBtn = document.getElementById('firstPage');
        const lastPageBtn = document.getElementById('lastPage');
        const pageSizeSelect = document.getElementById('pageSize');
        const startRangeEl = document.getElementById('startRange');
        const endRangeEl = document.getElementById('endRange');
        const totalItemsEl = document.getElementById('totalItems');
        const currentPageDisplay = document.getElementById('currentPageDisplay');
        const totalPagesDisplay = document.getElementById('totalPagesDisplay');



        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            console.log('æ•°æ®è¡¨æ ¼å¯¹æ¯”åˆ†æå·¥å…·åˆå§‹åŒ–ä¸­...');
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            bindEventListeners();
            
            console.log('åˆå§‹åŒ–å®Œæˆï¼');
        }

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        function bindEventListeners() {
            // å¯¹æ¯”æ•°æ®æŒ‰é’®
            if (compareTablesBtn) {
                compareTablesBtn.addEventListener('click', compareTables);
                console.log('å¯¹æ¯”æ•°æ®æŒ‰é’®äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }

            // å¯¼å‡ºç»“æœæŒ‰é’®
            if (exportResultsBtn) {
                exportResultsBtn.addEventListener('click', exportResults);
                console.log('å¯¼å‡ºç»“æœæŒ‰é’®äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }

            // å·®å¼‚è¿‡æ»¤å’Œæ’åº
            if (diffFilter) {
                diffFilter.addEventListener('change', () => {
                    currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                    updateDiffTable();
                });
                console.log('å·®å¼‚è¿‡æ»¤äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }
            
            if (sortBy) {
                sortBy.addEventListener('change', () => {
                    currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                    updateDiffTable();
                });
                console.log('æ’åºæ–¹å¼äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }
            
            // åˆ†é¡µæ§ä»¶äº‹ä»¶ç»‘å®š
            if (prevPageBtn && nextPageBtn) {
                prevPageBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        changePage(currentPage - 1);
                    }
                });
                
                nextPageBtn.addEventListener('click', () => {
                    const filteredData = getFilteredData();
                    const totalPages = Math.ceil(filteredData.length / itemsPerPage);
                    if (currentPage < totalPages) {
                        changePage(currentPage + 1);
                    }
                });
                
                // ç¬¬ä¸€é¡µå’Œæœ€åä¸€é¡µæŒ‰é’®
                if (firstPageBtn) {
                    firstPageBtn.addEventListener('click', () => {
                        changePage(1);
                    });
                }
                
                if (lastPageBtn) {
                    lastPageBtn.addEventListener('click', () => {
                        const filteredData = getFilteredData();
                        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
                        changePage(totalPages);
                    });
                }
                console.log('åˆ†é¡µæŒ‰é’®äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }
            
            // æ¯é¡µæ˜¾ç¤ºæ¡æ•°äº‹ä»¶ç»‘å®š
            if (pageSizeSelect) {
                pageSizeSelect.addEventListener('change', (e) => {
                    itemsPerPage = parseInt(e.target.value);
                    currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                    updateDiffTable();
                });
                console.log('æ¯é¡µæ˜¾ç¤ºæ¡æ•°äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }

            // é«˜äº®æ–¹å¼
            if (highlightMode) {
                highlightMode.addEventListener('change', updateHighlightMode);
                console.log('é«˜äº®æ–¹å¼äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }

            // è¡¨æ ¼åŒæ­¥æ»šåŠ¨
            const tableAContainer = tableA.parentElement;
            const tableBContainer = tableB.parentElement;
            
            if (tableAContainer && tableBContainer) {
                tableAContainer.addEventListener('scroll', () => {
                    tableBContainer.scrollLeft = tableAContainer.scrollLeft;
                });
                
                tableBContainer.addEventListener('scroll', () => {
                    tableAContainer.scrollLeft = tableBContainer.scrollLeft;
                });
                console.log('è¡¨æ ¼åŒæ­¥æ»šåŠ¨äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }
        }

        // åŠ è½½ç¤ºä¾‹æ•°æ®
        function loadSampleData(tableType) {
            console.log(`å¼€å§‹åŠ è½½${tableType === 'A' ? 'è¡¨æ ¼A' : 'è¡¨æ ¼B'}ç¤ºä¾‹æ•°æ®...`);
            
            const tableElement = tableType === 'A' ? tableA : tableB;
            const tbody = tableElement.querySelector('tbody');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-300">æ­£åœ¨ç”Ÿæˆç¤ºä¾‹æ•°æ®ï¼Œè¯·ç¨å€™...</td></tr>';
            
            // æ¨¡æ‹ŸåŠ è½½å»¶è¿Ÿ
            setTimeout(() => {
                try {
                    let data;
                    
                    if (tableType === 'A') {
                        // è¡¨æ ¼Aï¼šåŸå§‹æ•°æ®
                        data = sampleProducts.map(product => ({ ...product }));
                        tableAData = data;
                    } else {
                        // è¡¨æ ¼Bï¼šå¸¦å·®å¼‚çš„æ•°æ®
                        data = sampleProducts.map(product => {
                            const newProduct = { ...product };
                            
                            // æ·»åŠ éšæœºå·®å¼‚
                            newProduct.price = Math.floor(newProduct.price * (1 + (Math.random() - 0.5) * 0.3));
                            newProduct.stock = Math.floor(newProduct.stock * (1 + (Math.random() - 0.5) * 0.5));
                            newProduct.sales = Math.floor(newProduct.sales * (1 + (Math.random() - 0.5) * 0.4));
                            
                            // æ·»åŠ ç‰¹æ®Šå·®å¼‚
                            if (product.id % 3 === 0) {
                                newProduct.stock = 0; // åº“å­˜ä¸º0
                            }
                            if (product.id % 4 === 0) {
                                newProduct.discount = Math.floor(Math.random() * 30 + 10); // æ–°å¢æŠ˜æ‰£å­—æ®µ
                            }
                            
                            return newProduct;
                        });
                        tableBData = data;
                    }
                    
                    // æ¸²æŸ“è¡¨æ ¼
                    renderTable(tableElement, data);
                    
                    console.log(`${tableType === 'A' ? 'è¡¨æ ¼A' : 'è¡¨æ ¼B'}ç¤ºä¾‹æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±${data.length}æ¡è®°å½•`);
                    
                    // æ›´æ–°çŠ¶æ€æç¤º
                    updateStatusMessage();
                    
                    // è‡ªåŠ¨å¯¹æ¯”ï¼ˆå¦‚æœä¸¤ä¸ªè¡¨æ ¼éƒ½æœ‰æ•°æ®ï¼‰
                    if (tableAData.length > 0 && tableBData.length > 0) {
                        console.log('ä¸¤ä¸ªè¡¨æ ¼éƒ½æœ‰æ•°æ®ï¼Œè‡ªåŠ¨è¿›è¡Œå¯¹æ¯”åˆ†æ...');
                        setTimeout(() => {
                            compareTables();
                        }, 500);
                    }
                    
                } catch (error) {
                    console.error('ç¤ºä¾‹æ•°æ®åŠ è½½å¤±è´¥:', error);
                    tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-red-300">æ•°æ®åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
                }
            }, 800);
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event, tableType) {
            console.log(`å¼€å§‹å¤„ç†${tableType === 'A' ? 'è¡¨æ ¼A' : 'è¡¨æ ¼B'}æ–‡ä»¶ä¸Šä¼ ...`);
            
            const file = event.target.files[0];
            if (!file) {
                console.log('æœªé€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            const tableElement = tableType === 'A' ? tableA : tableB;
            const tbody = tableElement.querySelector('tbody');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-300">æ­£åœ¨è§£ææ–‡ä»¶ "${file.name}"ï¼Œè¯·ç¨å€™...</td></tr>`;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let jsonData;
                    
                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    
                    if (fileExtension === 'csv') {
                        // CSVæ–‡ä»¶ä½¿ç”¨åŸç”Ÿè§£æ
                        jsonData = parseCSV(e.target.result);
                    } else if (['xlsx', 'xls'].includes(fileExtension)) {
                        // Excelæ–‡ä»¶ä½¿ç”¨XLSXåº“
                        if (typeof XLSX !== 'undefined') {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            jsonData = XLSX.utils.sheet_to_json(worksheet);
                        } else {
                            throw new Error('Excelæ–‡ä»¶éœ€è¦XLSXåº“ï¼Œè¯·ä½¿ç”¨CSVæ–‡ä»¶æˆ–åˆ·æ–°é¡µé¢é‡è¯•');
                        }
                    } else {
                        throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·é€‰æ‹©Excelæˆ–CSVæ–‡ä»¶');
                    }
                    
                    if (!jsonData || jsonData.length === 0) {
                        throw new Error('æ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®');
                    }
                    
                    console.log(`æˆåŠŸè§£ææ–‡ä»¶ï¼Œå…±${jsonData.length}æ¡è®°å½•`);
                    
                    // æ ‡å‡†åŒ–æ•°æ®æ ¼å¼
                    const normalizedData = normalizeData(jsonData);
                    
                    // ä¿å­˜æ•°æ®
                    if (tableType === 'A') {
                        tableAData = normalizedData;
                    } else {
                        tableBData = normalizedData;
                    }
                    
                    // æ¸²æŸ“è¡¨æ ¼
                    renderTable(tableElement, normalizedData);
                    
                    // æ›´æ–°çŠ¶æ€æç¤º
                    updateStatusMessage();
                    
                    // è‡ªåŠ¨å¯¹æ¯”ï¼ˆå¦‚æœä¸¤ä¸ªè¡¨æ ¼éƒ½æœ‰æ•°æ®ï¼‰
                    if (tableAData.length > 0 && tableBData.length > 0) {
                        console.log('ä¸¤ä¸ªè¡¨æ ¼éƒ½æœ‰æ•°æ®ï¼Œè‡ªåŠ¨è¿›è¡Œå¯¹æ¯”åˆ†æ...');
                        setTimeout(() => {
                            compareTables();
                        }, 500);
                    }
                    
                } catch (error) {
                    console.error('æ–‡ä»¶è§£æå¤±è´¥:', error);
                    let errorMessage = 'æ–‡ä»¶è§£æå¤±è´¥';
                    
                    if (error.message.includes('Unsupported file format')) {
                        errorMessage = 'ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·é€‰æ‹©Excelæˆ–CSVæ–‡ä»¶';
                    } else if (error.message.includes('Corrupt file')) {
                        errorMessage = 'æ–‡ä»¶å·²æŸåï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§';
                    } else if (error.message.includes('XLSXåº“')) {
                        errorMessage = 'Excelè§£æåº“æœªåŠ è½½ï¼Œè¯·ä½¿ç”¨CSVæ–‡ä»¶æ ¼å¼';
                    } else {
                        errorMessage = `æ–‡ä»¶è§£æå¤±è´¥: ${error.message}`;
                    }
                    
                    tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-red-300">${errorMessage}</td></tr>`;
                }
            };
            
            reader.onerror = function(error) {
                console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-red-300">æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>';
            };
            
            // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©è¯»å–æ–¹å¼
            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsArrayBuffer(file);
            }
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡æ–°é€‰æ‹©åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }

        // åŸç”ŸCSVè§£æå‡½æ•°
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) {
                throw new Error('CSVæ–‡ä»¶è‡³å°‘éœ€è¦åŒ…å«è¡¨å¤´å’Œä¸€è¡Œæ•°æ®');
            }
            
            // è§£æè¡¨å¤´
            const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
            
            // è§£ææ•°æ®è¡Œ
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === 0) continue;
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] !== undefined ? values[index] : '';
                });
                data.push(row);
            }
            
            return data;
        }

        // è§£æCSVè¡Œï¼ˆå¤„ç†å¼•å·å’Œé€—å·ï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        // å¤„ç†è½¬ä¹‰å¼•å·
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // æ ‡å‡†åŒ–æ•°æ®æ ¼å¼
        function normalizeData(data) {
            return data.map((row, index) => {
                const normalizedRow = {};
                
                // æ ‡å‡†åŒ–å¸¸è§å­—æ®µå
                Object.keys(row).forEach(key => {
                    const normalizedKey = key.toLowerCase().trim();
                    let value = row[key];
                    
                    // å°è¯•è½¬æ¢æ•°å€¼
                    if (typeof value === 'string' && !isNaN(value) && value.trim() !== '') {
                        value = parseFloat(value);
                    }
                    
                    // æ˜ å°„å¸¸è§å­—æ®µå
                    if (normalizedKey.includes('id') || normalizedKey.includes('ç¼–å·')) {
                        normalizedRow.id = value || index + 1;
                    } else if (normalizedKey.includes('name') || normalizedKey.includes('åç§°') || normalizedKey.includes('äº§å“')) {
                        normalizedRow.name = value || `é¡¹ç›®${index + 1}`;
                    } else if (normalizedKey.includes('price') || normalizedKey.includes('ä»·æ ¼') || normalizedKey.includes('å•ä»·')) {
                        normalizedRow.price = value || 0;
                    } else if (normalizedKey.includes('stock') || normalizedKey.includes('åº“å­˜') || normalizedKey.includes('æ•°é‡')) {
                        normalizedRow.stock = value || 0;
                    } else if (normalizedKey.includes('sales') || normalizedKey.includes('é”€é‡') || normalizedKey.includes('é”€å”®')) {
                        normalizedRow.sales = value || 0;
                    } else if (normalizedKey.includes('category') || normalizedKey.includes('ç±»åˆ«') || normalizedKey.includes('åˆ†ç±»')) {
                        normalizedRow.category = value || 'æœªåˆ†ç±»';
                    } else {
                        // ä¿ç•™åŸå§‹å­—æ®µ
                        normalizedRow[key] = value;
                    }
                });
                
                // ç¡®ä¿æœ‰IDå’Œåç§°
                if (!normalizedRow.id) normalizedRow.id = index + 1;
                if (!normalizedRow.name) normalizedRow.name = `é¡¹ç›®${index + 1}`;
                
                return normalizedRow;
            });
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable(tableElement, data) {
            const thead = tableElement.querySelector('thead');
            const tbody = tableElement.querySelector('tbody');
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                thead.innerHTML = '<tr><th class="px-4 py-3">æš‚æ— æ•°æ®</th></tr>';
                tbody.innerHTML = '<tr><td colspan="1" class="px-4 py-8 text-center text-gray-400 italic">æš‚æ— æ•°æ®</td></tr>';
                return;
            }
            
            // è·å–æ‰€æœ‰å­—æ®µå
            const allFields = [...new Set(data.flatMap(row => Object.keys(row)))];
            
            // æ›´æ–°è¡¨å¤´
            thead.innerHTML = '';
            const headerRow = document.createElement('tr');
            allFields.forEach(field => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3';
                th.textContent = formatFieldName(field);
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            // æ›´æ–°ä¸»é”®åˆ—é€‰é¡¹å’Œæ’åºé€‰é¡¹
            updatePrimaryKeyOptions(allFields);
            updateSortOptions(allFields);
            
            // æ¸²æŸ“æ•°æ®è¡Œï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
            const fragment = document.createDocumentFragment();
            data.forEach(rowData => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-white hover:bg-opacity-10 transition-colors';
                
                allFields.forEach(field => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-3';
                    td.setAttribute('data-field', field);
                    const value = rowData[field] !== undefined ? rowData[field] : '';
                    td.textContent = formatCellValue(value, field);
                    row.appendChild(td);
                });
                
                fragment.appendChild(row);
            });
            tbody.appendChild(fragment);
        }

        // æ›´æ–°ä¸»é”®åˆ—é€‰é¡¹
        function updatePrimaryKeyOptions(fields) {
            const primaryKeySelect = document.getElementById('primaryKey');
            if (!primaryKeySelect) return;
            
            // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
            const currentValue = primaryKeySelect.value;
            
            // æ¸…é™¤ç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"è‡ªåŠ¨æ£€æµ‹"ï¼‰
            primaryKeySelect.innerHTML = '<option value="">è‡ªåŠ¨æ£€æµ‹</option>';
            
            // æ·»åŠ æ–°çš„å­—æ®µé€‰é¡¹
            fields.forEach(field => {
                // è·³è¿‡ä¸€äº›ä¸é€‚åˆä½œä¸ºä¸»é”®çš„å­—æ®µ
                if (field.toLowerCase().includes('å¤‡æ³¨') || 
                    field.toLowerCase().includes('è¯´æ˜') ||
                    field.toLowerCase().includes('æè¿°') ||
                    field.length > 20) {
                    return;
                }
                
                const option = document.createElement('option');
                option.value = field;
                option.textContent = formatFieldName(field);
                primaryKeySelect.appendChild(option);
            });
            
            // æ¢å¤ä¹‹å‰çš„é€‰æ‹©ï¼ˆå¦‚æœä»ç„¶å¯ç”¨ï¼‰
            if (currentValue && Array.from(primaryKeySelect.options).some(opt => opt.value === currentValue)) {
                primaryKeySelect.value = currentValue;
            }
        }

        // æ›´æ–°æ’åºé€‰é¡¹
        function updateSortOptions(fields) {
            const sortBySelect = document.getElementById('sortBy');
            if (!sortBySelect) return;
            
            // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
            const currentValue = sortBySelect.value;
            
            // ä¿ç•™åŸºç¡€æ’åºé€‰é¡¹
            sortBySelect.innerHTML = `
                <option value="id">æŒ‰IDæ’åº</option>
                <option value="name">æŒ‰åç§°æ’åº</option>
                <option value="diffValue">æŒ‰å·®å¼‚å€¼æ’åº</option>
                <option value="diffPercentage">æŒ‰å·®å¼‚ç™¾åˆ†æ¯”æ’åº</option>
            `;
            
            // æ·»åŠ å­—æ®µæ’åºé€‰é¡¹
            fields.forEach(field => {
                // è·³è¿‡ä¸é€‚åˆæ’åºçš„å­—æ®µ
                if (typeof tableAData[0]?.[field] === 'string' && 
                    tableAData[0]?.[field].length > 50) {
                    return;
                }
                
                const option = document.createElement('option');
                option.value = field;
                option.textContent = `æŒ‰${formatFieldName(field)}æ’åº`;
                sortBySelect.appendChild(option);
            });
            
            // æ¢å¤ä¹‹å‰çš„é€‰æ‹©ï¼ˆå¦‚æœä»ç„¶å¯ç”¨ï¼‰
            if (currentValue && Array.from(sortBySelect.options).some(opt => opt.value === currentValue)) {
                sortBySelect.value = currentValue;
            }
        }

        // æ ¼å¼åŒ–å•å…ƒæ ¼å€¼
        function formatCellValue(value, field) {
            if (value === null || value === undefined) return '';
            
            // æ•°å€¼æ ¼å¼åŒ–
            if (typeof value === 'number') {
                if (field.toLowerCase().includes('price') || field.toLowerCase().includes('ä»·æ ¼')) {
                    return `Â¥${value.toLocaleString()}`;
                } else if (field.toLowerCase().includes('percent') || field.toLowerCase().includes('ç™¾åˆ†æ¯”')) {
                    return `${value.toFixed(1)}%`;
                } else {
                    return value.toLocaleString();
                }
            }
            
            // æ—¥æœŸæ ¼å¼åŒ–
            if (value instanceof Date || (typeof value === 'string' && !isNaN(Date.parse(value)))) {
                const date = new Date(value);
                return date.toLocaleDateString('zh-CN');
            }
            
            // å­—ç¬¦ä¸²æˆªæ–­
            if (typeof value === 'string' && value.length > 50) {
                return value.substring(0, 50) + '...';
            }
            
            return value;
        }

        // æ›´æ–°çŠ¶æ€æ¶ˆæ¯
        function updateStatusMessage() {
            const statusText = tableAData.length > 0 && tableBData.length > 0 
                ? 'ä¸¤ä¸ªè¡¨æ ¼æ•°æ®å·²å°±ç»ªï¼Œç‚¹å‡»"å¯¹æ¯”æ•°æ®"æŒ‰é’®å¼€å§‹åˆ†æ'
                : tableAData.length > 0 
                    ? 'è¡¨æ ¼Aæ•°æ®å·²åŠ è½½ï¼Œè¯·åŠ è½½è¡¨æ ¼Bæ•°æ®'
                    : 'è¡¨æ ¼Bæ•°æ®å·²åŠ è½½ï¼Œè¯·åŠ è½½è¡¨æ ¼Aæ•°æ®';
            
            diffSummary.innerHTML = `<p class="text-blue-300">${statusText}</p>`;
        }

        // å¯¹æ¯”è¡¨æ ¼æ•°æ®
        function compareTables() {
            console.log('å¼€å§‹å¯¹æ¯”è¡¨æ ¼æ•°æ®...');
            
            if (tableAData.length === 0 || tableBData.length === 0) {
                diffSummary.innerHTML = '<p class="text-red-300">è¯·å…ˆåŠ è½½ä¸¤ä¸ªè¡¨æ ¼çš„æ•°æ®</p>';
                return;
            }
            
            // æ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
            diffSummary.innerHTML = '<p class="text-accent font-medium">ğŸ¤– æ­£åœ¨è¿›è¡Œæ•°æ®å¯¹æ¯”åˆ†æï¼Œè¯·ç¨å€™...</p>';
            
            // è®°å½•å¼€å§‹æ—¶é—´
            const startTime = Date.now();
            
            try {
                // æ¸…ç©ºä¹‹å‰çš„å·®å¼‚æ•°æ®
                diffData = [];
                
                // è·å–ä¸»é”®åˆ—ï¼ˆæ™ºèƒ½æ£€æµ‹æˆ–ç”¨æˆ·æŒ‡å®šï¼‰
                let primaryKeyField;
                if (primaryKey.value === '') {
                    // è‡ªåŠ¨æ£€æµ‹ä¸»é”®
                    primaryKeyField = detectPrimaryKey();
                    console.log(`è‡ªåŠ¨æ£€æµ‹åˆ°ä¸»é”®åˆ—: ${primaryKeyField}`);
                    
                    // æ˜¾ç¤ºè‡ªåŠ¨æ£€æµ‹ç»“æœç»™ç”¨æˆ·
                    const primaryKeyContainer = primaryKey.parentElement;
                    let autoDetectInfo = primaryKeyContainer.querySelector('.auto-detect-info');
                    if (!autoDetectInfo) {
                        autoDetectInfo = document.createElement('div');
                        autoDetectInfo.className = 'auto-detect-info text-sm mt-1';
                        primaryKeyContainer.appendChild(autoDetectInfo);
                    }
                    autoDetectInfo.innerHTML = `<span class="text-green-600">ğŸ¤– è‡ªåŠ¨æ£€æµ‹åˆ°ä¸»é”®: ${primaryKeyField}</span>`;
                } else {
                    // ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„ä¸»é”®
                    primaryKeyField = primaryKey.value;
                    console.log(`ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„ä¸»é”®åˆ—: ${primaryKeyField}`);
                    
                    // æ¸…é™¤è‡ªåŠ¨æ£€æµ‹æç¤º
                    const primaryKeyContainer = primaryKey.parentElement;
                    const autoDetectInfo = primaryKeyContainer.querySelector('.auto-detect-info');
                    if (autoDetectInfo) {
                        autoDetectInfo.remove();
                    }
                }
                
                // æŒ‰ä¸»é”®å¯¹æ¯”æ•°æ®ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
                const mapA = new Map();
                const mapB = new Map();
                const tempDiffData = [];
                
                // æ„å»ºæ˜ å°„ï¼Œå¤„ç†å¯èƒ½çš„é‡å¤é”®
                tableAData.forEach((item, index) => {
                    const key = getRecordKey(item, primaryKeyField);
                    mapA.set(key, item); // ç›´æ¥è¦†ç›–ï¼Œä¿ç•™æœ€åä¸€ä¸ªå€¼
                });
                
                tableBData.forEach((item, index) => {
                    const key = getRecordKey(item, primaryKeyField);
                    mapB.set(key, item); // ç›´æ¥è¦†ç›–ï¼Œä¿ç•™æœ€åä¸€ä¸ªå€¼
                });
                
                // æ‰¾å‡ºæ‰€æœ‰å”¯ä¸€çš„ä¸»é”®
                const keysA = new Set(mapA.keys());
                const keysB = new Set(mapB.keys());
                const allKeys = [...new Set([...keysA, ...keysB])];
                console.log(`æ€»è®°å½•æ•°: ${allKeys.length}`);
                
                // å¯¹æ¯”æ¯ä¸€è¡Œæ•°æ®
                for (const key of allKeys) {
                    const itemA = mapA.get(key);
                    const itemB = mapB.get(key);
                    
                    if (!itemA) {
                        // ä»…åœ¨è¡¨æ ¼Bä¸­å­˜åœ¨ - æ–°å¢é¡¹
                        tempDiffData.push({
                            id: key,
                            name: itemB.name || `é¡¹ç›®${key}`,
                            field: 'æ•´è¡Œ',
                            valueA: 'ä¸å­˜åœ¨',
                            valueB: 'æ–°å¢',
                            diffValue: 'æ–°å¢',
                            diffPercentage: 'N/A',
                            diffType: 'increase'
                        });
                    } else if (!itemB) {
                        // ä»…åœ¨è¡¨æ ¼Aä¸­å­˜åœ¨ - åˆ é™¤é¡¹
                        tempDiffData.push({
                            id: key,
                            name: itemA.name || `é¡¹ç›®${key}`,
                            field: 'æ•´è¡Œ',
                            valueA: 'å­˜åœ¨',
                            valueB: 'åˆ é™¤',
                            diffValue: 'åˆ é™¤',
                            diffPercentage: 'N/A',
                            diffType: 'decrease'
                        });
                    } else {
                        // ä¸¤è¡Œéƒ½å­˜åœ¨ï¼Œå¯¹æ¯”å„ä¸ªå­—æ®µ
                        const fieldsA = Object.keys(itemA);
                        const fieldsB = Object.keys(itemB);
                        const allFields = new Set([...fieldsA, ...fieldsB]);
                        
                        for (const field of allFields) {
                            // è·³è¿‡ä¸»é”®å­—æ®µï¼Œä½†ä¸è·³è¿‡åç§°å­—æ®µ
                            if (field === primaryKeyField) continue;
                            
                            const valueA = itemA[field] !== undefined && itemA[field] !== null ? itemA[field] : 'N/A';
                            const valueB = itemB[field] !== undefined && itemB[field] !== null ? itemB[field] : 'N/A';
                            
                            // å¿«é€Ÿæ¯”è¾ƒå€¼
                            if (valueA !== valueB) {
                                let diffValue = 'å˜åŒ–';
                                let diffPercentage = 'N/A';
                                let diffType = 'change';
                                
                                // è®¡ç®—æ•°å€¼å·®å¼‚
                                if (typeof valueA === 'number' && typeof valueB === 'number') {
                                    diffValue = valueB - valueA;
                                    diffPercentage = valueA !== 0 ? ((diffValue / valueA) * 100).toFixed(1) + '%' : 'âˆ';
                                    diffType = diffValue > 0 ? 'increase' : diffValue < 0 ? 'decrease' : 'change';
                                }
                                
                                tempDiffData.push({
                                    id: key,
                                    name: itemA.name || itemB.name || `é¡¹ç›®${key}`,
                                    field: formatFieldName(field),
                                    valueA: valueA,
                                    valueB: valueB,
                                    diffValue: diffValue,
                                    diffPercentage: diffPercentage,
                                    diffType: diffType
                                });
                            }
                        }
                    }
                }
                
                // æ‰¹é‡èµ‹å€¼ï¼Œå‡å°‘å†…å­˜æ“ä½œ
                diffData = tempDiffData;
                
                // æ›´æ–°å·®å¼‚ç»Ÿè®¡
                updateDiffStats();
                
                // é‡ç½®åˆ†é¡µå¹¶æ›´æ–°å·®å¼‚è¡¨æ ¼
                currentPage = 1;
                updateDiffTable();
                
                // æ›´æ–°å·®å¼‚æ‘˜è¦
                updateDiffSummary();
                
                const endTime = Date.now();
                console.log(`å¯¹æ¯”å®Œæˆï¼Œå‘ç°${diffData.length}ä¸ªå·®å¼‚ï¼Œè€—æ—¶${endTime - startTime}ms`);
                
            } catch (error) {
                console.error('å¯¹æ¯”åˆ†æå¤±è´¥:', error);
                diffSummary.innerHTML = `<p class="text-red-300">å¯¹æ¯”åˆ†æå¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // æ·±åº¦æ¯”è¾ƒä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰
        function valuesEqual(value1, value2) {
            // å¤„ç†nullå’Œundefined
            if (value1 === null || value1 === undefined) {
                return value2 === null || value2 === undefined;
            }
            if (value2 === null || value2 === undefined) {
                return false;
            }
            
            // å¤„ç†ä¸åŒç±»å‹
            if (typeof value1 !== typeof value2) {
                // å°è¯•æ•°å€¼è½¬æ¢æ¯”è¾ƒ
                if (typeof value1 === 'number' && typeof value2 === 'string') {
                    const num2 = parseFloat(value2);
                    return !isNaN(num2) && value1 === num2;
                }
                if (typeof value1 === 'string' && typeof value2 === 'number') {
                    const num1 = parseFloat(value1);
                    return !isNaN(num1) && num1 === value2;
                }
                return false;
            }
            
            // å¤„ç†æ•°ç»„
            if (Array.isArray(value1) && Array.isArray(value2)) {
                if (value1.length !== value2.length) return false;
                return value1.every((item, index) => valuesEqual(item, value2[index]));
            }
            
            // å¤„ç†å¯¹è±¡
            if (typeof value1 === 'object' && typeof value2 === 'object') {
                const keys1 = Object.keys(value1);
                const keys2 = Object.keys(value2);
                
                if (keys1.length !== keys2.length) return false;
                
                return keys1.every(key => 
                    keys2.includes(key) && valuesEqual(value1[key], value2[key])
                );
            }
            
            // å¤„ç†å­—ç¬¦ä¸²ï¼ˆå¿½ç•¥é¦–å°¾ç©ºæ ¼ï¼‰
            if (typeof value1 === 'string' && typeof value2 === 'string') {
                return value1.trim().toLowerCase() === value2.trim().toLowerCase();
            }
            
            // å¤„ç†æ•°å€¼ï¼ˆå…è®¸ä¸€å®šçš„ç²¾åº¦è¯¯å·®ï¼‰
            if (typeof value1 === 'number' && typeof value2 === 'number') {
                if (isNaN(value1) && isNaN(value2)) return true;
                return Math.abs(value1 - value2) < 1e-10;
            }
            
            // å…¶ä»–ç±»å‹ç›´æ¥æ¯”è¾ƒ
            return value1 === value2;
        }

        // æ›´æ–°å·®å¼‚ç»Ÿè®¡
        function updateDiffStats() {
            const totalDiffs = diffData.length;
            const totalRows = Math.max(tableAData.length, tableBData.length);
            const diffRowPercentage = totalRows > 0 ? Math.round((new Set(diffData.map(d => d.id)).size / totalRows) * 100) : 0;
            const increaseCount = diffData.filter(d => d.diffType === 'increase').length;
            const decreaseCount = diffData.filter(d => d.diffType === 'decrease').length;
            
            totalDiffsEl.textContent = totalDiffs;
            diffRowPercentageEl.textContent = `${diffRowPercentage}%`;
            increaseCountEl.textContent = increaseCount;
            decreaseCountEl.textContent = decreaseCount;
        }

        // æ›´æ–°å·®å¼‚è¡¨æ ¼
        function updateDiffTable() {
            const tbody = diffTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            if (diffData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-400 italic">æš‚æ— å·®å¼‚æ•°æ®</td></tr>';
                updatePaginationControls([]);
                return;
            }
            
            // åº”ç”¨è¿‡æ»¤å’Œæ’åº
            let filteredData = [...diffData];
            
            // è¿‡æ»¤
            const filterValue = diffFilter.value;
            if (filterValue !== 'all') {
                filteredData = filteredData.filter(diff => diff.diffType === filterValue);
            }
            
            // æ’åºï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
            const sortValue = sortBy.value;
            filteredData.sort((a, b) => {
                switch (sortValue) {
                    case 'id':
                        return a.id - b.id;
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'diffValue':
                        return typeof a.diffValue === 'number' && typeof b.diffValue === 'number' 
                            ? b.diffValue - a.diffValue 
                            : 0;
                    case 'diffPercentage':
                        return typeof a.diffPercentage === 'string' && typeof b.diffPercentage === 'string'
                            ? parseFloat(b.diffPercentage) - parseFloat(a.diffPercentage)
                            : 0;
                    default:
                        // ä½¿ç”¨å·®å¼‚æ•°æ®ä¸­çš„åŸå§‹å€¼è¿›è¡Œæ’åºï¼Œé¿å…é‡å¤æŸ¥æ‰¾
                        if (a.field === sortValue || b.field === sortValue) {
                            const value1 = typeof a.valueA === 'number' ? a.valueA : (typeof a.valueB === 'number' ? a.valueB : 0);
                            const value2 = typeof b.valueA === 'number' ? b.valueA : (typeof b.valueB === 'number' ? b.valueB : 0);
                            return value1 - value2;
                        }
                        return 0;
                }
            });
            
            // åº”ç”¨åˆ†é¡µ
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = filteredData.slice(startIndex, endIndex);
            
            // æ¸²æŸ“å·®å¼‚è¡Œ
            renderDiffRows(paginatedData, tbody);
            
            // æ›´æ–°åˆ†é¡µæ§ä»¶
            updatePaginationControls(filteredData);
        }
        
        // æ¸²æŸ“å·®å¼‚è¡Œï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
        function renderDiffRows(data, tbody) {
            // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µä¼˜åŒ–DOMæ“ä½œ
            const fragment = document.createDocumentFragment();
            
            data.forEach(diff => {
                const row = document.createElement('tr');
                row.className = `border-b border-gray-700 hover:bg-white hover:bg-opacity-10 transition-colors`;
                
                // æ ¹æ®å·®å¼‚ç±»å‹è®¾ç½®æ ·å¼
                const diffClass = diff.diffType === 'increase' ? 'text-diff-increase' : 
                                 diff.diffType === 'decrease' ? 'text-diff-decrease' : 'text-diff-change';
                
                // æ ¹æ®é«˜äº®æ–¹å¼è®¾ç½®æ ·å¼
                const highlightStyle = highlightMode ? (highlightMode.value || 'background') : 'background';
                let valueBClass = '';
                let diffValueClass = '';
                
                switch (highlightStyle) {
                    case 'background':
                        valueBClass = `bg-${diffClass.replace('text-', '')} bg-opacity-20`;
                        diffValueClass = `bg-${diffClass.replace('text-', '')} bg-opacity-20`;
                        break;
                    case 'text':
                        valueBClass = `${diffClass} font-medium`;
                        diffValueClass = `${diffClass} font-medium`;
                        break;
                    case 'border':
                        const borderColor = diffClass.replace('text-', 'border-');
                        valueBClass = `border-l-4 ${borderColor} font-medium`;
                        diffValueClass = `border-l-4 ${borderColor} font-medium`;
                        break;
                }
                
                row.innerHTML = `
                    <td class="px-4 py-3">${diff.id}</td>
                    <td class="px-4 py-3">${diff.name}</td>
                    <td class="px-4 py-3">${diff.field}</td>
                    <td class="px-4 py-3">${formatValue(diff.valueA)}</td>
                    <td class="px-4 py-3 ${valueBClass}">${formatValue(diff.valueB)}</td>
                    <td class="px-4 py-3 ${diffValueClass}">${formatValue(diff.diffValue)}</td>
                    <td class="px-4 py-3">${diff.diffPercentage}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${getDiffTypeClass(diff.diffType)}">
                            ${getDiffTypeText(diff.diffType)}
                        </span>
                    </td>
                `;
                
                fragment.appendChild(row);
            });
            
            // ä¸€æ¬¡æ€§æ·»åŠ æ‰€æœ‰è¡Œ
            tbody.appendChild(fragment);
        }
        

        
        // åˆ‡æ¢é¡µç 
        function changePage(page) {
            if (page < 1) return;
            
            const filteredData = getFilteredData();
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            
            if (page > totalPages) return;
            
            currentPage = page;
            updateDiffTable();
            
            // æ»šåŠ¨åˆ°è¡¨æ ¼é¡¶éƒ¨
            const diffTableContainer = diffTable.parentElement.parentElement;
            diffTableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // æ›´æ–°åˆ†é¡µæ§ä»¶
        function updatePaginationControls(filteredData) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const totalItems = filteredData.length;
            const startRange = Math.min((currentPage - 1) * itemsPerPage + 1, totalItems);
            const endRange = Math.min(currentPage * itemsPerPage, totalItems);
            
            // æ›´æ–°æ˜¾ç¤ºèŒƒå›´
            if (startRangeEl) startRangeEl.textContent = startRange;
            if (endRangeEl) endRangeEl.textContent = endRange;
            if (totalItemsEl) totalItemsEl.textContent = totalItems;
            if (currentPageDisplay) currentPageDisplay.textContent = currentPage;
            if (totalPagesDisplay) totalPagesDisplay.textContent = totalPages;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            if (prevPageBtn) {
                prevPageBtn.disabled = currentPage === 1;
                prevPageBtn.classList.toggle('opacity-50', currentPage === 1);
                prevPageBtn.classList.toggle('cursor-not-allowed', currentPage === 1);
            }
            
            if (nextPageBtn) {
                nextPageBtn.disabled = currentPage === totalPages;
                nextPageBtn.classList.toggle('opacity-50', currentPage === totalPages);
                nextPageBtn.classList.toggle('cursor-not-allowed', currentPage === totalPages);
            }
            
            if (firstPageBtn) {
                firstPageBtn.disabled = currentPage === 1;
                firstPageBtn.classList.toggle('opacity-50', currentPage === 1);
                firstPageBtn.classList.toggle('cursor-not-allowed', currentPage === 1);
            }
            
            if (lastPageBtn) {
                lastPageBtn.disabled = currentPage === totalPages;
                lastPageBtn.classList.toggle('opacity-50', currentPage === totalPages);
                lastPageBtn.classList.toggle('cursor-not-allowed', currentPage === totalPages);
            }
            
            // æ˜¾ç¤ºæˆ–éšè—åˆ†é¡µæ§ä»¶
            if (paginationControls) {
                if (totalPages <= 1) {
                    paginationControls.classList.add('hidden');
                } else {
                    paginationControls.classList.remove('hidden');
                }
            }
        }

        // åˆ‡æ¢é¡µç 
        function changePage(page) {
            if (page < 1) return;
            
            const filteredData = getFilteredData();
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            
            if (page > totalPages) return;
            
            currentPage = page;
            updateDiffTable();
            
            // æ»šåŠ¨åˆ°è¡¨æ ¼é¡¶éƒ¨
            const diffTableContainer = diffTable.parentElement.parentElement;
            diffTableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // åˆ‡æ¢æ¯é¡µæ˜¾ç¤ºæ•°é‡
        function changeItemsPerPage(value) {
            itemsPerPage = parseInt(value);
            currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            updateDiffTable();
        }
        
        // è·å–è¿‡æ»¤åçš„æ•°æ®
        function getFilteredData() {
            let filteredData = [...diffData];
            const filterValue = diffFilter.value;
            
            if (filterValue !== 'all') {
                filteredData = filteredData.filter(diff => diff.diffType === filterValue);
            }
            
            return filteredData;
        }

        // æ›´æ–°å·®å¼‚æ‘˜è¦
        function updateDiffSummary() {
            if (diffData.length === 0) {
                diffSummary.innerHTML = '<p class="text-green-300">ğŸ‰ ä¸¤ä¸ªè¡¨æ ¼æ•°æ®å®Œå…¨ä¸€è‡´ï¼Œæœªå‘ç°å·®å¼‚</p>';
                return;
            }
            
            const increaseCount = diffData.filter(d => d.diffType === 'increase').length;
            const decreaseCount = diffData.filter(d => d.diffType === 'decrease').length;
            const changeCount = diffData.filter(d => d.diffType === 'change').length;
            
            const summary = `
                <div class="space-y-2">
                    <p class="font-medium text-white">ğŸ“Š å·®å¼‚åˆ†æå®Œæˆ</p>
                    <p>å…±å‘ç° <span class="text-accent font-bold">${diffData.length}</span> ä¸ªå·®å¼‚</p>
                    <p>å…¶ä¸­ï¼š
                        <span class="text-diff-increase">å¢åŠ  ${increaseCount} é¡¹</span> | 
                        <span class="text-diff-decrease">å‡å°‘ ${decreaseCount} é¡¹</span> | 
                        <span class="text-diff-change">å˜åŒ– ${changeCount} é¡¹</span>
                    </p>
                    <p class="text-sm text-gray-300 mt-2">ğŸ’¡ æç¤ºï¼šç‚¹å‡»å·®å¼‚è¯¦æƒ…è¡¨æ ¼ä¸­çš„è¡Œå¯ä»¥æŸ¥çœ‹æ›´å¤šä¿¡æ¯</p>
                </div>
            `;
            
            diffSummary.innerHTML = summary;
        }

        // æ›´æ–°é«˜äº®æ–¹å¼
        function updateHighlightMode() {
            if (diffData.length > 0) {
                updateDiffTable();
            }
        }

        // å¯¼å‡ºç»“æœ
        function exportResults() {
            console.log('å¯¼å‡ºå¯¹æ¯”ç»“æœ...');
            
            if (diffData.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å·®å¼‚æ•°æ®ï¼Œè¯·å…ˆè¿›è¡Œå¯¹æ¯”åˆ†æ');
                return;
            }
            
            try {
                // ä½¿ç”¨XLSXåº“å¯¼å‡ºExcelæ–‡ä»¶ï¼Œæ›´å¥½åœ°æ”¯æŒä¸­æ–‡
                if (typeof XLSX !== 'undefined') {
                    // å‡†å¤‡Excelæ•°æ®
                    const excelData = diffData.map(diff => ({
                        'ID': diff.id,
                        'åç§°': diff.name,
                        'å­—æ®µ': diff.field,
                        'è¡¨æ ¼Aå€¼': formatExportValue(diff.valueA),
                        'è¡¨æ ¼Bå€¼': formatExportValue(diff.valueB),
                        'å·®å¼‚å€¼': formatExportValue(diff.diffValue),
                        'å·®å¼‚ç™¾åˆ†æ¯”': diff.diffPercentage,
                        'å·®å¼‚ç±»å‹': getDiffTypeText(diff.diffType)
                    }));
                    
                    // åˆ›å»ºå·¥ä½œç°¿å’Œå·¥ä½œè¡¨
                    const ws = XLSX.utils.json_to_sheet(excelData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'å·®å¼‚åˆ†æç»“æœ');
                    
                    // è°ƒæ•´åˆ—å®½
                    const colWidths = [
                        { wch: 10 }, // ID
                        { wch: 20 }, // åç§°
                        { wch: 15 }, // å­—æ®µ
                        { wch: 15 }, // è¡¨æ ¼Aå€¼
                        { wch: 15 }, // è¡¨æ ¼Bå€¼
                        { wch: 15 }, // å·®å¼‚å€¼
                        { wch: 15 }, // å·®å¼‚ç™¾åˆ†æ¯”
                        { wch: 10 }  // å·®å¼‚ç±»å‹
                    ];
                    ws['!cols'] = colWidths;
                    
                    // ç”ŸæˆExcelæ–‡ä»¶å¹¶ä¸‹è½½
                    const fileName = `æ•°æ®å¯¹æ¯”ç»“æœ_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                    console.log('Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸ');
                    return;
                }
                
                // å¦‚æœXLSXåº“ä¸å¯ç”¨ï¼Œå›é€€åˆ°CSVå¯¼å‡ºï¼ˆå¢å¼ºç‰ˆï¼‰
                console.log('XLSXåº“ä¸å¯ç”¨ï¼Œå›é€€åˆ°å¢å¼ºç‰ˆCSVå¯¼å‡º');
                
                // åˆ›å»ºCSVå†…å®¹ - å¢å¼ºçš„BOMå¤„ç†
                const headers = ['ID', 'åç§°', 'å­—æ®µ', 'è¡¨æ ¼Aå€¼', 'è¡¨æ ¼Bå€¼', 'å·®å¼‚å€¼', 'å·®å¼‚ç™¾åˆ†æ¯”', 'å·®å¼‚ç±»å‹'];
                let csvContent = headers.join(',') + '\n';
                
                diffData.forEach(diff => {
                    const row = [
                        diff.id,
                        `"${diff.name.replace(/"/g, '""')}"`,
                        `"${diff.field.replace(/"/g, '""')}"`,
                        `"${formatExportValue(diff.valueA).replace(/"/g, '""')}"`,
                        `"${formatExportValue(diff.valueB).replace(/"/g, '""')}"`,
                        `"${formatExportValue(diff.diffValue).replace(/"/g, '""')}"`,
                        diff.diffPercentage,
                        `"${getDiffTypeText(diff.diffType).replace(/"/g, '""')}"`
                    ].join(',');
                    
                    csvContent += row + '\n';
                });
                
                // ä½¿ç”¨ArrayBufferå’ŒUint8Arrayç¡®ä¿æ­£ç¡®çš„UTF-8ç¼–ç 
                const encoder = new TextEncoder();
                const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); // UTF-8 BOM
                const csvBytes = encoder.encode(csvContent);
                const combinedBytes = new Uint8Array(bom.length + csvBytes.length);
                
                combinedBytes.set(bom, 0);
                combinedBytes.set(csvBytes, bom.length);
                
                const blob = new Blob([combinedBytes], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `æ•°æ®å¯¹æ¯”ç»“æœ_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('CSVæ–‡ä»¶å¯¼å‡ºæˆåŠŸ');
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert(`å¯¼å‡ºå¤±è´¥: ${error.message}`);
            }
        }
        
        // æ ¼å¼åŒ–å¯¼å‡ºå€¼
        function formatExportValue(value) {
            if (value === null || value === undefined) return '';
            if (typeof value === 'number') return value.toLocaleString();
            if (typeof value === 'string' && value.length > 100) return value.substring(0, 100) + '...';
            return value;
        }

        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–å­—æ®µå
        function formatFieldName(field) {
            const fieldNames = {
                'price': 'ä»·æ ¼',
                'stock': 'åº“å­˜',
                'sales': 'é”€é‡',
                'category': 'ç±»åˆ«',
                'discount': 'æŠ˜æ‰£'
            };
            return fieldNames[field] || field;
        }

        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–å€¼
        function formatValue(value) {
            if (typeof value === 'number') {
                return value.toLocaleString();
            }
            return value;
        }

        // å·¥å…·å‡½æ•°ï¼šè·å–å·®å¼‚ç±»å‹æ ·å¼
        function getDiffTypeClass(diffType) {
            switch (diffType) {
                case 'increase':
                    return 'bg-diff-increase bg-opacity-20 text-diff-increase';
                case 'decrease':
                    return 'bg-diff-decrease bg-opacity-20 text-diff-decrease';
                case 'change':
                    return 'bg-diff-change bg-opacity-20 text-diff-change';
                default:
                    return 'bg-gray-500 bg-opacity-20 text-gray-300';
            }
        }

        // å·¥å…·å‡½æ•°ï¼šè·å–å·®å¼‚ç±»å‹æ–‡æœ¬
        function getDiffTypeText(diffType) {
            switch (diffType) {
                case 'increase':
                    return 'å¢åŠ ';
                case 'decrease':
                    return 'å‡å°‘';
                case 'change':
                    return 'å˜åŒ–';
                default:
                    return 'æœªçŸ¥';
            }
        }

        // æ™ºèƒ½æ£€æµ‹ä¸»é”®åˆ—
        function detectPrimaryKey() {
            console.log('å¼€å§‹æ™ºèƒ½æ£€æµ‹ä¸»é”®åˆ—...');
            
            // è·å–ä¸¤ä¸ªè¡¨æ ¼çš„æ‰€æœ‰å­—æ®µ
            const allFieldsA = tableAData.length > 0 ? Object.keys(tableAData[0]) : [];
            const allFieldsB = tableBData.length > 0 ? Object.keys(tableBData[0]) : [];
            const commonFields = [...new Set(allFieldsA.filter(field => allFieldsB.includes(field)))];
            
            console.log(`å…±æœ‰ ${commonFields.length} ä¸ªå…±åŒå­—æ®µ:`, commonFields);
            
            // ä¸»é”®è¯„åˆ†
            const fieldScores = {};
            
            commonFields.forEach(field => {
                let score = 0;
                
                // 1. å­—æ®µåè¯­ä¹‰è¯„åˆ†
                const fieldLower = field.toLowerCase();
                if (fieldLower.includes('id') || fieldLower.includes('ç¼–å·') || fieldLower.includes('åºå·')) {
                    score += 30;
                } else if (fieldLower.includes('code') || fieldLower.includes('ç¼–ç ') || fieldLower.includes('key')) {
                    score += 25;
                } else if (fieldLower.includes('name') || fieldLower.includes('åç§°')) {
                    score += 10;
                }
                
                // 2. å”¯ä¸€æ€§è¯„åˆ†
                const valuesA = tableAData.map(item => item[field]).filter(val => val != null && val !== '');
                const valuesB = tableBData.map(item => item[field]).filter(val => val != null && val !== '');
                
                const uniqueRateA = valuesA.length > 0 ? new Set(valuesA).size / valuesA.length : 0;
                const uniqueRateB = valuesB.length > 0 ? new Set(valuesB).size / valuesB.length : 0;
                const uniqueRate = Math.min(uniqueRateA, uniqueRateB);
                
                score += uniqueRate * 40;
                
                // 3. éç©ºå€¼æ¯”ä¾‹è¯„åˆ†
                const nonNullRateA = tableAData.filter(item => item[field] != null && item[field] !== '').length / tableAData.length;
                const nonNullRateB = tableBData.filter(item => item[field] != null && item[field] !== '').length / tableBData.length;
                const nonNullRate = Math.min(nonNullRateA, nonNullRateB);
                
                score += nonNullRate * 20;
                
                // 4. æ•°æ®ç±»å‹è¯„åˆ†ï¼ˆæ•°å€¼å’Œå­—ç¬¦ä¸²ä¼˜å…ˆï¼‰
                const sampleValues = [...valuesA.slice(0, 10), ...valuesB.slice(0, 10)];
                const numericCount = sampleValues.filter(val => typeof val === 'number' || (typeof val === 'string' && !isNaN(val))).length;
                const stringCount = sampleValues.filter(val => typeof val === 'string' && isNaN(val)).length;
                
                if (numericCount > stringCount) {
                    score += 5; // æ•°å€¼ç±»å‹åŠ åˆ†
                }
                
                fieldScores[field] = score;
                console.log(`å­—æ®µ "${field}" è¯„åˆ†: ${score.toFixed(1)} (å”¯ä¸€æ€§:${(uniqueRate*100).toFixed(1)}%, éç©ºç‡:${(nonNullRate*100).toFixed(1)}%)`);
            });
            
            // æ‰¾å‡ºè¯„åˆ†æœ€é«˜çš„å­—æ®µ
            let bestField = 'id'; // é»˜è®¤å€¼
            let bestScore = 0;
            
            Object.entries(fieldScores).forEach(([field, score]) => {
                if (score > bestScore) {
                    bestScore = score;
                    bestField = field;
                }
            });
            
            // å¦‚æœæœ€é«˜åˆ†å¤ªä½ï¼Œè€ƒè™‘ç»„åˆä¸»é”®
            if (bestScore < 50 && commonFields.length >= 2) {
                console.log('å•å­—æ®µä¸»é”®è¯„åˆ†è¾ƒä½ï¼Œè€ƒè™‘ç»„åˆä¸»é”®...');
                
                // æ‰¾å‡ºå‰3ä¸ªè¯„åˆ†æœ€é«˜çš„å­—æ®µ
                const topFields = Object.entries(fieldScores)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 3)
                    .map(([field]) => field);
                
                // æµ‹è¯•ä¸¤åˆ—ç»„åˆ
                for (let i = 0; i < topFields.length; i++) {
                    for (let j = i + 1; j < topFields.length; j++) {
                        const field1 = topFields[i];
                        const field2 = topFields[j];
                        
                        const combinedValuesA = tableAData.map(item => 
                            `${item[field1] || ''}-${item[field2] || ''}`
                        ).filter(val => val !== '-');
                        
                        const combinedValuesB = tableBData.map(item => 
                            `${item[field1] || ''}-${item[field2] || ''}`
                        ).filter(val => val !== '-');
                        
                        const combinedUniqueRateA = combinedValuesA.length > 0 ? 
                            new Set(combinedValuesA).size / combinedValuesA.length : 0;
                        const combinedUniqueRateB = combinedValuesB.length > 0 ? 
                            new Set(combinedValuesB).size / combinedValuesB.length : 0;
                        
                        const combinedScore = (fieldScores[field1] + fieldScores[field2]) / 2 + 
                                            Math.min(combinedUniqueRateA, combinedUniqueRateB) * 30;
                        
                        if (combinedScore > bestScore + 10) {
                            bestScore = combinedScore;
                            bestField = `${field1},${field2}`;
                            console.log(`æ‰¾åˆ°æ›´å¥½çš„ç»„åˆä¸»é”®: ${bestField} (è¯„åˆ†:${combinedScore.toFixed(1)})`);
                        }
                    }
                }
            }
            
            console.log(`æœ€ç»ˆé€‰æ‹©ä¸»é”®: ${bestField} (è¯„åˆ†:${bestScore.toFixed(1)})`);
            return bestField;
        }
        
        // è·å–è®°å½•çš„ä¸»é”®å€¼ï¼ˆæ”¯æŒç»„åˆä¸»é”®ï¼‰
        function getRecordKey(record, primaryKeyField) {
            if (primaryKeyField.includes(',')) {
                // ç»„åˆä¸»é”®
                return primaryKeyField.split(',').map(field => record[field] || '').join('-');
            } else {
                // å•ä¸€ä¸»é”®
                return record[primaryKeyField];
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
