<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>包头新华数据管理平台</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#1e40af',
                        accent: '#f97316',
                        neutral: '#64748b',
                        'neutral-light': '#f1f5f9',
                        'neutral-dark': '#334155',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .fade-in {
                animation: fadeIn 0.5s ease-in;
            }
            .scrollbar-thin {
                scrollbar-width: thin;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .bg-gradient-primary {
                background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            }
            /* 3D按钮效果 */
            .btn-3d {
                position: relative;
                transition: all 0.2s ease;
                transform-style: preserve-3d;
                transform: perspective(1000px);
                box-shadow: 0 4px 0 0 rgba(0,0,0,0.2);
            }
            .btn-3d:before {
                content: '';
                position: absolute;
                width: 100%;
                height: 100%;
                left: 0;
                top: 0;
                background: rgba(255,255,255,0.1);
                transform: translateZ(30px);
                border-radius: inherit;
            }
            .btn-3d:active {
                transform: translateY(4px) perspective(1000px);
                box-shadow: 0 0 0 0 rgba(0,0,0,0.2);
            }
            .btn-3d:active:before {
                transform: translateZ(0);
            }
            /* 轮播图指示器 */
            .carousel-indicator {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background-color: rgba(255,255,255,0.5);
                transition: all 0.3s ease;
            }
            .carousel-indicator.active {
                background-color: white;
                transform: scale(1.2);
            }
            /* 美化标题字体 */
            .title-beautify {
                font-family: 'Microsoft YaHei', '微软雅黑', 'SimHei', '黑体', sans-serif;
                font-weight: 700;
                letter-spacing: 2px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
                transition: all 0.3s ease;
            }
            .title-beautify:hover {
                text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
                transform: translateY(-1px);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; margin: 0; padding: 0; }
            .compact-table { font-size: 10pt; }
            .bordered-table th, .bordered-table td { border: 1px solid #000; }
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            
            /* 打印页脚样式 - 已修改为包含"共几页" */
            @page {
                @bottom-left {
                    content: "包头市新华书店 - 第 " counter(page) " 页，共 " counter(pages) " 页";
                    font-size: 10pt;
                    color: #666;
                }
                @bottom-right {
                    content: "打印时间: " strftime("%Y-%m-%d %H:%M:%S", now());
                    font-size: 10pt;
                    color: #666;
                }
            }
            
            /* 修复表格分页问题 */
            table { page-break-inside: avoid; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            
            /* 分页符样式 */
            .page-break-after {
                page-break-after: always;
            }
        }
        
        /* 优化表格样式 */
        .compact-table {
            font-size: 0.75rem; /* 减小字体大小 */
        }
        
        .compact-table th,
        .compact-table td {
            padding: 0.25rem 0.5rem; /* 减小内边距 */
        }
        
        /* 高亮搜索结果 */
        .search-highlight {
            background-color: #fef3c7;
            font-weight: 500;
            padding: 0 2px;
            border-radius: 2px;
        }
        
        /* 文件上传按钮样式 */
        .file-upload-btn {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-upload-btn input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        /* 轮播图样式 */
        .carousel-container {
            position: relative;
            width: 100vw;
            height: 60vh; /* 使用视口高度单位，使轮播图高度更适合显示 */
            overflow: hidden;
            margin-left: calc(-50vw + 50%); /* 使轮播图宽度超出容器，实现满屏效果 */
            margin-bottom: 20px;
        }
        
        .carousel-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        
        .carousel-slide.active {
            opacity: 1;
        }
        
        .carousel-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            min-width: 100%;
            min-height: 100%;
        }
        
        .carousel-caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white;
            text-align: center;
        }
        
        .carousel-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 10;
        }
        
        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background-color: rgba(255,255,255,0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
        }
        
        .carousel-arrow:hover {
            background-color: rgba(255,255,255,0.8);
        }
        
        .carousel-arrow.prev {
            left: 20px;
        }
        
        .carousel-arrow.next {
            right: 20px;
        }
        
        /* 确保左右两侧高度一致 */
        .content-container {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 64px); /* 减去导航栏高度 */
        }
        
        .flex-container {
            display: flex;
            flex: 1;
            gap: 4;
            min-height: 0; /* 解决flexbox高度计算问题 */
        }
        
        .sidebar-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0; /* 允许内容溢出时收缩 */
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0; /* 允许内容溢出时收缩 */
        }
        
        /* 优化学校筛选区域高度 */
        #schoolFilterContainer {
            max-height: calc(100vh - 320px);
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1; /* 允许占满可用空间 */
        }
        
        /* 优化表格容器高度，使其与左侧学校筛选区域一致 */
        .scroll-container {
            max-height: calc(100vh - 320px); /* 调整减去的高度以匹配左侧 */
            overflow-y: auto;
        }
        
        /* 确保表格占满可用空间 */
        .scroll-container > table {
            width: 100%;
        }
        
        /* 侧边栏项目激活状态 */
        .sidebar-item.active {
            background-color: #dbeafe;
            font-weight: 500;
            color: #1e40af;
        }
        
        /* 进度条样式 */
        .progress-container {
            width: 100%;
            height: 6px;
            background-color: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #3b82f6;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        /* 操作按钮容器样式 */
        .action-buttons-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .action-buttons-container:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .action-buttons-container {
                flex-direction: column;
                align-items: center;
            }
            
            .action-buttons-container button {
                width: 100%;
            }
            
            .flex-container {
                flex-direction: column;
            }
            
            .sidebar-container, .main-content {
                min-height: auto;
            }
            
            #schoolFilterContainer, .scroll-container {
                max-height: 300px;
            }
        }
        
        /* 表头映射模态框样式 */
        .mapping-modal {
            max-width: 90%;
            width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .mapping-row {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .mapping-row:last-child {
            border-bottom: none;
        }
        
        .mapping-label {
            width: 120px;
            font-weight: 500;
            margin-right: 1rem;
        }
        
        .mapping-select {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: white;
        }
        
        .mapping-preview {
            margin-top: 0.25rem;
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .mapping-preview span {
            color: #10b981;
            font-weight: 500;
        }
        
        .mapping-instructions {
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }
        
        .mapping-instructions h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1e40af;
        }
        
        .mapping-instructions ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
        }
        
        .mapping-instructions li {
            margin-bottom: 0.25rem;
        }
        
        .mapping-warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            color: #856404;
        }
        
        .mapping-success {
            background-color: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            color: #065f46;
        }
        
        .header-preview {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            border: 1px solid #e5e7eb;
        }
        
        .header-preview h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #4b5563;
        }
        
        .header-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .header-tag {
            background-color: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .required-mark {
            color: #dc2626;
            margin-left: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- 导航栏 -->
    <nav class="bg-gradient-primary text-white p-4 shadow-lg no-print">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <!-- 美化标题字体 -->
            <h1 class="text-xl md:text-2xl font-bold text-shadow mb-2 md:mb-0 title-beautify">包头新华数据管理平台</h1>
            <!-- 将时间放到最右侧 -->
            <div class="flex items-center justify-end w-full md:w-auto">
                <span id="currentTime" class="text-sm md:text-base font-medium"></span>
            </div>
        </div>
    </nav>

    <!-- 图片轮播 -->
    <div class="w-full overflow-hidden no-print">
        <div class="carousel-container shadow-lg">
            <!-- 轮播图片1 -->
            <div class="carousel-slide active">
                <img src="https://wx1.sinaimg.cn/large/a67b36c3ly1hxftbz7ilbj20yw0jmn0v.jpg" alt="网格化管理系统">
                <div class="carousel-caption">
                    <h3 class="text-xl font-bold">全面的数据管理</h3>
                    <p></p>
                </div>
            </div>
            
            <!-- 轮播图片2 -->
            <div class="carousel-slide">
                <img src="https://5b0988e595225.cdn.sohucs.com/images/20180923/614bc69cfa594f1abb233da6b87b96db.jpeg" alt="数据管理系统">
                <div class="carousel-caption">
                    <h3 class="text-xl font-bold">精准的数据分析</h3>
                    <p></p>
                </div>
            </div>
            
            <!-- 轮播图片3 -->
            <div class="carousel-slide">
                <img src="https://www.xinhuabookstores.cn/upload/202104/1617942099.png" alt="信息管理平台">
                <div class="carousel-caption">
                    <h3 class="text-xl font-bold">智能化信息管理</h3>
                    <p></p>
                </div>
            </div>

            <!-- 轮播控制箭头 -->
            <div class="carousel-arrow prev" onclick="changeSlide(-1)">
                <i class="fas fa-chevron-left text-white"></i>
            </div>
            <div class="carousel-arrow next" onclick="changeSlide(1)">
                <i class="fas fa-chevron-right text-white"></i>
            </div>
            
            <!-- 轮播指示器 -->
            <div class="carousel-controls">
                <div class="carousel-indicator active" onclick="goToSlide(0)"></div>
                <div class="carousel-indicator" onclick="goToSlide(1)"></div>
                <div class="carousel-indicator" onclick="goToSlide(2)"></div>
            </div>
        </div>
    </div>

    

    <div class="container mx-auto p-4 content-container">
        <div class="flex-container">
            <!-- 侧边栏 -->
            <div class="w-full lg:w-64 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg shadow-card p-4 no-print transition-all duration-300 hover:shadow-card-hover sidebar-container border border-blue-100 flex-shrink-0">
                <!-- 筛选标题 -->
                <h2 class="text-lg font-semibold mb-4 text-blue-800 flex items-center">
                    <i class="fas fa-filter mr-2 text-blue-500"></i>筛选
                </h2>
                
                <!-- 学校筛选按钮组 -->
                <div class="space-y-2 mb-4 bg-white rounded-lg p-2 shadow-sm" id="schoolFilterContainer">
                    <button data-school="" class="sidebar-item w-full text-left px-3 py-2 rounded hover:bg-blue-50 transition-colors active flex items-center">
                        <i class="fas fa-school mr-2 w-5 text-center text-blue-500"></i>全部学校
                    </button>
                    <!-- 学校筛选按钮将通过JavaScript动态生成 -->
                </div>

                <!-- 统计信息 -->
                <div class="mt-4 p-4 bg-white rounded-lg shadow-sm border border-blue-100">
                    <h3 class="font-semibold text-blue-800 mb-3 flex items-center">
                        <i class="fas fa-chart-pie mr-2 text-blue-500"></i>统计概览
                    </h3>
                    <div class="text-sm space-y-3">
                        <div class="flex justify-between items-center p-2 bg-blue-50 rounded">
                            <span class="text-gray-600">总品种数:</span>
                            <span id="totalOrders" class="font-medium text-blue-700">0</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-blue-50 rounded">
                            <span class="text-gray-600">总册数:</span>
                            <span id="totalCopies" class="font-medium text-blue-700">0</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-blue-50 rounded">
                            <span class="text-gray-600">总码洋:</span>
                            <span id="totalAmount" class="font-medium text-blue-700">¥0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主内容区 -->
            <div class="flex-1 main-content">
                <!-- 搜索和操作栏 - 优化布局和美观度 -->
                <div class="bg-white rounded-lg shadow-md p-4 mb-4 no-print transition-all duration-300 hover:shadow-lg">
                    <div class="flex flex-col lg:flex-row items-center justify-between gap-3">
                        <!-- 搜索框和操作按钮 -->
                        <div class="flex flex-col sm:flex-row items-center gap-2 w-full lg:w-auto">
                            <!-- 搜索框 - 缩短宽度 -->
                            <div class="relative w-full sm:w-48 md:w-56 flex-grow sm:flex-grow-0">
                                <input type="text" id="searchInput" placeholder="搜索书名、订单号、书号..." 
                                       class="w-full pl-9 pr-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-300 text-sm">
                                <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                            </div>
                            
                            <!-- 导入、导出和打印按钮 - 固定宽度确保在一行显示 -->
                            <div class="flex flex-wrap gap-2 w-full sm:w-auto justify-center sm:justify-start min-w-[180px] sm:min-w-[220px]">
                                <!-- 文件上传按钮 -->
                                <div class="file-upload-btn">
                                    <button class="bg-purple-500 hover:bg-purple-600 px-3 py-1.5 rounded-lg transition-all duration-300 flex items-center justify-center text-xs text-white shadow-sm hover:shadow">
                                        <i class="fas fa-upload mr-1.5"></i>导入
                                    </button>
                                    <input type="file" id="excelFileInput" accept=".xls,.xlsx" onchange="handleFileUpload(event)">
                                </div>
                                <button id="exportExcelBtn" class="bg-green-500 hover:bg-green-600 px-3 py-1.5 rounded-lg transition-all duration-300 flex items-center justify-center text-xs text-white shadow-sm hover:shadow">
                                    <i class="fas fa-file-excel mr-1.5"></i>导出
                                </button>
                                <button id="printBtn" class="bg-blue-500 hover:bg-blue-600 px-3 py-1.5 rounded-lg transition-all duration-300 flex items-center justify-center text-xs text-white shadow-sm hover:shadow">
                                    <i class="fas fa-print mr-1.5"></i>打印
                                </button>
                            </div>
                        </div>
                        
                        <!-- 记录信息 - 优化显示 -->
                        <div class="text-xs text-gray-500 w-full lg:w-auto text-right flex items-center justify-center lg:justify-end flex-wrap gap-2">
                            <span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded">
                                <i class="fas fa-list-ul mr-1"></i>显示 <span id="currentRange">0-0</span> 条
                            </span>
                            <span class="bg-gray-50 text-gray-600 px-2 py-0.5 rounded">
                                <i class="fas fa-database mr-1"></i>共 <span id="totalRecords">0</span> 条记录
                            </span>
                        </div>
                    </div>
                </div>

                <!-- 数据表格 -->
                <div class="bg-white rounded-lg shadow-card overflow-hidden transition-all duration-300 hover:shadow-card-hover flex-grow flex flex-col border border-gray-100">
                    <div class="overflow-x-auto flex-grow">
                        <div class="scroll-container overflow-y-auto scrollbar-thin">
                            <table class="w-full compact-table bordered-table">
                                <!-- 表头 -->
                                <thead id="tableHeader" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white sticky top-0 z-10">
                                    <tr>
                                        <th class="py-2 px-2 border border-blue-500 text-left font-semibold text-xs">学校</th>
                                        <th class="py-2 px-2 border border-blue-500 text-left font-semibold text-xs">订单</th>
                                        <th class="py-2 px-2 border border-blue-500 text-left font-semibold text-xs">书号</th>
                                        <th class="py-2 px-2 border border-blue-500 text-left font-semibold text-xs">书名</th>
                                        <th class="py-2 px-2 border border-blue-500 text-left font-semibold text-xs">作者</th>
                                        <th class="py-2 px-2 border border-blue-500 text-left font-semibold text-xs">出版社</th>
                                        <th class="py-2 px-2 border border-blue-500 text-right font-semibold text-xs">定价</th>
                                        <th class="py-2 px-2 border border-blue-500 text-right font-semibold text-xs">册数</th>
                                        <th class="py-2 px-2 border border-blue-500 text-right font-semibold text-xs">码洋</th>
                                        <th class="py-2 px-2 border border-blue-500 text-left font-semibold text-xs">日期</th>
                                    </tr>
                                </thead>
                                <!-- 表体 -->
                                <tbody id="tableBody" class="divide-y divide-gray-200">
                                    <!-- 数据将通过JavaScript动态加载 -->
                                    <tr>
                                        <td colspan="10" class="py-4 px-3 text-center border border-gray-300 text-gray-500 text-sm bg-gray-50">
                                            暂无数据，请导入Excel文件
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 分页控件 -->
                <div class="flex flex-col sm:flex-row justify-between items-center mt-4 bg-white rounded-lg shadow-card p-4 no-print transition-all duration-300 hover:shadow-card-hover">
                    <div class="text-sm text-gray-600 mb-2 sm:mb-0">
                        每页显示 
                        <select id="pageSize" class="border border-gray-300 rounded px-2 py-1 focus:ring-1 focus:ring-primary focus:border-primary transition-all">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select> 条
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="prevPageBtn" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded transition-colors flex items-center justify-center w-8 h-8 opacity-50 cursor-not-allowed" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="text-sm text-gray-700">
                            第 <span id="currentPage">0</span> 页，共 <span id="totalPages">0</span> 页
                        </span>
                        <button id="nextPageBtn" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded transition-colors flex items-center justify-center w-8 h-8 opacity-50 cursor-not-allowed" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载中遮罩 -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg flex flex-col items-center max-w-md w-full">
            <div class="loading-spinner mr-3"></div>
            <span id="loadingText" class="mb-2">正在处理，请稍候...</span>
            <div class="progress-container w-full">
                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
            </div>
            <div id="progressText" class="text-xs text-gray-500 mt-1">0%</div>
            <button id="cancelImportBtn" class="mt-4 px-4 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm hidden">
                取消导入
            </button>
        </div>
    </div>
    
    <!-- 密码输入模态框 -->
    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg flex flex-col items-center max-w-md w-full">
            <h3 class="text-lg font-semibold mb-4">请输入导入密码</h3>
            <div class="w-full mb-4">
                <input type="password" id="passwordInput" placeholder="输入密码" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-300">
            </div>
            <div class="text-red-500 text-sm mb-4 hidden" id="passwordError">密码错误，请重试</div>
            <div class="flex space-x-2 w-full">
                <button id="cancelPasswordBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded transition-colors">
                    取消
                </button>
                <button id="confirmPasswordBtn" class="flex-1 bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded transition-colors">
                    确认
                </button>
            </div>
        </div>
    </div>
    
    <!-- 表头映射模态框 -->
    <div id="headerMappingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg flex flex-col items-center mapping-modal">
            <h3 class="text-lg font-semibold mb-4">Excel表头映射</h3>
            
            <div class="mapping-instructions">
                <h4><i class="fas fa-info-circle mr-2"></i>操作说明</h4>
                <p>请将Excel文件中的表头与系统字段进行映射。系统会自动尝试匹配相似的表头名称。</p>
                <ul>
                    <li><span class="font-medium">红色星号 (*)</span> 标记的字段为必填项</li>
                    <li>您可以选择"不导入"来跳过某些列</li>
                    <li>系统会自动预览每列的前3个数据，帮助您确认映射是否正确</li>
                </ul>
            </div>
            
            <div class="header-preview">
                <h4>Excel文件中的表头：</h4>
                <div class="header-tags" id="excelHeadersPreview">
                    <!-- Excel表头预览将在这里动态生成 -->
                </div>
            </div>
            
            <div class="w-full mt-4" id="mappingContainer">
                <!-- 表头映射内容将在这里动态生成 -->
            </div>
            
            <div class="flex space-x-2 w-full mt-6">
                <button id="cancelMappingBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded transition-colors">
                    取消
                </button>
                <button id="confirmMappingBtn" class="flex-1 bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded transition-colors">
                    确认映射
                </button>
            </div>
        </div>
    </div>

    <script>
        // 常量定义
        const APP_CONSTANTS = {
            DEFAULT_PAGE_SIZE: 20,
            BATCH_SIZE: 100,
            MAX_FILE_SIZE: 50 * 1024 * 1024, // 50MB
            EXCEL_EXTENSIONS: ['.xls', '.xlsx'],
            NOTIFICATION_DURATION: 3000,
            DEBOUNCE_DELAY: 300,
            IMPORT_PASSWORD: 'XH888', // 导入密码
            
            // 系统支持的标准字段
            STANDARD_FIELDS: [
                { id: '学校', name: '学校', required: true },
                { id: '订单', name: '订单', required: true },
                { id: '书号', name: '书号', required: true },
                { id: '书名', name: '书名', required: true },
                { id: '作者', name: '作者', required: false },
                { id: '出版社', name: '出版社', required: false },
                { id: '定价', name: '定价', required: true },
                { id: '册数', name: '册数', required: true },
                { id: '码洋', name: '码洋', required: true },
                { id: '日期', name: '日期', required: false }
            ],
            
            // 常见的表头变体映射
            COMMON_HEADER_VARIANTS: {
                '学校': ['学校', '学校名称', '学校名', '单位', '机构', '客户单位', '客户名称'],
                '订单': ['订单', '订单号', '订单编号', '订单ID', '定单号', '订购单'],
                '书号': ['书号', 'ISBN', 'ISBN号', '图书编号', '出版物号', '标准书号'],
                '书名': ['书名', '图书名称', '书名全称', '书籍名称', '书的名称'],
                '作者': ['作者', '著者', '编者', '作者名', '作者姓名'],
                '出版社': ['出版社', '出版单位', '出版机构', '出版商', '出版公司'],
                '定价': ['定价', '价格', '单价', '原价', '售价', '金额'],
                '册数': ['册数', '数量', '本数', '份数', '册', '本', '份'],
                '码洋': ['码洋', '总金额', '合计金额', '总码洋', '总价', '金额合计', '合计'],
                '日期': ['日期', '订单日期', '订购日期', '下单日期', '交易日期', '日期时间']
            },
            
            // 相似度阈值，用于自动匹配表头
            SIMILARITY_THRESHOLD: 0.6
        };

        // 工具函数
        const Utils = {
            // 防抖函数
            debounce(func, wait) {
                let timeout;
                return function() {
                    const context = this;
                    const args = arguments;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        func.apply(context, args);
                    }, wait);
                };
            },

            // 解析数字，处理可能的千位分隔符
            parseNumber(value) {
                // 确保数据是字符串类型，然后再调用replace方法
                const valueStr = (value !== undefined && value !== null) ? value.toString().replace(/,/g, '') : '';
                return parseFloat(valueStr) || 0;
            },

            // 格式化金额
            formatCurrency(amount) {
                return `¥${amount.toFixed(2)}`;
            },
            
            // 格式化价格（不带¥符号）
            formatPrice(amount) {
                return amount.toFixed(2);
            },

            // 格式化数字（添加千位分隔符）
            formatNumber(number) {
                return number.toLocaleString();
            },

            // 获取当前时间字符串
            getCurrentTimeString() {
                const now = new Date();
                return now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            },

            // 根据学校类型获取图标类
            getSchoolIconClass(school) {
                if (school.includes('大学')) {
                    return 'fa-university';
                } else if (school.includes('中学') || school.includes('一中')) {
                    return 'fa-graduation-cap';
                }
                return 'fa-school';
            },
            
            // 计算两个字符串的相似度（使用Levenshtein距离算法）
            calculateSimilarity(str1, str2) {
                if (!str1 || !str2) return 0;
                
                // 转换为小写并去除空格
                const s1 = str1.toLowerCase().replace(/\s+/g, '');
                const s2 = str2.toLowerCase().replace(/\s+/g, '');
                
                if (s1 === s2) return 1; // 完全匹配
                if (s1.includes(s2) || s2.includes(s1)) return 0.9; // 一个包含另一个
                
                // 计算Levenshtein距离
                const matrix = [];
                
                // 初始化矩阵
                for (let i = 0; i <= s2.length; i++) {
                    matrix[i] = [i];
                }
                
                for (let j = 0; j <= s1.length; j++) {
                    matrix[0][j] = j;
                }
                
                // 填充矩阵
                for (let i = 1; i <= s2.length; i++) {
                    for (let j = 1; j <= s1.length; j++) {
                        if (s2.charAt(i - 1) === s1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1, // 替换
                                matrix[i][j - 1] + 1,     // 插入
                                matrix[i - 1][j] + 1      // 删除
                            );
                        }
                    }
                }
                
                // 计算相似度
                const distance = matrix[s2.length][s1.length];
                const maxLength = Math.max(s1.length, s2.length);
                return 1 - (distance / maxLength);
            },
            
            // 自动匹配Excel表头到标准字段
            autoMapHeaders(excelHeaders) {
                const mapping = {};
                
                // 首先检查是否有完全匹配的常见变体
                for (const standardField of APP_CONSTANTS.STANDARD_FIELDS) {
                    for (const excelHeader of excelHeaders) {
                        if (APP_CONSTANTS.COMMON_HEADER_VARIANTS[standardField.id]?.includes(excelHeader)) {
                            mapping[standardField.id] = excelHeader;
                            break;
                        }
                    }
                }
                
                // 对于未匹配的字段，使用相似度算法
                for (const standardField of APP_CONSTANTS.STANDARD_FIELDS) {
                    if (mapping[standardField.id]) continue; // 已经匹配的跳过
                    
                    let bestMatch = null;
                    let highestSimilarity = 0;
                    
                    for (const excelHeader of excelHeaders) {
                        // 检查这个Excel表头是否已经被其他标准字段匹配
                        const isAlreadyMapped = Object.values(mapping).includes(excelHeader);
                        if (isAlreadyMapped) continue;
                        
                        const similarity = Utils.calculateSimilarity(standardField.name, excelHeader);
                        
                        if (similarity > highestSimilarity && similarity >= APP_CONSTANTS.SIMILARITY_THRESHOLD) {
                            highestSimilarity = similarity;
                            bestMatch = excelHeader;
                        }
                    }
                    
                    if (bestMatch) {
                        mapping[standardField.id] = bestMatch;
                    }
                }
                
                return mapping;
            },
            
            // 获取字段的常见变体列表
            getCommonVariants(fieldId) {
                return APP_CONSTANTS.COMMON_HEADER_VARIANTS[fieldId] || [fieldId];
            },
            
            // 格式化日期
            formatDate(dateValue) {
                if (!dateValue) return '';
                
                // 如果已经是日期字符串，直接返回
                if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}/.test(dateValue)) {
                    return dateValue.split(' ')[0]; // 只保留日期部分
                }
                
                // 如果是数字，尝试作为时间戳处理
                if (typeof dateValue === 'number') {
                    // Excel日期序列号转换（Excel的日期起始于1900年1月1日）
                    if (dateValue > 25569) { // 25569是1970-01-01的Excel序列号
                        const timestamp = (dateValue - 25569) * 86400000;
                        const date = new Date(timestamp);
                        return date.toISOString().split('T')[0];
                    }
                }
                
                // 如果是Date对象
                if (dateValue instanceof Date) {
                    return dateValue.toISOString().split('T')[0];
                }
                
                // 尝试解析各种日期格式
                const dateFormats = [
                    /(\d{4})-(\d{1,2})-(\d{1,2})/, // YYYY-MM-DD
                    /(\d{1,2})\/(\d{1,2})\/(\d{4})/, // MM/DD/YYYY
                    /(\d{1,2})-(\d{1,2})-(\d{4})/, // DD-MM-YYYY
                    /(\d{4})年(\d{1,2})月(\d{1,2})日/ // YYYY年MM月DD日
                ];
                
                for (const format of dateFormats) {
                    const match = String(dateValue).match(format);
                    if (match) {
                        if (format === dateFormats[0]) { // YYYY-MM-DD
                            return `${match[1]}-${match[2].padStart(2, '0')}-${match[3].padStart(2, '0')}`;
                        } else if (format === dateFormats[1]) { // MM/DD/YYYY
                            return `${match[3]}-${match[1].padStart(2, '0')}-${match[2].padStart(2, '0')}`;
                        } else if (format === dateFormats[2]) { // DD-MM-YYYY
                            return `${match[3]}-${match[2].padStart(2, '0')}-${match[1].padStart(2, '0')}`;
                        } else if (format === dateFormats[3]) { // YYYY年MM月DD日
                            return `${match[1]}-${match[2].padStart(2, '0')}-${match[3].padStart(2, '0')}`;
                        }
                    }
                }
                
                // 如果无法解析，返回原始值
                return String(dateValue).split(' ')[0];
            }
        };

        // 应用程序类
        class BookManagementApp {
            constructor() {
                // 数据存储 - 初始为空
                this.bookData = [];
                this.filteredData = [];
                
                // 分页状态
                this.currentPage = 1;
                this.itemsPerPage = APP_CONSTANTS.DEFAULT_PAGE_SIZE;
                this.currentSearchTerm = '';
                this.currentSchoolFilter = ''; // 当前选中的筛选
                
                // 导入状态
                this.importAbortController = null;
                this.isImporting = false;
                
                // 表头映射信息
                this.headerMapping = {}; // 存储标准字段到Excel表头的映射
                this.reverseHeaderMapping = {}; // 存储Excel表头到标准字段的反向映射
                
                // DOM 元素
                this.tableBody = document.getElementById('tableBody');
                this.searchInput = document.getElementById('searchInput');
                this.prevPageBtn = document.getElementById('prevPageBtn');
                this.nextPageBtn = document.getElementById('nextPageBtn');
                this.pageSizeSelect = document.getElementById('pageSize');
                this.exportExcelBtn = document.getElementById('exportExcelBtn');
                this.printBtn = document.getElementById('printBtn');
                this.loadingOverlay = document.getElementById('loadingOverlay');
                this.loadingText = document.getElementById('loadingText');
                this.schoolFilterContainer = document.getElementById('schoolFilterContainer');
                
                // 进度条元素
                this.progressBar = document.getElementById('progressBar');
                this.progressText = document.getElementById('progressText');
                this.cancelImportBtn = document.getElementById('cancelImportBtn');
                
                // 统计元素
                this.totalVarietyElement = document.getElementById('totalOrders'); // 总品种数
                this.totalCopiesElement = document.getElementById('totalCopies'); // 总册数
                this.totalAmountElement = document.getElementById('totalAmount'); // 总码洋
                
                // 分页信息元素
                this.currentRangeElement = document.getElementById('currentRange');
                this.totalRecordsElement = document.getElementById('totalRecords');
                this.currentPageElement = document.getElementById('currentPage');
                this.totalPagesElement = document.getElementById('totalPages');
                
                // 表头元素
                this.tableHeader = document.getElementById('tableHeader');
                
                // 表头映射相关元素
                this.headerMappingModal = document.getElementById('headerMappingModal');
                this.mappingContainer = document.getElementById('mappingContainer');
                this.excelHeadersPreview = document.getElementById('excelHeadersPreview');
                this.cancelMappingBtn = document.getElementById('cancelMappingBtn');
                this.confirmMappingBtn = document.getElementById('confirmMappingBtn');
                
                // 初始化应用
                this.initialize();
            }
            
            // 初始化应用
            initialize() {
                this.updateTime();
                this.setupEventListeners();
                
                // 每秒更新一次时间
                setInterval(() => this.updateTime(), 1000);
            }
            
            // 更新当前时间
            updateTime() {
                const timeElement = document.getElementById('currentTime');
                if (timeElement) {
                    timeElement.textContent = Utils.getCurrentTimeString();
                }
            }
            
            // 设置事件监听器
            setupEventListeners() {
                // 搜索功能
                this.searchInput.addEventListener('input', Utils.debounce(() => this.performSearch(), APP_CONSTANTS.DEBOUNCE_DELAY));
                
                // 分页功能
                this.prevPageBtn.addEventListener('click', () => this.previousPage());
                this.nextPageBtn.addEventListener('click', () => this.nextPage());
                this.pageSizeSelect.addEventListener('change', () => this.changePageSize());
                
                // 导出和打印
                this.exportExcelBtn.addEventListener('click', () => this.exportToExcel());
                this.printBtn.addEventListener('click', () => this.printOptimized());
                
                // 取消导入按钮
                this.cancelImportBtn.addEventListener('click', () => this.cancelImport());
                
                // 全部学校筛选按钮
                document.querySelector('[data-school=""]').addEventListener('click', () => {
                    this.filterBySchool('');
                    
                    // 更新侧边栏激活状态
                    document.querySelectorAll('.sidebar-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    document.querySelector('[data-school=""]').classList.add('active');
                });
                
                // 表头映射相关事件
                if (this.cancelMappingBtn) {
                    this.cancelMappingBtn.addEventListener('click', () => this.hideHeaderMappingModal());
                }
                
                if (this.confirmMappingBtn) {
                    this.confirmMappingBtn.addEventListener('click', () => this.confirmHeaderMapping());
                }
            }
            
            // 渲染表格
            renderTable() {
                // 优化：使用requestAnimationFrame提高渲染性能
                requestAnimationFrame(() => {
                    const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                    const endIndex = startIndex + this.itemsPerPage;
                    const currentData = this.filteredData.slice(startIndex, endIndex);
                    
                    this.tableBody.innerHTML = '';
                    
                    if (currentData.length === 0) {
                        this.renderEmptyState();
                        this.updatePaginationInfo();
                        return;
                    }
                    
                    // 获取已匹配的标准字段
                    const mappedFields = this.getMappedStandardFields();
                    
                    // 如果没有已匹配的列，显示错误信息
                    if (mappedFields.length === 0) {
                        const emptyRow = document.createElement('tr');
                        emptyRow.innerHTML = `
                            <td colspan="10" class="py-4 px-3 text-center border border-gray-300 text-gray-500 text-sm bg-gray-50">
                                没有已匹配的列可显示
                            </td>
                        `;
                        this.tableBody.appendChild(emptyRow);
                        this.updatePaginationInfo();
                        return;
                    }
                    
                    // 更新表头显示为实际的Excel表头
                    this.updateTableHeaders();
                    
                    // 使用DocumentFragment批量添加行，减少DOM操作
                    const fragment = document.createDocumentFragment();
                    
                    // 渲染数据行
                    currentData.forEach((item, index) => {
                        const row = this.createTableRow(item, index);
                        fragment.appendChild(row);
                    });
                    
                    // 添加页合计行
                    const totalRow = this.createPageTotalRow(currentData);
                    fragment.appendChild(totalRow);
                    
                    // 一次性添加所有行
                    this.tableBody.appendChild(fragment);
                    
                    // 更新分页信息
                    this.updatePaginationInfo();
                });
            }
            
            // 更新表格表头为实际的Excel表头
            updateTableHeaders() {
                if (!this.tableHeader || Object.keys(this.headerMapping).length === 0) {
                    return;
                }
                
                const thElements = this.tableHeader.querySelectorAll('th');
                
                // 为每个标准字段找到对应的Excel表头
                APP_CONSTANTS.STANDARD_FIELDS.forEach((field, index) => {
                    if (thElements[index]) {
                        const excelHeader = this.headerMapping[field.id];
                        if (excelHeader && excelHeader !== 'none') {
                            // 显示实际的Excel表头
                            thElements[index].textContent = excelHeader;
                            thElements[index].style.display = ''; // 显示已匹配的列
                        } else {
                            // 如果没有映射，隐藏该列
                            thElements[index].style.display = 'none';
                        }
                    }
                });
            }
            
            // 创建表格行
            createTableRow(item, index) {
                const row = document.createElement('tr');
                // 根据索引设置交替背景色
                const rowClass = index % 2 === 0 
                    ? 'compact-row fade-in hover:bg-blue-50 transition-colors' 
                    : 'compact-row fade-in hover:bg-blue-50 transition-colors bg-blue-50';
                row.className = rowClass;
                
                // 获取已匹配的标准字段
                const mappedFields = this.getMappedStandardFields();
                
                // 为每个已匹配的标准字段创建单元格
                mappedFields.forEach((field, index) => {
                    const td = document.createElement('td');
                    td.className = 'py-1 px-2 border border-gray-300 text-xs';
                    
                    // 特殊处理数字字段的对齐方式
                    if (['定价', '册数', '码洋'].includes(field.id)) {
                        td.className += ' text-right';
                    }
                    
                    // 获取字段值
                    let value = item[field.id] || '';
                    
                    // 特殊处理定价和码洋字段，格式化显示
                    if (field.id === '定价' || field.id === '码洋') {
                        const amount = Utils.parseNumber(value);
                        value = Utils.formatPrice(amount);
                    }
                    
                    // 特殊处理书名，添加搜索高亮
                    if (field.id === '书名') {
                        td.innerHTML = this.highlightSearchTerm(value);
                    } else {
                        td.textContent = value;
                    }
                    
                    row.appendChild(td);
                });
                
                return row;
            }
            
            // 创建页合计行 - 优化版本：对照表头册数和码洋显示
            createPageTotalRow(currentData) {
                // 获取已匹配的标准字段
                const mappedFields = this.getMappedStandardFields();
                
                // 计算本页合计
                const pageCopies = currentData.reduce((sum, item) => {
                    const copies = Utils.parseNumber(item.册数);
                    return sum + copies;
                }, 0);
                
                // 计算本页码洋合计
                const pageAmount = currentData.reduce((sum, item) => {
                    const amount = Utils.parseNumber(item.码洋);
                    return sum + amount;
                }, 0);
                
                const totalRow = document.createElement('tr');
                totalRow.className = 'page-total-row fade-in bg-blue-100';
                
                // 创建单元格 - 优化：根据字段ID对照表头显示
                for (let i = 0; i < mappedFields.length; i++) {
                    const field = mappedFields[i];
                    const td = document.createElement('td');
                    td.className = 'py-1 px-2 border border-gray-300 text-xs font-medium';
                    
                    if (field.id === '学校') {
                        // 在学校列显示"本页合计"
                        td.textContent = '本页合计';
                        td.style.textAlign = 'center';
                    } else if (field.id === '册数') {
                        // 册数合计
                        td.textContent = Utils.formatNumber(pageCopies);
                        td.style.textAlign = 'right';
                    } else if (field.id === '码洋') {
                        // 码洋合计
                        td.textContent = Utils.formatPrice(pageAmount);
                        td.style.textAlign = 'right';
                    } else {
                        // 其他列留空
                        td.textContent = '';
                    }
                    
                    totalRow.appendChild(td);
                }
                
                return totalRow;
            }
            
            // 渲染空状态
            renderEmptyState() {
                const emptyRow = document.createElement('tr');
                
                // 获取已匹配的标准字段
                const mappedFields = this.getMappedStandardFields();
                const colspan = mappedFields.length > 0 ? mappedFields.length : 10;
                
                if (this.bookData.length === 0) {
                    emptyRow.innerHTML = `
                        <td colspan="${colspan}" class="py-4 px-3 text-center border border-gray-300 text-gray-500 text-sm bg-gray-50">
                            暂无数据，请导入Excel文件
                        </td>
                    `;
                } else {
                    emptyRow.innerHTML = `
                        <td colspan="${colspan}" class="py-4 px-3 text-center border border-gray-300 text-gray-500 text-sm bg-gray-50">
                            暂无符合条件的订单数据
                        </td>
                    `;
                }
                this.tableBody.appendChild(emptyRow);
            }
            
            // 搜索高亮
            highlightSearchTerm(text) {
                if (!this.currentSearchTerm) return text;
                
                const regex = new RegExp(`(${this.currentSearchTerm})`, 'gi');
                return text.replace(regex, '<span class="search-highlight">$1</span>');
            }
            
            // 更新分页信息
            updatePaginationInfo() {
                const totalPages = Math.ceil(this.filteredData.length / this.itemsPerPage);
                const startIndex = (this.currentPage - 1) * this.itemsPerPage + 1;
                const endIndex = Math.min(this.currentPage * this.itemsPerPage, this.filteredData.length);
                
                this.currentRangeElement.textContent = this.filteredData.length > 0 ? `${startIndex}-${endIndex}` : '0-0';
                this.totalRecordsElement.textContent = this.filteredData.length;
                this.currentPageElement.textContent = this.filteredData.length > 0 ? this.currentPage : '0';
                this.totalPagesElement.textContent = totalPages > 0 ? totalPages : '0';
                
                // 禁用/启用分页按钮
                this.prevPageBtn.disabled = this.currentPage === 1 || this.filteredData.length === 0;
                this.nextPageBtn.disabled = this.currentPage === totalPages || this.filteredData.length === 0;
                
                if (this.prevPageBtn.disabled) {
                    this.prevPageBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    this.prevPageBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                
                if (this.nextPageBtn.disabled) {
                    this.nextPageBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    this.nextPageBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
            
            // 更新统计信息
            updateStatistics() {
                // 优化：使用缓存的统计结果提高性能
                if (this.filteredData.length === 0) {
                    this.totalVarietyElement.textContent = '0';
                    this.totalCopiesElement.textContent = '0';
                    this.totalAmountElement.textContent = '¥0.00';
                    this.updateStatisticLabels();
                    return;
                }
                
                // 计算总册数
                const totalCopies = this.filteredData.reduce((sum, item) => {
                    const copies = Utils.parseNumber(item.册数);
                    return sum + copies;
                }, 0);
                
                // 计算总码洋
                const totalAmount = this.filteredData.reduce((sum, item) => {
                    const amount = Utils.parseNumber(item.码洋);
                    return sum + amount;
                }, 0);
                
                // 优化：总品种数显示为条目合计数（过滤后的记录总数）
                this.totalVarietyElement.textContent = this.filteredData.length;
                this.totalCopiesElement.textContent = Utils.formatNumber(totalCopies);
                this.totalAmountElement.textContent = Utils.formatCurrency(totalAmount);
                
                // 更新统计信息中的字段名称
                this.updateStatisticLabels();
            }
            
            // 更新统计信息中的字段名称
            updateStatisticLabels() {
                // 获取统计信息区域的标签元素
                const statLabels = document.querySelectorAll('.mt-4 .text-gray-600');
                
                if (statLabels.length >= 3) {
                    // 优化：总品种数固定显示，不随表头导入变化
                    statLabels[0].textContent = '总品种数:';
                    
                    // 获取实际的表头名称
                    const copiesHeader = this.headerMapping['册数'] || '册数';
                    const amountHeader = this.headerMapping['码洋'] || '码洋';
                    
                    // 更新标签文本
                    statLabels[1].textContent = `总${copiesHeader}:`;
                    statLabels[2].textContent = `总${amountHeader}:`;
                }
            }
            
            // 按学校筛选
            filterBySchool(school) {
                this.currentSchoolFilter = school;
                this.applyFilters();
            }
            
            // 搜索功能
            performSearch() {
                this.currentSearchTerm = this.searchInput.value.trim();
                this.applyFilters();
            }
            
            // 应用所有筛选
            applyFilters() {
                // 优化：使用缓存减少重复计算
                const filterKey = `${this.currentSchoolFilter}_${this.currentSearchTerm}`;
                
                // 如果筛选条件没有变化，直接返回
                if (this.lastFilterKey === filterKey) {
                    return;
                }
                
                // 保存当前筛选条件
                this.lastFilterKey = filterKey;
                
                // 先应用学校筛选
                let filtered = [...this.bookData];
                
                if (this.currentSchoolFilter) {
                    filtered = this.filterBySchoolName(filtered, this.currentSchoolFilter);
                }
                
                // 再应用搜索筛选
                if (this.currentSearchTerm) {
                    filtered = this.filterBySearchTerm(filtered, this.currentSearchTerm);
                }
                
                this.filteredData = filtered;
                this.currentPage = 1;
                this.renderTable();
                this.updateStatistics();
                
                // 更新筛选列表显示
                this.updateFilterDisplay();
            }
            
            // 更新筛选列表显示
            updateFilterDisplay() {
                if (!this.schoolFilterContainer) return;
                
                // 获取筛选列表中的所有项
                const filterItems = this.schoolFilterContainer.querySelectorAll('.sidebar-item');
                
                // 获取"学校"字段的Excel表头
                const schoolHeader = this.headerMapping['学校'] || '学校';
                
                // 更新"全部"选项的显示
                const allItem = document.querySelector('[data-school=""]');
                if (allItem) {
                    allItem.innerHTML = `<i class="fas fa-building mr-2"></i>全部${schoolHeader}`;
                }
                
                // 更新统计信息中的总品种数字段显示
                const statsItems = document.querySelectorAll('.sidebar-container .mt-4 .flex.justify-between');
                if (statsItems.length >= 1) {
                    const totalVarietyItem = statsItems[0];
                    if (totalVarietyItem) {
                        const labelElement = totalVarietyItem.querySelector('.text-gray-600');
                        if (labelElement) {
                            // 优化：总品种数固定显示，不随表头导入变化
                            labelElement.textContent = '总品种数:';
                        }
                    }
                }
            }
            
            // 按学校名称筛选数据
            filterBySchoolName(data, schoolName) {
                return data.filter(item => item.学校 === schoolName);
            }
            
            // 按搜索词筛选数据
            filterBySearchTerm(data, searchTerm) {
                const lowerSearchTerm = searchTerm.toLowerCase();
                return data.filter(item => {
                    return Object.values(item).some(value => 
                        (value !== undefined && value !== null) && 
                        value.toString().toLowerCase().includes(lowerSearchTerm)
                    );
                });
            }
            
            // 获取导出时使用的表头映射 - 优化：只包含已匹配的列
            getExportHeaderMapping() {
                const exportMapping = {};
                
                // 为每个标准字段找到对应的Excel表头，只包含已匹配的列
                APP_CONSTANTS.STANDARD_FIELDS.forEach(field => {
                    const excelHeader = this.headerMapping[field.id];
                    if (excelHeader && excelHeader !== 'none') {
                        // 使用实际的Excel表头作为导出的列名
                        exportMapping[field.id] = excelHeader;
                    }
                });
                
                return exportMapping;
            }
            
            // 获取已匹配的标准字段列表
            getMappedStandardFields() {
                return APP_CONSTANTS.STANDARD_FIELDS.filter(field => {
                    const excelHeader = this.headerMapping[field.id];
                    return excelHeader && excelHeader !== 'none';
                });
            }
            
            // 清除搜索 - 修改为直接清空输入框并重新应用筛选
            clearSearch() {
                this.searchInput.value = '';
                this.currentSearchTerm = '';
                this.applyFilters();
            }
            
            // 分页功能
            previousPage() {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.renderTable();
                }
            }
            
            nextPage() {
                const totalPages = Math.ceil(this.filteredData.length / this.itemsPerPage);
                if (this.currentPage < totalPages) {
                    this.currentPage++;
                    this.renderTable();
                }
            }
            
            changePageSize() {
                this.itemsPerPage = parseInt(this.pageSizeSelect.value);
                this.currentPage = 1;
                this.renderTable();
            }
            
            // 导出到Excel - 优化：根据查询条件动态生成文件名，只导出已匹配的列
            exportToExcel() {
                if (this.filteredData.length === 0) {
                    this.showNotification('没有可导出的数据', 'warning');
                    return;
                }
                
                this.showLoading('正在导出Excel文件...');
                
                try {
                    // 使用setTimeout模拟异步操作
                    setTimeout(() => {
                        // 获取导出时使用的表头映射，只包含已匹配的列
                        const exportMapping = this.getExportHeaderMapping();
                        
                        // 如果没有已匹配的列，显示错误
                        if (Object.keys(exportMapping).length === 0) {
                            this.hideLoading();
                            this.showNotification('没有已匹配的列可导出', 'error');
                            return;
                        }
                        
                        // 准备导出数据，使用实际的Excel表头，只包含已匹配的列
                        const exportData = this.filteredData.map(item => {
                            const exportItem = {};
                            for (const [standardField, excelHeader] of Object.entries(exportMapping)) {
                                // 特殊处理定价和码洋字段，确保保留两位小数
                                if (standardField === '定价' || standardField === '码洋') {
                                    const value = Utils.parseNumber(item[standardField]);
                                    exportItem[excelHeader] = value.toFixed(2);
                                } else {
                                    exportItem[excelHeader] = item[standardField];
                                }
                            }
                            return exportItem;
                        });
                        
                        // 添加总计行
                        const grandTotals = this.calculateGrandTotals();
                        const totalRow = {};
                        
                        // 获取已匹配的标准字段
                        const mappedFields = this.getMappedStandardFields();
                        
                        // 为总计行设置值，只包含已匹配的列
                        for (const [standardField, excelHeader] of Object.entries(exportMapping)) {
                            if (standardField === '学校') {
                                totalRow[excelHeader] = '总计';
                            } else if (standardField === '订单') {
                                totalRow[excelHeader] = `${this.filteredData.length} 笔`;
                            } else if (standardField === '册数') {
                                totalRow[excelHeader] = grandTotals.totalCopies;
                            } else if (standardField === '码洋') {
                                // 确保码洋总计保留两位小数
                                const amount = Utils.parseNumber(grandTotals.totalAmount.replace('¥', ''));
                                totalRow[excelHeader] = `¥${amount.toFixed(2)}`;
                            } else if (standardField === '定价') {
                                // 定价总计留空
                                totalRow[excelHeader] = '';
                            } else {
                                // 其他字段留空
                                totalRow[excelHeader] = '';
                            }
                        }
                        
                        exportData.push(totalRow);
                        
                        const ws = XLSX.utils.json_to_sheet(exportData);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "书目订单");
                        
                        // 设置列宽，只包含已匹配的列
                        const wscols = [];
                        const columnWidths = {
                            '学校': 15,
                            '订单': 10,
                            '书号': 15,
                            '书名': 30,
                            '作者': 10,
                            '出版社': 15,
                            '定价': 10,
                            '册数': 10,
                            '码洋': 12,
                            '日期': 10
                        };
                        
                        for (const [standardField, excelHeader] of Object.entries(exportMapping)) {
                            wscols.push({wch: columnWidths[standardField] || 12});
                        }
                        
                        ws['!cols'] = wscols;
                        
                        // 根据查询条件生成文件名
                        let fileName = "书目订单数据";
                        
                        // 如果有学校筛选条件，添加到文件名
                        if (this.currentSchoolFilter) {
                            fileName += `_${this.currentSchoolFilter}`;
                        }
                        
                        // 如果有搜索关键词，添加到文件名
                        if (this.currentSearchTerm) {
                            // 限制搜索关键词长度，避免文件名过长
                            const searchTerm = this.currentSearchTerm.length > 10 
                                ? this.currentSearchTerm.substring(0, 10) + "..." 
                                : this.currentSearchTerm;
                            fileName += `_搜索_${searchTerm}`;
                        }
                        
                        // 添加日期
                        const today = new Date();
                        const dateStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
                        fileName += `_${dateStr}.xlsx`;
                        
                        XLSX.writeFile(wb, fileName);
                        
                        this.hideLoading();
                        this.showNotification('导出成功', 'success');
                    }, 800);
                } catch (error) {
                    this.hideLoading();
                    this.showNotification('导出失败: ' + error.message, 'error');
                }
            }
            
            // 优化打印功能 - 实现自适应分页，增加每页打印抬头，只打印已匹配的列
            printOptimized() {
                if (this.filteredData.length === 0) {
                    this.showNotification('没有可打印的数据', 'warning');
                    return;
                }
                
                this.showLoading('正在准备打印内容...');
                
                try {
                    // 获取已匹配的标准字段
                    const mappedFields = this.getMappedStandardFields();
                    
                    // 如果没有已匹配的列，显示错误
                    if (mappedFields.length === 0) {
                        this.hideLoading();
                        this.showNotification('没有已匹配的列可打印', 'error');
                        return;
                    }
                    
                    // 获取导出时使用的表头映射，只包含已匹配的列
                    const printMapping = this.getExportHeaderMapping();
                    
                    // 准备打印内容
                    let printContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="UTF-8">
                            <title>包头新华管理平台 - 单据明细</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                                .print-header { text-align: center; margin-bottom: 10px; }
                                table { width: 100%; border-collapse: collapse; font-size: 10px; page-break-inside: auto; }
                                th, td { border: 1px solid #d1d5db; padding: 2px 4px; }
                                th { background-color: #f3f4f6; font-weight: bold; }
                                .page-total-row { background-color: #e5e7eb; font-weight: 600; }
                                .grand-total-row { background-color: #dbeafe; font-weight: 700; }
                                
                                /* 打印页脚样式 - 已修改为包含"共几页" */
                                @page {
                                    @bottom-left {
                                        content: "包头市新华书店 - 第 " counter(page) " 页，共 " counter(pages) " 页";
                                        font-size: 10pt;
                                        color: #666;
                                    }
                                    @bottom-right {
                                        content: ""; /* 清空右下角内容 */
                                    }
                                    margin: 1.5cm; /* 调整页边距 */
                                }
                                
                                /* 确保表格在每一页都显示表头 */
                                thead { display: table-header-group; }
                                tfoot { display: table-footer-group; }
                                
                                /* 避免表格行跨页 */
                                tr { page-break-inside: avoid; page-break-after: auto; }
                                
                                /* 分页符样式 */
                                .page-break-after {
                                    page-break-after: always;
                                }
                                
                                /* 确保内容可见 */
                                html, body { height: auto; }
                                
                                /* 每页抬头样式 - 增强版 */
                                .page-header {
                                    margin-bottom: 10px;
                                    padding: 10px;
                                    border-bottom: 2px solid #3b82f6;
                                    background-color: #f8fafc;
                                    border-radius: 4px;
                                }
                                
                                .page-title {
                                    font-size: 18px;
                                    font-weight: bold;
                                    text-align: center;
                                    margin-bottom: 8px;
                                    color: #1e40af;
                                }
                                
                                .page-info {
                                    font-size: 11px;
                                    display: flex;
                                    justify-content: space-between;
                                    margin-bottom: 4px;
                                    color: #475569;
                                }
                                
                                .page-info-item {
                                    display: flex;
                                    align-items: center;
                                }
                                
                                .page-info-item i {
                                    margin-right: 4px;
                                    color: #3b82f6;
                                }
                                
                                /* 总计页样式 */
                                .summary-page {
                                    page-break-after: avoid;
                                }
                                
                                .summary-title {
                                    font-size: 18px;
                                    font-weight: bold;
                                    text-align: center;
                                    margin-bottom: 20px;
                                    color: #1e40af;
                                }
                                
                                .summary-table {
                                    width: 60%;
                                    margin: 0 auto;
                                }
                                
                                .summary-table th, .summary-table td {
                                    padding: 8px;
                                    font-size: 14px;
                                }
                                
                                /* 统计信息表格样式 */
                                .stats-table {
                                    width: 100%;
                                    margin-bottom: 20px;
                                }
                                
                                .stats-table th, .stats-table td {
                                    padding: 6px;
                                    font-size: 12px;
                                }
                                
                                /* 自适应表格样式 */
                                .adaptive-table {
                                    table-layout: auto;
                                    width: 100%;
                                }
                                
                                /* 表头固定样式 */
                                .sticky-header {
                                    position: sticky;
                                    top: 0;
                                    background-color: #f3f4f6;
                                    z-index: 10;
                                }
                            </style>
                        </head>
                        <body>
                    `;
                    
                    // 计算总计信息
                    const grandTotals = this.calculateGrandTotals();
                    const totalItems = this.filteredData.length;
                    
                    // 添加主抬头
                    printContent += `
                        <div class="page-header">
                            <div class="page-title">包头新华管理平台 - 单据明细</div>
                            <div class="page-info">
                                <div class="page-info-item">
                                    <i class="fas fa-clock"></i>
                                    <span>打印时间: ${Utils.getCurrentTimeString()}</span>
                                </div>
                                <div class="page-info-item">
                                    <i class="fas fa-filter"></i>
                                    <span>${this.currentSchoolFilter ? '筛选条件: ' + this.currentSchoolFilter : '全部'}</span>
                                </div>
                            </div>
                            <div class="page-info">
                                <div class="page-info-item">
                                    <i class="fas fa-file-alt"></i>
                                    <span>总记录数: ${Utils.formatNumber(totalItems)} 条</span>
                                </div>
                                <div class="page-info-item">
                                    <i class="fas fa-search"></i>
                                    <span>${this.currentSearchTerm ? '搜索关键词: ' + this.currentSearchTerm : '无搜索条件'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 数据表格 -->
                        <table class="adaptive-table">
                            <thead>
                                <tr class="sticky-header">
                    `;
                    
                    // 添加表头，只包含已匹配的列
                    mappedFields.forEach(field => {
                        const header = printMapping[field.id] || field.name;
                        printContent += `<th>${header}</th>`;
                    });
                    
                    printContent += `
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    // 添加所有数据行，只包含已匹配的列
                    this.filteredData.forEach((item, index) => {
                        printContent += `<tr>`;
                        
                        // 为每个已匹配的标准字段添加单元格
                        mappedFields.forEach((field, index) => {
                            let value = item[field.id] || '';
                            
                            // 特殊处理定价和码洋字段，确保保留两位小数
                            if (field.id === '定价' || field.id === '码洋') {
                                const numValue = Utils.parseNumber(value);
                                value = numValue.toFixed(2);
                            }
                            
                            // 特殊处理数字字段的对齐方式
                            if (['定价', '册数', '码洋'].includes(field.id)) {
                                printContent += `<td style="text-align: right;">${value}</td>`;
                            } else {
                                printContent += `<td>${value}</td>`;
                            }
                        });
                        
                        printContent += `</tr>`;
                    });
                    
                    // 添加总计行，只包含已匹配的列 - 优化：对照表头册数和码洋显示
                    printContent += `<tr class="page-total-row">`;
                    
                    // 为每个已匹配的标准字段添加单元格
                    mappedFields.forEach((field, index) => {
                        if (field.id === '学校') {
                            // 在学校列显示"总计"
                            printContent += `<td style="text-align: center;">总计</td>`;
                        } else if (field.id === '册数') {
                            // 册数合计
                            printContent += `<td style="text-align: right;">${grandTotals.totalCopies}</td>`;
                        } else if (field.id === '码洋') {
                            // 码洋合计，确保保留两位小数
                            const amount = Utils.parseNumber(grandTotals.totalAmount.replace('¥', ''));
                            printContent += `<td style="text-align: right;">¥${amount.toFixed(2)}</td>`;
                        } else if (field.id === '定价') {
                            // 定价总计留空
                            printContent += `<td style="text-align: right;"></td>`;
                        } else {
                            // 其他列留空
                            printContent += `<td></td>`;
                        }
                    });
                    
                    printContent += `</tr>`;
                    
                    printContent += `
                            </tbody>
                        </table>
                        
                        <!-- 按学校统计部分 -->
                        <div class="page-break-after"></div>
                        <div class="summary-page">
                            <div class="page-header">
                                <div class="page-title">包头新华管理平台 </div>
                                <div class="page-info">
                                    <div class="page-info-item">
                                        <i class="fas fa-clock"></i>
                                        <span>统计时间: ${Utils.getCurrentTimeString()}</span>
                                    </div>
                                    <div class="page-info-item">
                                        <i class="fas fa-chart-pie"></i>
                                        <span>统计</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <div class="summary-title">单据统计</div>
                                <table class="stats-table">
                                    <thead>
                                        <tr>
                                            <th>${printMapping['学校'] || '学校'}</th>
                                            <th>品种数</th>
                                            <th>${printMapping['册数'] || '册数'}</th>
                                            <th>${printMapping['码洋'] || '码洋'}</th>
                                            <th>占比</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    // 按学校统计
                    const schoolStats = {};
                    this.filteredData.forEach(item => {
                        const school = item.学校;
                        if (!schoolStats[school]) {
                            schoolStats[school] = {
                                orders: 0,
                                copies: 0,
                                amount: 0
                            };
                        }
                        schoolStats[school].orders++;
                        schoolStats[school].copies += Utils.parseNumber(item.册数);
                        schoolStats[school].amount += Utils.parseNumber(item.码洋);
                    });
                    
                    // 添加学校统计行
                    Object.keys(schoolStats).forEach(school => {
                        const stats = schoolStats[school];
                        const percentage = (stats.amount / Utils.parseNumber(grandTotals.totalAmount.replace('¥', '')) * 100).toFixed(2);
                        
                        printContent += `
                            <tr>
                                <td>${school}</td>
                                <td style="text-align: right;">${Utils.formatNumber(stats.orders)}</td>
                                <td style="text-align: right;">${Utils.formatNumber(stats.copies)}</td>
                                <td style="text-align: right;">${Utils.formatCurrency(stats.amount)}</td>
                                <td style="text-align: right;">${percentage}%</td>
                            </tr>
                        `;
                    });
                    
                    // 添加总计行
                    printContent += `
                                    <tr class="grand-total-row">
                                        <td>总计</td>
                                        <td style="text-align: right;">${Utils.formatNumber(this.filteredData.length)}</td>
                                        <td style="text-align: right;">${grandTotals.totalCopies}</td>
                                        <td style="text-align: right;">${grandTotals.totalAmount}</td>
                                        <td style="text-align: right;">100%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 30px; font-size: 10px; text-align: center; color: #666;">
                            <p>包头新华数据管理平台</p>
                        </div>
                    </div>
                    `;
                    
                    // 结束HTML
                    printContent += `
                        </body>
                        </html>
                    `;
                    
                    // 创建打印窗口并打印
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(printContent);
                    
                    // 等待文档加载完成
                    printWindow.document.onreadystatechange = () => {
                        if (printWindow.document.readyState === 'complete') {
                            // 延迟打印，确保所有内容都已渲染
                            setTimeout(() => {
                                printWindow.print();
                                printWindow.close();
                                this.hideLoading();
                            }, 800); // 延长延迟时间，确保复杂内容渲染完成
                        }
                    };
                    
                    printWindow.document.close();
                } catch (error) {
                    this.hideLoading();
                    this.showNotification('打印准备失败: ' + error.message, 'error');
                }
            }
            
            // 计算总计
            calculateGrandTotals() {
                const totalCopies = this.filteredData.reduce((sum, item) => {
                    const copies = Utils.parseNumber(item.册数);
                    return sum + copies;
                }, 0);
                
                const totalAmount = this.filteredData.reduce((sum, item) => {
                    const amount = Utils.parseNumber(item.码洋);
                    return sum + amount;
                }, 0);
                
                return {
                    totalCopies: Utils.formatNumber(totalCopies),
                    totalAmount: Utils.formatCurrency(totalAmount)
                };
            }
            
            // 显示加载状态
            showLoading(text = '正在处理，请稍候...', showProgress = false, showCancel = false) {
                this.loadingText.textContent = text;
                this.loadingOverlay.classList.remove('hidden');
                
                // 显示或隐藏进度条
                if (showProgress) {
                    this.progressBar.parentElement.classList.remove('hidden');
                    this.progressText.parentElement.classList.remove('hidden');
                    this.progressBar.style.width = '0%';
                    this.progressText.textContent = '0%';
                } else {
                    this.progressBar.parentElement.classList.add('hidden');
                    this.progressText.parentElement.classList.add('hidden');
                }
                
                // 显示或隐藏取消按钮
                if (showCancel) {
                    this.cancelImportBtn.classList.remove('hidden');
                } else {
                    this.cancelImportBtn.classList.add('hidden');
                }
            }
            
            // 更新进度条
            updateProgress(progress) {
                const percentage = Math.min(Math.max(progress, 0), 100);
                this.progressBar.style.width = `${percentage}%`;
                this.progressText.textContent = `${Math.round(percentage)}%`;
            }
            
            // 隐藏加载状态
            hideLoading() {
                this.loadingOverlay.classList.add('hidden');
                this.cancelImportBtn.classList.add('hidden');
                this.isImporting = false;
                this.importAbortController = null;
            }
            
            // 显示通知
            showNotification(message, type = 'info') {
                // 创建通知元素
                const notification = document.createElement('div');
                notification.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-y-0 opacity-100 flex items-center`;
                
                // 设置通知类型样式
                if (type === 'success') {
                    notification.classList.add('bg-green-500', 'text-white');
                    notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
                } else if (type === 'error') {
                    notification.classList.add('bg-red-500', 'text-white');
                    notification.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`;
                } else if (type === 'warning') {
                    notification.classList.add('bg-yellow-500', 'text-white');
                    notification.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
                } else {
                    notification.classList.add('bg-blue-500', 'text-white');
                    notification.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${message}`;
                }
                
                // 添加到页面
                document.body.appendChild(notification);
                
                // 自动隐藏
                setTimeout(() => {
                    notification.classList.add('opacity-0', 'translate-y-4');
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, APP_CONSTANTS.NOTIFICATION_DURATION);
            }
            
            // 动态更新学校筛选列表
            updateSchoolFilters() {
                // 获取所有不重复的学校名称
                const schools = [...new Set(this.bookData.map(item => item.学校))];
                
                // 清空学校筛选容器，但保留"全部学校"选项
                this.clearSchoolFilters();
                
                // 为每个学校创建筛选按钮
                schools.forEach(school => {
                    const button = this.createSchoolFilterButton(school);
                    this.schoolFilterContainer.appendChild(button);
                });
            }
            
            // 清空学校筛选容器，但保留"全部学校"选项
            clearSchoolFilters() {
                while (this.schoolFilterContainer.children.length > 1) {
                    this.schoolFilterContainer.removeChild(this.schoolFilterContainer.lastChild);
                }
            }
            
            // 创建学校筛选按钮
            createSchoolFilterButton(school) {
                const button = document.createElement('button');
                button.className = 'sidebar-item w-full text-left px-3 py-2 rounded hover:bg-blue-50 transition-colors flex items-center';
                button.setAttribute('data-school', school);
                
                // 根据学校类型选择图标
                const iconClass = Utils.getSchoolIconClass(school);
                
                button.innerHTML = `<i class="fas ${iconClass} mr-2 w-5 text-center"></i>${school}`;
                
                // 添加点击事件
                button.addEventListener('click', () => {
                    this.filterBySchool(school);
                    this.updateActiveSchoolFilter(button);
                });
                
                return button;
            }
            
            // 更新学校筛选激活状态
            updateActiveSchoolFilter(activeButton) {
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    item.classList.remove('active');
                });
                activeButton.classList.add('active');
            }
            
            // 导入Excel数据 - 优化版本
            async importFromExcel(data, headerMapping) {
                // 如果正在导入，先取消之前的导入
                if (this.isImporting) {
                    this.cancelImport();
                }
                
                this.isImporting = true;
                this.importAbortController = new AbortController();
                const signal = this.importAbortController.signal;
                
                try {
                    this.showLoading('正在导入数据...', true, true);
                    
                    // 分批处理数据
                    const batchSize = APP_CONSTANTS.BATCH_SIZE;
                    const totalItems = data.length;
                    const totalBatches = Math.ceil(totalItems / batchSize);
                    
                    // 清空现有数据
                    this.bookData = [];
                    this.filteredData = [];
                    
                    // 重置筛选和分页
                    this.currentSearchTerm = '';
                    this.currentSchoolFilter = '';
                    this.currentPage = 1;
                    
                    // 清除搜索框
                    this.searchInput.value = '';
                    
                    // 分批处理数据
                    for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
                        // 检查是否已取消
                        if (signal.aborted) {
                            this.hideLoading();
                            this.showNotification('导入已取消', 'info');
                            return;
                        }
                        
                        // 计算当前批次的起始和结束索引
                        const startIndex = batchIndex * batchSize;
                        const endIndex = Math.min(startIndex + batchSize, totalItems);
                        const batch = data.slice(startIndex, endIndex);
                        
                        // 应用表头映射并添加批次数据
                        const mappedBatch = batch.map(item => this.mapDataRow(item, headerMapping));
                        this.bookData.push(...mappedBatch);
                        
                        // 更新进度
                        const progress = ((batchIndex + 1) / totalBatches) * 100;
                        this.updateProgress(progress);
                        
                        // 更新统计信息
                        this.updateStatistics();
                        
                        // 如果是最后一批，更新UI
                        if (batchIndex === totalBatches - 1) {
                            // 动态更新学校筛选列表
                            this.updateSchoolFilters();
                            
                            // 重置侧边栏选中状态
                            document.querySelectorAll('.sidebar-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            document.querySelector('[data-school=""]').classList.add('active');
                            
                            // 应用筛选并渲染表格
                            this.applyFilters();
                        }
                        
                        // 让出主线程，提高UI响应性
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }
                    
                    this.hideLoading();
                    this.showNotification(`成功导入 ${Utils.formatNumber(this.bookData.length)} 条数据，包含 ${[...new Set(this.bookData.map(item => item.学校))].length} 所学校`, 'success');
                } catch (error) {
                    if (!signal.aborted) {
                        this.hideLoading();
                        this.showNotification('导入失败: ' + error.message, 'error');
                    }
                }
            }
            
            // 应用表头映射到数据行
            mapDataRow(row, mapping) {
                const mappedRow = {};
                
                // 初始化所有标准字段
                APP_CONSTANTS.STANDARD_FIELDS.forEach(field => {
                    mappedRow[field.id] = '';
                });
                
                // 应用映射
                for (const [standardField, excelField] of Object.entries(mapping)) {
                    if (excelField && excelField !== 'none' && row.hasOwnProperty(excelField)) {
                        // 根据字段类型进行适当的格式化
                        if (standardField === '日期') {
                            mappedRow[standardField] = Utils.formatDate(row[excelField]);
                        } else if (['定价', '册数', '码洋'].includes(standardField)) {
                            // 处理数字字段，去除千位分隔符
                            const value = row[excelField];
                            if (value !== undefined && value !== null) {
                                const numericValue = Utils.parseNumber(value);
                                mappedRow[standardField] = numericValue;
                            } else {
                                mappedRow[standardField] = 0;
                            }
                        } else {
                            // 其他字段直接赋值
                            mappedRow[standardField] = row[excelField] || '';
                        }
                    }
                }
                
                // 确保数字字段是数字类型
                mappedRow.定价 = Number(mappedRow.定价) || 0;
                mappedRow.册数 = Number(mappedRow.册数) || 0;
                mappedRow.码洋 = Number(mappedRow.码洋) || 0;
                
                // 如果码洋为0，尝试通过定价和册数计算
                if (mappedRow.码洋 === 0 && mappedRow.定价 > 0 && mappedRow.册数 > 0) {
                    mappedRow.码洋 = mappedRow.定价 * mappedRow.册数;
                }
                
                return mappedRow;
            }
            
            // 取消导入
            cancelImport() {
                if (this.importAbortController) {
                    this.importAbortController.abort();
                }
            }
            
            // 显示表头映射模态框
            showHeaderMappingModal(excelHeaders, sampleData) {
                // 保存Excel表头和示例数据
                this.excelHeaders = excelHeaders;
                this.sampleData = sampleData;
                
                // 生成表头预览
                this.generateHeadersPreview(excelHeaders);
                
                // 自动匹配表头
                const autoMapping = Utils.autoMapHeaders(excelHeaders);
                
                // 生成映射界面
                this.generateMappingInterface(autoMapping);
                
                // 显示模态框
                this.headerMappingModal.classList.remove('hidden');
            }
            
            // 隐藏表头映射模态框
            hideHeaderMappingModal() {
                this.headerMappingModal.classList.add('hidden');
            }
            
            // 生成表头预览
            generateHeadersPreview(headers) {
                this.excelHeadersPreview.innerHTML = '';
                
                headers.forEach(header => {
                    const tag = document.createElement('span');
                    tag.className = 'header-tag';
                    tag.textContent = header;
                    this.excelHeadersPreview.appendChild(tag);
                });
            }
            
            // 生成表头映射界面
            generateMappingInterface(currentMapping) {
                this.mappingContainer.innerHTML = '';
                
                // 为每个标准字段创建映射控件
                APP_CONSTANTS.STANDARD_FIELDS.forEach(field => {
                    const mappingRow = document.createElement('div');
                    mappingRow.className = 'mapping-row';
                    
                    // 字段标签
                    const label = document.createElement('div');
                    label.className = 'mapping-label';
                    label.innerHTML = `${field.name}${field.required ? '<span class="required-mark">*</span>' : ''}`;
                    mappingRow.appendChild(label);
                    
                    // 下拉选择框
                    const select = document.createElement('select');
                    select.className = 'mapping-select';
                    select.id = `map_${field.id}`;
                    
                    // 添加"不导入"选项
                    const noneOption = document.createElement('option');
                    noneOption.value = 'none';
                    noneOption.textContent = '不导入';
                    select.appendChild(noneOption);
                    
                    // 添加分隔线
                    const separatorOption = document.createElement('option');
                    separatorOption.value = '';
                    separatorOption.disabled = true;
                    separatorOption.textContent = '--- Excel表头 ---';
                    select.appendChild(separatorOption);
                    
                    // 添加Excel表头选项
                    this.excelHeaders.forEach(header => {
                        const option = document.createElement('option');
                        option.value = header;
                        option.textContent = header;
                        
                        // 设置当前映射
                        if (currentMapping[field.id] === header) {
                            option.selected = true;
                        }
                        
                        select.appendChild(option);
                    });
                    
                    // 如果是必填字段，不允许选择"不导入"
                    if (field.required) {
                        select.querySelector('option[value="none"]').disabled = true;
                    }
                    
                    mappingRow.appendChild(select);
                    
                    // 添加预览信息
                    if (this.sampleData && this.sampleData.length > 0) {
                        const preview = document.createElement('div');
                        preview.className = 'mapping-preview';
                        
                        // 检查是否有映射
                        if (currentMapping[field.id] && this.sampleData[0].hasOwnProperty(currentMapping[field.id])) {
                            // 显示前3个非空数据作为预览
                            const previewValues = [];
                            for (let i = 0; i < Math.min(3, this.sampleData.length); i++) {
                                const value = this.sampleData[i][currentMapping[field.id]];
                                if (value !== undefined && value !== null && value !== '') {
                                    previewValues.push(value.toString().length > 20 ? 
                                        value.toString().substring(0, 20) + '...' : 
                                        value);
                                }
                            }
                            
                            if (previewValues.length > 0) {
                                preview.innerHTML = `示例数据: <span>${previewValues.join(' | ')}</span>`;
                            } else {
                                preview.innerHTML = '<span class="text-yellow-500">该列无数据</span>';
                            }
                        } else {
                            preview.innerHTML = '<span class="text-gray-400">请选择Excel表头</span>';
                        }
                        
                        mappingRow.appendChild(preview);
                    }
                    
                    this.mappingContainer.appendChild(mappingRow);
                });
                
                // 添加自动匹配按钮
                const autoMapButton = document.createElement('button');
                autoMapButton.className = 'mt-4 mb-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors flex items-center justify-center';
                autoMapButton.innerHTML = '<i class="fas fa-magic mr-2"></i>自动匹配表头';
                autoMapButton.addEventListener('click', () => this.autoMapHeaders());
                
                this.mappingContainer.appendChild(autoMapButton);
            }
            
            // 自动匹配表头
            autoMapHeaders() {
                const autoMapping = Utils.autoMapHeaders(this.excelHeaders);
                
                // 更新映射界面
                for (const [standardField, excelField] of Object.entries(autoMapping)) {
                    const selectElement = document.getElementById(`map_${standardField}`);
                    if (selectElement) {
                        selectElement.value = excelField;
                        
                        // 更新预览信息
                        const mappingRow = selectElement.closest('.mapping-row');
                        const previewElement = mappingRow.querySelector('.mapping-preview');
                        
                        if (previewElement && this.sampleData && this.sampleData.length > 0) {
                            if (excelField && this.sampleData[0].hasOwnProperty(excelField)) {
                                // 显示前3个非空数据作为预览
                                const previewValues = [];
                                for (let i = 0; i < Math.min(3, this.sampleData.length); i++) {
                                    const value = this.sampleData[i][excelField];
                                    if (value !== undefined && value !== null && value !== '') {
                                        previewValues.push(value.toString().length > 20 ? 
                                            value.toString().substring(0, 20) + '...' : 
                                            value);
                                    }
                                }
                                
                                if (previewValues.length > 0) {
                                    previewElement.innerHTML = `示例数据: <span>${previewValues.join(' | ')}</span>`;
                                } else {
                                    previewElement.innerHTML = '<span class="text-yellow-500">该列无数据</span>';
                                }
                            } else {
                                previewElement.innerHTML = '<span class="text-gray-400">请选择Excel表头</span>';
                            }
                        }
                    }
                }
                
                this.showNotification('已自动匹配相似的表头', 'success');
            }
            
            // 确认表头映射
            confirmHeaderMapping() {
                const mapping = {};
                let isValid = true;
                
                // 收集映射信息
                APP_CONSTANTS.STANDARD_FIELDS.forEach(field => {
                    const selectElement = document.getElementById(`map_${field.id}`);
                    if (selectElement) {
                        mapping[field.id] = selectElement.value;
                        
                        // 检查必填字段
                        if (field.required && (selectElement.value === '' || selectElement.value === 'none')) {
                            isValid = false;
                            selectElement.classList.add('border-red-500');
                            
                            // 显示错误提示
                            const mappingRow = selectElement.closest('.mapping-row');
                            let errorElement = mappingRow.querySelector('.mapping-error');
                            
                            if (!errorElement) {
                                errorElement = document.createElement('div');
                                errorElement.className = 'mapping-error text-red-500 text-xs mt-1';
                                mappingRow.appendChild(errorElement);
                            }
                            
                            errorElement.textContent = '此字段为必填项，请选择对应的Excel表头';
                        } else {
                            selectElement.classList.remove('border-red-500');
                            
                            // 移除错误提示
                            const mappingRow = selectElement.closest('.mapping-row');
                            const errorElement = mappingRow.querySelector('.mapping-error');
                            if (errorElement) {
                                mappingRow.removeChild(errorElement);
                            }
                        }
                    }
                });
                
                // 检查是否有重复映射
                const usedExcelFields = [];
                for (const [standardField, excelField] of Object.entries(mapping)) {
                    if (excelField && excelField !== 'none') {
                        if (usedExcelFields.includes(excelField)) {
                            isValid = false;
                            
                            // 找到使用了相同Excel表头的所有字段
                            for (const [otherField, otherExcelField] of Object.entries(mapping)) {
                                if (otherExcelField === excelField) {
                                    const selectElement = document.getElementById(`map_${otherField}`);
                                    if (selectElement) {
                                        selectElement.classList.add('border-red-500');
                                        
                                        // 显示错误提示
                                        const mappingRow = selectElement.closest('.mapping-row');
                                        let errorElement = mappingRow.querySelector('.mapping-error');
                                        
                                        if (!errorElement) {
                                            errorElement = document.createElement('div');
                                            errorElement.className = 'mapping-error text-red-500 text-xs mt-1';
                                            mappingRow.appendChild(errorElement);
                                        }
                                        
                                        errorElement.textContent = 'Excel表头不能重复映射';
                                    }
                                }
                            }
                        } else {
                            usedExcelFields.push(excelField);
                        }
                    }
                }
                
                if (!isValid) {
                    this.showNotification('请修正映射中的错误', 'error');
                    return;
                }
                
                // 隐藏模态框
                this.hideHeaderMappingModal();
                
                // 开始导入数据
                this.processMappedExcelData(mapping);
            }
            
            // 处理映射后的Excel数据
            processMappedExcelData(mapping) {
                // 检查是否有保存的Excel数据
                if (!window.excelData) {
                    this.showNotification('未找到Excel数据', 'error');
                    return;
                }
                
                // 保存表头映射信息
                this.headerMapping = { ...mapping };
                
                // 创建反向映射（Excel表头到标准字段）
                this.reverseHeaderMapping = {};
                for (const [standardField, excelField] of Object.entries(mapping)) {
                    if (excelField && excelField !== 'none') {
                        this.reverseHeaderMapping[excelField] = standardField;
                    }
                }
                
                // 导入数据
                this.importFromExcel(window.excelData, mapping);
            }
        }

        // 当DOM加载完成后初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化应用
            window.app = new BookManagementApp();
            
            // 初始化轮播图
            initCarousel();
            
            // 调整侧边栏和主内容区高度一致
            adjustSidebarHeight();
            
            // 窗口大小改变时重新调整高度
            window.addEventListener('resize', adjustSidebarHeight);
        });
        
        // 调整侧边栏和主内容区高度一致
        function adjustSidebarHeight() {
            const sidebarContainer = document.querySelector('.sidebar-container');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebarContainer && mainContent) {
                // 获取主内容区的高度
                const mainContentHeight = mainContent.offsetHeight;
                
                // 设置侧边栏高度与主内容区一致
                sidebarContainer.style.height = `${mainContentHeight}px`;
                
                // 调整学校筛选区域的最大高度
                const schoolFilterContainer = document.getElementById('schoolFilterContainer');
                if (schoolFilterContainer) {
                    // 计算学校筛选区域的最大高度（减去标题和统计信息的高度）
                    const headerHeight = document.querySelector('.sidebar-container h2').offsetHeight;
                    const statsHeight = document.querySelector('.sidebar-container .mt-4').offsetHeight;
                    const padding = 32; // 考虑内边距
                    
                    const maxFilterHeight = mainContentHeight - headerHeight - statsHeight - padding;
                    schoolFilterContainer.style.maxHeight = `${maxFilterHeight}px`;
                }
            }
        }
        
        // 轮播图功能
        let currentSlide = 0;
        let slideInterval;
        const slides = document.querySelectorAll('.carousel-slide');
        const indicators = document.querySelectorAll('.carousel-indicator');
        const totalSlides = slides.length;
        
        // 初始化轮播图
        function initCarousel() {
            // 显示第一张幻灯片
            showSlide(0);
            
            // 开始自动轮播
            startAutoSlide();
        }
        
        // 显示指定幻灯片
        function showSlide(index) {
            // 确保索引在有效范围内
            currentSlide = (index + totalSlides) % totalSlides;
            
            // 更新幻灯片显示
            slides.forEach((slide, i) => {
                slide.classList.toggle('active', i === currentSlide);
            });
            
            // 更新指示器状态
            indicators.forEach((indicator, i) => {
                indicator.classList.toggle('active', i === currentSlide);
            });
        }
        
        // 切换到上一张/下一张幻灯片
        function changeSlide(direction) {
            // 清除当前的自动轮播计时器
            clearInterval(slideInterval);
            
            // 显示目标幻灯片
            showSlide(currentSlide + direction);
            
            // 重新开始自动轮播
            startAutoSlide();
        }
        
        // 直接跳转到指定幻灯片
        function goToSlide(index) {
            // 清除当前的自动轮播计时器
            clearInterval(slideInterval);
            
            // 显示目标幻灯片
            showSlide(index);
            
            // 重新开始自动轮播
            startAutoSlide();
        }
        
        // 开始自动轮播
        function startAutoSlide() {
            // 每5秒切换一次幻灯片
            slideInterval = setInterval(() => {
                changeSlide(1);
            }, 5000);
        }

        // 处理文件上传
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 验证文件类型和大小
            if (!validateFile(file)) {
                return;
            }
            
            // 保存文件引用，用于后续处理
            window.currentImportFile = file;
            
            // 重置文件输入
            event.target.value = '';
            
            // 显示密码输入模态框
            showPasswordModal();
        }
        
        // 验证文件类型和大小
        function validateFile(file) {
            // 检查文件类型
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!APP_CONSTANTS.EXCEL_EXTENSIONS.includes(`.${fileExtension}`)) {
                window.app.showNotification('请上传.xls或.xlsx格式的Excel文件', 'error');
                return false;
            }
            
            // 检查文件大小
            if (file.size > APP_CONSTANTS.MAX_FILE_SIZE) {
                window.app.showNotification('文件大小不能超过50MB', 'error');
                return false;
            }
            
            return true;
        }
        
        // 处理文件导入
        function processFile(file) {
            // 如果正在导入，先取消之前的导入
            if (window.app.isImporting) {
                window.app.cancelImport();
            }
            
            // 显示加载状态
            window.app.showLoading('正在读取Excel文件...');
            
            // 直接在主线程处理Excel文件
            try {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        // 解析Excel文件
                        const data = new Uint8Array(e.target.result);
                        
                        // 修复：使用正确的配置解析.xls文件
                        const workbook = XLSX.read(data, { 
                            type: 'array',
                            cellDates: true,
                            cellNF: false,
                            cellText: false,
                            raw: false
                        });
                        
                        // 获取第一个工作表
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // 转换为JSON，保留原始表头
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                            header: 1 // 保留原始表头
                        });
                        
                        // 检查数据是否为空
                        if (jsonData.length <= 1) {
                            throw new Error('Excel文件中没有找到数据');
                        }
                        
                        // 提取表头和数据
                        const excelHeaders = [];
                        for (let j = 0; j < jsonData[0].length; j++) {
                            const header = jsonData[0][j];
                            if (header) {
                                excelHeaders.push(header.toString().trim());
                            } else {
                                // 如果表头为空，使用默认名称（列A, 列B, 列C等）
                                excelHeaders.push(`列${String.fromCharCode(65 + j)}`);
                            }
                        }
                        const excelData = jsonData.slice(1);
                        
                        // 转换为对象数组
                        const excelObjects = [];
                        for (let i = 0; i < excelData.length; i++) {
                            const row = excelData[i];
                            const rowObject = {};
                            
                            // 跳过空行
                            let isEmptyRow = true;
                            for (let j = 0; j < row.length; j++) {
                                const header = excelHeaders[j] || `列${String.fromCharCode(65 + j)}`;
                                rowObject[header] = row[j];
                                
                                if (row[j] !== undefined && row[j] !== null && row[j] !== '') {
                                    isEmptyRow = false;
                                }
                            }
                            
                            if (!isEmptyRow) {
                                excelObjects.push(rowObject);
                            }
                        }
                        
                        // 检查是否有有效数据
                        if (excelObjects.length === 0) {
                            throw new Error('Excel文件中没有找到有效数据');
                        }
                        
                        // 保存Excel数据
                        window.excelData = excelObjects;
                        
                        // 提取示例数据（前3行）
                        const sampleData = excelObjects.slice(0, 3);
                        
                        // 隐藏加载状态
                        window.app.hideLoading();
                        
                        // 显示表头映射模态框
                        window.app.showHeaderMappingModal(excelHeaders, sampleData);
                        
                    } catch (error) {
                        handleImportError('处理文件失败: ' + error.message);
                    }
                };
                
                reader.onerror = function() {
                    handleImportError('读取文件失败');
                };
                
                // 读取文件
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                handleImportError('初始化导入失败: ' + error.message);
            }
        }
        
        // 处理导入错误
        function handleImportError(errorMessage) {
            window.app.hideLoading();
            window.app.showNotification(errorMessage, 'error');
            window.app.isImporting = false;
        }
        
        // 显示密码输入模态框
        function showPasswordModal() {
            // 获取模态框元素
            const passwordModal = document.getElementById('passwordModal');
            const passwordInput = document.getElementById('passwordInput');
            const passwordError = document.getElementById('passwordError');
            const confirmPasswordBtn = document.getElementById('confirmPasswordBtn');
            const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
            
            // 重置输入和错误状态
            passwordInput.value = '';
            passwordError.classList.add('hidden');
            passwordInput.focus();
            
            // 显示模态框
            passwordModal.classList.remove('hidden');
            
            // 确认按钮点击事件
            const handleConfirm = function() {
                const password = passwordInput.value.trim();
                
                // 验证密码
                if (password === APP_CONSTANTS.IMPORT_PASSWORD) {
                    // 密码正确，隐藏模态框并处理文件
                    passwordModal.classList.add('hidden');
                    processFile(window.currentImportFile);
                    
                    // 移除事件监听器
                    confirmPasswordBtn.removeEventListener('click', handleConfirm);
                    cancelPasswordBtn.removeEventListener('click', handleCancel);
                } else {
                    // 密码错误，显示错误信息
                    passwordError.classList.remove('hidden');
                    passwordInput.select();
                }
            };
            
            // 取消按钮点击事件
            const handleCancel = function() {
                // 隐藏模态框，取消导入
                passwordModal.classList.add('hidden');
                
                // 移除事件监听器
                confirmPasswordBtn.removeEventListener('click', handleConfirm);
                cancelPasswordBtn.removeEventListener('click', handleCancel);
            };
            
            // 添加事件监听器
            confirmPasswordBtn.addEventListener('click', handleConfirm);
            cancelPasswordBtn.addEventListener('click', handleCancel);
            
            // 回车键事件
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleConfirm();
                }
            });
        }
    </script>
</body>

</html>
